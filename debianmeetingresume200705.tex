%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Tokyo Debian Meeting resources
%     Copyright (C) 2007 Junichi Uekawa

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "xpdf " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage[dvipdfm]{graphicx}
\usepackage{fancybox}
\usepackage{longtable}
\usepackage{ascmac}	% 囲み (screen,itembox)
\usepackage{fancyvrb}   % 囲み Verbatim のために必要
\usepackage[dvipdfm]{hyperref}
\usepackage{url}
\usepackage[dvipdfm]{color}
\usepackage{nextpage}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2007}
\newcommand{\debmtgdate}{19}
\newcommand{\debmtgmonth}{5}
\newcommand{\debmtgnumber}{28}

%http://www.naney.org/diki/dk/hyperref.html
%日本語EUC系環境の時
\AtBeginDvi{\special{pdf:tounicode EUC-UCS2}}
%シフトJIS系環境の時
%\AtBeginDvi{\special{pdf:tounicode 90ms-RKSJ-UCS2}}

%% spacing の設定をする。外枠を減らす。
\setlength\headheight{0mm}
\setlength\topmargin{-20mm}
\setlength\headsep{0mm}
\setlength\topskip{3mm}
\setlength\maxdepth{4pt}
\setlength\columnsep{6mm}
\setlength\textheight{252mm}
\setlength\topmargin{-5mm}
\setlength\textwidth{170mm}
\setlength\oddsidemargin{-5mm}
\setlength\evensidemargin{-5mm}

% commandline環境を定義。画面入出力についてはcommandline環境
% で表記する
\newenvironment{commandline}%
{\VerbatimEnvironment
  \begin{Sbox}\begin{minipage}{15cm}\begin{fontsize}{7.3}{7.3} \begin{BVerbatim}}%
{\end{BVerbatim}\end{fontsize}\end{minipage}\end{Sbox}
  \setlength{\fboxsep}{8pt}\begin{itembox}[c]{出力}{\TheSbox}\end{itembox}}

%%% start of santaku
\makeatletter
\newwrite\tf@jqz
\immediate\openout\tf@jqz\jobname.jqz\relax
\makeatother
\newcounter{santakucounter}
\newcommand{\santaku}[5]{%
\addtocounter{santakucounter}{1}

\addtocontents{jqz}{\arabic{santakucounter}. #5\\}
\begin{minipage}{1\hsize}
問題\arabic{santakucounter}. 
#1\\
□ A #2\\
□ B #3\\
□ C #4
\end{minipage}
\hspace{1cm}
\\

}
%%% end of santaku

\newcommand{\emptyspace}{(\underline{\hspace{1cm}})}

\newcommand{\subsubsubsection}[1]{%
\vspace{1zw}{\bf #1}\\}


% sectionをセンタリングする
\makeatletter
  \renewcommand{\section}{\@startsection{section}{1}{\z@}%
    {\Cvs \@plus.5\Cdp \@minus.2\Cdp}% 前アキ
    {.5\Cvs \@plus.3\Cdp}% 後アキ
    {\normalfont\gt\fontsize{32}{32}\headfont\raggedright}} % style
\makeatother

% section の代わりの環境
\newcommand{\dancersection}[2]{%
\newpage
第\debmtgnumber{}回 東京エリアDebian勉強会 \debmtgyear{}年\debmtgmonth{}月
\hrule
\vspace{0.5mm}
\hrule
%
\vspace{4cm}
\hrule
\vspace{0.5mm}
\hrule
%
\vspace{-7cm}
\begin{minipage}[b]{0.7\hsize}
\section{#1}
\hfill{}#2\\
\vspace{2cm}
\end{minipage}
\begin{minipage}[b]{0.3\hsize}
\hfill{}\includegraphics[height=8cm]{image200502/openlogo-nd.eps}\\
\end{minipage}
%
%\hfill{}\includegraphics[width=16cm]{image2006-natsu/guruguru-sand-light.png}\\
\vspace{-1cm}
}

% BTSの番号を見るためのコマンド
\newcommand{\debianbug}[1]{Bug\##1\footnote{\url{http://bugs.debian.org/#1}}}

% for dancerj
\newcommand{\fgref}[1]{図\ref{#1}}
\newcommand{\tbref}[1]{表\ref{#1}}




\begin{document}

\begin{titlepage}

% 毎月変更する部分, 本文の末尾も修正することをわすれずに


 第\debmtgnumber{}回 東京エリア Debian 勉強会資料

\vspace{2cm}

\begin{minipage}[t]{0.6\hsize}
\vspace{-2cm}
{\fontsize{60}{60}
{\gt
東京エリア \\
デビアン \\
勉強会
}}
\end{minipage}
\begin{minipage}[b]{0.4\hsize}
\hspace{-1cm}\includegraphics[width=9cm]{image200502/openlogo-nd.eps}
\end{minipage}

\vspace{3cm}
\hfill{}Debian勉強会幹事 上川純一\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

\thispagestyle{empty}
\end{titlepage}

\dancersection{Introduction}{上川純一}
 
 今月のDebian勉強会へようこそ。
 これからDebianのあやしい世界に入るという方も、すでにどっぷりとつかってい
 るという方も、月に一回Debianについて語りませんか？

 目的として次の二つを考えています。

 \begin{itemize}
 \item メールではよみとれない、もしくはよみとってられないような情報につ
       いて情報共有する場をつくる
 \item Debianを利用する際の情報をまとめて、ある程度の塊として整理するた
       めの場をつくる
 \end{itemize}

 Debianの勉強会ということで究極的には参加者全員がDebian Packageをがりがり
 と作るスーパーハッカーになった姿を妄想しています。

 Debianをこれからどうするという能動的な展開への土台としての空間を提供し、
 情報の共有をしたい、というのが目的です。


\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\tableofcontents
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{事前課題}{上川純一}

今回の事前課題は
「XXXX」
というタイトルで200-800文字程度の文章を書いてください。というものでした。
その課題に対して下記の内容を提出いただきました。

\subsection{}

\subsection{上川}

%%% trivia quiz
\dancersection{Debian Weekly News trivia quiz}{上川純一}

ところで、Debian Weekly News (DWN)は読んでいますか？
Debian 界隈でおきていることについて書いているDebian Weekly News.
毎回読んでいるといろいろと分かって来ますが、一人で読んでいても、解説が少
ないので、
意味がわからないところもあるかも知れません。みんなでDWNを読んでみましょう。

漫然と読むだけではおもしろくないので、DWNの記事から出題した以下の質問にこたえてみてください。
後で内容は解説します。

\subsection{2007年XX号}
\url{http://www.debian.org/News/weekly/2007/XX/}
にあるX月X日版です。

\santaku
{}
{}
{}
{}
{}

\dancersection{最近のDebian関連のミーティング報告}{上川純一}

\subsection{東京エリアDebian勉強会27回目報告}
% (query-replace-regexp "<.*?>" "")
% (query-replace-regexp "^[ 	]*" "")


東京エリアDebian勉強会参加報告。
4月の第27回東京エリアDebian勉強会を実施しました。

今回の参加者は
やまねさん、青木さん、小室さん、溝口さん、あけどさん、
小林さん、David Smithさん、
脇さん、でんさん、鈴木邦男さん、
北原さん、noriaki sato さん、
橋本さん、本庄さん、中原健吾さん、森田尚さん、
Charles Plessy さん、えとーさん、上川の19人でした。


最近のイベントの紹介として、最初に前回の報告を行いました。
仮想化友の会との共催です。また、最近のイベントとして etch 
のリリースがあり、etchのリリース宴会の開催の報告を行いまし
た。


次に事前課題の紹介を行いました。
各種SCMをすでに活用している人が多いのがわかりました。
subversion や cvs や VSS が主流で、
分散SCMはあまり利用されていないようでした。
そもそも分散バージョン管理のツールを企業内の協同作業者に浸透させるのに悩んでいる
ひとや、部署がVSSしかつかわせてくれないとか、VSSすらつかわせてくれないので tar で管理している
などの悩みがでてきました。
また、タスクトラッキングとして、trac の話題が出てきました。
バージョンの管理するだけでなくそういうシステムを活用して総合的に運用
することの悩みなどをみなさま感じているようです。


DWNクイズを今回も実施しました。
全員に起立してもらい、グー・チョキ・パーで選択してもらいました。
１問目から多くの方が間違ってしまい、熾烈なたたかいになりました。
5問全問正解したのは、David Smith さんただ一人でした。
おめでとうございます。
あけどさんから mozilla.party グッズが贈呈されました。
あけどさん、ありがとうございます。


「時間がなくて準備が全くできていないのですが」、とのセリフとともに
小林さんがquilt の紹介をはじめました。
1月に実施する予定だったものが諸事情で4月まで延期になっていたものです。

内容は、コマンドラインで quilt の各種命令を実際に入力して
デモをするというものでした。説明しきれなかった部分はホワイ
トボードに図を書いて説明しました。

dpatch との差分として、quilt には「現在のパッチ」(top)という概念が
あります。quilt push / pop で編集するパッチを選べます。ま
た、dpatch は debian/patches/00listを利用者が編集
することが前提ですが、新規のパッチを追加するquilt new は
debian/patches/series ファイルを変更してくれると
いうこともわかりました。dpatch と違い、編集対象のファイル
は quilt add で明示的に宣言してから編集する必要がある、も
しくはquilt edit コマンドでエディターを起動して編集する必
要があることもわかりました。dpatch-edit-patch ではシェルが
起動してそれを終了したらパッチに反映されるのですが、quilt 
では、quilt refreshでパッチに反映するそうです。また quilt
header でパッチのヘッダ情報を編集する、というような詳細な
デモが約1時間みっちり続きました。

個人的には、パッチのコンフリクトが起きる場合のワークフロー
が気になっていたのですが、quilt push -a でフェー
ルしたパッチをquilt push -f で強制的にプッシュし、
rejects を確認して、編集し、quilt refresh するこ
とでパッチに反映されるということをデモして説明してくれまし
た。

プレゼンテーションの手法について、会場から2つコメントをい
ただきました。全体の流れがわからないので、アジェンダみたい
なのがあるとよかったですね。またこのツールが何をするものか、
そもそもどういう課題があって、それをどう解決してくれるもの
なのか、ということを説明するとわかりやすかったかもしれない
ですね、というものです。今後もツールの紹介をする際にそれを
念頭においているとよいかもしれません。


「darcs がパッチをマージしようとする際に無限ループ状態にお
ちいってしまって資料が完成しませんでした」、という言い訳を
最初にしてから、デモをしたのは最近 darcs に我慢ならなくな
り Mercurial に移行してしまった David Smith さんです。
darcs の紹介です。emacs でバッファを二つ開いて、上半分にア
ジェンダの書いてあるテキストファイルを表示し、下半分を 
shell-mode で動かしていました。なかなかストイックな感じで
すが、ありかもしれません。

プレゼンテーション手法もさることながら、発表の題材である 
darcs がストイックな思想をもったツールだということがひしひ
しと伝わってきました。どうも目を疑ったのですが、説明どおり
にパッチ管理システムで、リビジョン管理システムではないよう
なのです。darcs も init や add コマンドがあり、whatsnew コ
マンドで確認する、などというフローになりますが、コミットの
管理のしかたの発想がcvs / svn / git などの他のツールよりも
むしろ quilt / dpatch などのツールのほうに近いことがわかり
ました。

darcs record でパッチを記録することができるのですが、darcs
unrecord で任意のパッチをはずすことができます。依存されて
いないパッチをはずすことができるのです。つまり、darcs で管
理されている最新版は、最新版のツリーとしてではなく、darcs 
の管理している独立したパッチを全部適用した状態、として存在
しているのです。

おかげさまでマージ処理のためのパッチ代数を処理するために
CPU時間が使われ過ぎるという弊害があるそうです。

darcs はパッチの送信や受信のためのプロトコルやコマンドが組み込まれた
quilt のような印象を受けました。


最後のネタとして上川が git-buildpackage の紹介を行いました。
git の簡単な使い方紹介と、git-buildpackage の考え方の紹介するにとどめ、
具体的な操作方法についてはあまり説明していません。

git について出た質問として、どれくらいのディスク容量を使っているのか、という
ものがありました。
仕組みとしては、ファイルをそのまま圧縮して保存しつづける仕組みなのですが、
pack 方式というものがあり、効率よく保存するようになっています(git-repack / git-gc コマンドなどで実施)。
既存の事例を調査すると、Debian勉強会やLinux Kernelなどのツリーでは、
ワーキングツリーとレポジトリが同じくらいの大きさであることがわかりました。
両方とも2年くらい運用しているツリーなので、そこまで大きくないですね、という
結論になりました。


今回は宴会は「遊喜酒場 〜想作串〜」
にて開催しました。
おいしかったです。
ただ、18人で二階を満員占拠したのですが、
料理の単品の量がすくなかったのと出てくるペースが遅かったのは問題でした。
この店にこの人数で入るのは無理があったかもしれません。

trac の話題で盛り上がりました。
trac-ja-resource がうまく動かないということと、etch の 
tracにアップグレードする際には、 sqlite から sqlite3 にデー
タベースを移行する必要があったりいろいろと手動操作が必要な
のだそうです。今回は SCM の話題だったので、 trac ユーザが
多くいたようですね。


次回のネタとして、エッチにアップグレードして苦労した話を交
換できればよいですね、というところで今月は終了です。


\dancersection{Debian etch へのアップグレード検証会議}{上川純一}
\label{sec:upgradeetch}

みなさんはもう、アップグレードはお済みですか?いろいろと活用していると気
になるアップグレード状況。
みんなのアップグレード結果を聞いてみましょう。

\dancersection{サーバをエッチにしてみました}{小室 文}

\subsection{intro}
エッチがリリースされてから早一ヵ月たちました。debian-users mlでは助けを求める亡者の投稿でMLはかつて無い程の盛り上がりを見せていました(います？現在進行形？)。
woodyからsargeへのアップグレード時の盛り上がりを知らないのであれですが、初めてのリリースにちょっとした祭を感じました。
と言う訳でちょうどGWだったので、サーバ２台をsargeからエッチにアップグレードしてみました。

\subsection{やること〜リリースノートを読んでみる〜}
GW前後に日本語のリリースノートが出たので、読んでみました。\\
Debian GNU/Linux 4.0 -- リリースノート\\
\url{http://www.debian.org/releases/stable/releasenotes}

\subsubsection{リリースノートのポイント}
\begin{enumerate}
\item データや設定情報のバックアップを取り、パッケージ状態のチェック (hold状態の物は解決をしておく)
\item sargeで最新状態にする

\item エッチでupdate とupgrade
\item いろいろパッケージをいれる

\item dist-upgrade
\item 最終チェック・再起動・動作確認
\end{enumerate}
\subsubsection {エッチの事(個人的に)}
\begin{itemize}
\item 全体のパッケージ数 18200〜 / エッチでの新しいパッケージ 6500〜 / sargeから約65％のパッケージが更新された
\item default encoding がUTF-8に
\item installerが結構変わったらしい
\item debian-volatile公式リリース
\item Exim4.5からExim4.63に/ Apache2からApache2.2に / PHP5 / Bind9からBind9.3に
\end{itemize}
\subsection{やってみた}
\begin{enumerate}
\item バックアップを取る\\
/etc/以下、/var/lib/dpgkの中身、dpgk --get-selection '*'の出力、/var/backupsなど。後あまり影響はないが/home/以下の隠れファイルとかもXなど使用している場合はバックアップ対象としていたほうがよい
\item パッケージ状態のチェック ＆ セッションの記録
\item (sargeでの)パッケージの更新 \\
/etc/apt/source.listはsargeのままで aptitude update\\
更新候補:libapache-mod-php4 libapache2-mod-php4 libc6 libkrb53 libmagic1 locales man-db php4 php4-comm
\item (エッチでの)パッケージ情報の更新
/etc/apt/source.listをエッチ(stable)にして\\
aptitude update\\
aptitude upgrade\\
削除されたパッケージ：libruby1.6 ruby1.6
\item パッケージの確認・インストール

\begin{enumerate}
\item aptitude install initrd-tools (すでに入っている場合もある)\\
新規に入ったパッケージ：libdevmapper1.02 libselinux1 libsepol1 tzdata\\
削除されたパッケージ：base-config
\item デスクトップ環境があれば\\
aptitude install libfam0 xlibmesa-glu x11-common(入っていたら)\\
新規に入るパッケージ：libfontenc1 libfs6 libx11-data libxau6 libxdmcp6 libxfont1 xbitmaps xcursor-themes xfonts-encodings xfonts-utils xutils-dev\\
削除されたパッケージ：xfree86-common
\item カーネルのアップグレード\\
aptitude install linux-image-2.6-◎◎(すでに2.6系であれば今すぐに更新をする必要は無い)
\end{enumerate}
\item aptitude dist-upgrade\\
アップグレード中に(主にExim4とApache2設定ファイル)各種変更部分の選択を迫られる\\
使われてないから削除されたパッケージ： libfam0c102 libreadline4 ntp ntp-simple\\
新規インストールされたパッケージ：apache2.2-common courier-authlib courier-authlib-userdb cpp-4.1 debian-archive-keyring dmidecode gnupg gpgv laptop-detect libapr1 libaprutil1 libbind9-0 libdb4.3 libdb4.4 libdns22 libedit2 libfribidi0 libgnutls13 libisc11 libisccfg1 libltdl3 liblwres9 libncursesw5 libnewt0.52 libpcap0.8 libpci2 libpq4 libreadline5 libsigc++-2.0-0c2a libslang2 libsp1c2 libsqlite3-0 libssl0.9.8 libtasn1-3 mktemp modconf openbsd-inetd openssh-client openssh-server readline-common sysvinit-utils tasksel-data update-inetd\\
削除されたパッケージ：libnewt0.51 libsp1 netkit-inetd ntp-server apache2-common {\bf exim4-daemon-heavy}\\

\item 確認・再起動
\begin{itemize}
\item /proc/mounts に 'devfs'があればdevfs スタイルのデバイス名の変更をする。
\item liloをブートローダーとして使用している場合、もう一度実行させておく
\item {/}etc/kernel-img.conf の内容を調べ、do\underline  bootloader = Yes と書かれていることを確認
\item grubの場合、/etc/kernel-img.conf を編集、update-grub=/sbin/update-grub を/usr/sbin/update-grub に変更する

\end{itemize}
\end{enumerate}

\subsection{怒られた！}
以下のパッケージの処理中にエラーが発生しました: \\
exim4-config postgresql-7.4 postgresql-contrib-7.4 tcsh-kanji postgresql exim4-base postgresql-contrib exim4-daemon-heavy mailagent at exim4 qpopper amavisd-new mutt spamassassin 

怒られた原因と解決方法
\begin{itemize}
\item debconf: unable to initialize frontend: Gnome\\
dpkg-reconfigure debconf にして設定を Dialog に変更。なんで gnome を選んだ自分でも不明
\item tcsh conflicts with tcsh-kanji \\
 tcsh-kanji: Depends: tcsh ($\geq $ 6.14.00-6) but it is not installable\\
一番分からずはまった。tcsh-kanji depends on tcshだと思い込んでのとちゃんとエラーを読んでいなかったのが原因。\\
aptitude show tcsh\\
パッケージ: tcsh \\
バージョン: 6.14.00-7 \\
依存: libc6 ($\geq $ 2.3.6-6), libncurses5 ($\geq $ 5.4-5) \\
{\bf 競合: tcsh-kanji (＜ 6.14.00-6)}\\
置換: tcsh-kanji ( ＜ 6.14.00-6) \\
提供: c-shell, tcsh-kanji\\
上記を見る限りtcshとtcsh-kanjiがconflictsしているようなので、tcsh-kanjiをremove/purgeする

\item /etc/exim4/update-exim4.conf.conf: line 32: acl＿check＿helo:: command not found \\
昔追加した文を削除してupdate-config.confをして/etc/init.d/exim4 reloadをする(今は使ってないはず)
\item Errors were encountered while processing: exim4-config\\
dpkg -l exim4-configでは Failed-configになっているのでdpkg --configure exim4-configをする

\item exim4-daemon-heavyが exim4-daemon-lightにreplace\\
exim4-daemon-heavyが入っているサーバをアップグレードしたらheavyからlightに置き換わった。なぜ。

以下の新しいパッケージがインストールされます:\\
  apache2.2-common courier-authlib courier-authlib-userdb cpp-4.1
  debian-archive-keyring dmidecode {\bf exim4-daemon-light} gnupg gpgv
  laptop-detect libapr1 libaprutil1 libbind9-0 libdb4.3 libdb4.4 libdns22
  libedit2 libfribidi0 libgnutls13 libisc11 libisccfg1 libltdl3 liblwres9
  libncursesw5 libnewt0.52 libpcap0.8 libpci2 libpq4 libreadline5
  libsigc++-2.0-0c2a libslang2 libsp1c2 libsqlite3-0 libssl0.9.8 libtasn1-3
  mktemp modconf openbsd-inetd openssh-client openssh-server
  readline-common sysvinit-utils tasksel-data update-inetd\\
以下のパッケージが削除されます:\\
  apache2-common {\bf exim4-daemon-heavy} libnewt0.51 libsp1 netkit-inetd
  ntp-server
\end{itemize}
\subsection{ついで：エッチをstableにした}

もともとtestingの時からetchにしていたPCの/etc/apt/source.listをtestingから stableに直してaptitude updateしたらこんなエラーが。

\begin{commandline}
パッケージリストを読み込んでいます... 完了
W: GPG error: http://security.debian.org stable/updates Release:
公開鍵を利用できないため、以下 の署名は検証できませんでした: 
NO PUBKEY A70DAF536070D3A1
W: GPG error: http://cdn.debian.or.jp stable Release: 
公開鍵を利用できないため、以下の署名は検 証できませんでした:
NO PUBKEY A70DAF536070D3A1 NO PUBKEY B5D0C804ADB11277
W: これらの問題を解決するためには apt-get update を実行する必要があるかもしれません
\end{commandline}


なので

\begin{commandline}
gpg  --keyserver wwwkeys.eu.pgp.net --recv-keys A70DAF536070D3A1
gpg --keyserver wwwkeys.eu.pgp.net --recv-keys B5D0C804ADB11277
gpg --armor --export A70DAF536070D3A1 | apt-key add -
gpg --armor --export B5D0C804ADB11277 | apt-key add -
\end{commandline}

とするとエラーが出なくなった。/etc/apt/source.listで指定している名前が違う＝パッケージも違う？のだろうか。

\subsection{まとめ}
エッチにアップグレードはそんなに難しくない、という事で。
リリースノートとaptitude show パッケージ名があれば大方のトラブルには対応出来るかと思います。

\dancersection{Debconf7 発表計画}{岩松さん+上川}


\dancersection{最近 pbuilder ってどうよ?}{上川}

この文書は pbuilder とは何か、そして、最近は何がおきたのか、そしてこれか
ら近い将来になにがおきることが予測されるのかということを紹介する記事です。

Debconf7で紹介する予定の内容です。

\subsection{pbuilder の利用コンセプト}

pbuilder は chroot 内部で利用するベースファイルシステムイメージを管理し、
ビルドのたびに新しいベースファイルシステムイメージを展開することを通して、
Debianパッケージの試験にクリーンルーム環境を活用するのを簡便にします。

操作のために利用できるコマンドがいくつかあります。\texttt{pbuilder
create}、 \texttt{pbuilder update}、 \texttt{pbuilder
build}\footnote{pdebuild命令のほうが便利な場合があります}命令がよく利用
される例です。詳細な情報が必要であれば、 pbuilder のマニュアルを参照して
ください。\url{/usr/share/doc/pbuilder/pbuilder-doc.html}にあります。

設定が適切に行われ初期化が終了していれば、\texttt{pbuilder build} コマン
ドは\texttt{.dsc} ファイル(Debianのソースパッケージ)をあたえられると 
chroot 内部でパッケージをビルドします。

\begin{tabular}{|l|l|l|}
\hline
操作 & 操作頻度 & 意味 \\
\hline
create & base.tgz を作成するのに一度 & ベースファイルシステムの作成 \\
update & 一日一回 (unstable のアップデートに伴う) & ベースファイルシステ
 ムの更新 \\
build & パッケージビルドのたび & Debianパッケージを chroot 内部でビルド
 する \\
\hline
\end{tabular}

Debian Developer の通常の一日に発生するイベントを検討してみましょう。

\begin{center}
 \includegraphics[width=0.6\hsize]{image200705/develcycle.eps}
\end{center}

pbuilder はパッケージのビルドのプロセスの一部の確認プロセスとして組み込
まれています。\footnote{これはひとつの例です。例えば、一部の開発者はロー
カルでビルドするということをせず、chroot 内部で全部の作業を完結している
場合もあり、その場合はローカルのテストのステップが省略されます。利点とし
てはローカルに sid の環境をもたなくてすむことがあげられますが、その点に
ついては sid を自分自身でも利用しないことになるため、賛否両論です。} こ
れは、Build-Dependsを正しく設定できているのか試験するのに便利です。また
簡単な回帰テストのフレームワークとして活用できます。

\subsection{pbuilder 自身の開発の仕組み}

pbuilder 自身がどう開発されているのか解説します。現在、 alioth で提供さ
れているリソースを活用して co-maintain(共同メンテナンス) されています。
最近の主要な開発メンバーは Lo\"ic Minier と上川です。
たまに Matt Kraai と Mattia Dongiliがコミットします。

プロジェクトページは\url{http://alioth.debian.org/projects/pbuilder}にあ
り、ホームページは\url{http://pbuilder.alioth.debian.org/} にあります。
ホームページはpbuilderマニュアルになっています。

ソースコードの管理にはgitを利用しています。レポジトリは下記のコマンドの
いずれかを利用してチェックアウトできます。\footnote{sshアクセスには 
alioth のアカウントが必要です}

\begin{verbatim}
git-clone git://git.debian.org/git/pbuilder/pbuilder.git
git-clone http://git.debian.org/git/pbuilder/pbuilder.git
git-clone ssh://git.debian.org/git/pbuilder/pbuilder.git
\end{verbatim}

\subsection{派生物とその状況}

pbuilder にはいくつかの派生物があり、異なるバックエンドをサポートしてい
ます。それらは別の方法をクリーンルーム試験環境を提供するのに利用していま
す。それらを簡単に紹介します。

\subsubsection{LVM スナップショット版}

だれかがLVMスナップショットをbase.tgz の管理用に利用する仕組みを提案しま
した。どっかにメールで投稿されています。ただ、誰も採用して開発を継続しよ
うとはしていないようです。環境の分離方法は chroot を利用しています。LVM
スナップショットの利点としては、 tar アーカイブの展開より格段に高速だと
いう点があげられます。

\subsubsection{user-mode-linux 版}

pbuilder-uml が存在します。どうやらほとんどの人が利用できているようです。
Mattia Dongili たちがこの移植版の開発に携わっています。

base.tgz の展開のかわりに UML cow デバイスでクリーンルーム環境の維持が実
現されています。また、 chroot のかわりに user-mode-linux を活用しており、
結果として各種システムコールが遅くなり全体としては実行オーバヘッドがあり
ます。

\subsubsection{cowdancer 版}

上川は　cowdancer 版の作業を 2005 年くらいから行っています。安定している
ようです。base.tgz の展開が\texttt{cp -la } におきかわっており、高速です。

ただし、 cowdancer が libc のコールをフックして実現しているため、一部の
パッケージのビルドに影響が出る可能性があります。\footnote{Etchのリリース
の際には、残念ながら Bug 413912 のような問題が発生しました。}

\subsubsection{qemu 版}

上川は qemu/kqemu/kvm 版の開発を2007年初頭から始めました。QEMUの COW ブ
ロックデバイス機能を活用しているため、base.tgzの展開が不要になります。

qemu版は別アーキテクチャ向けのビルド(クロスビルド)機能を提供するという特
徴があります。たとえば i386 マシン上でARM用のパッケージをビルドすること
だってできるはずです。

\subsection{さらなる開発のアイデア}

\subsubsection{インストールテスト}

インストールテストについては、いくつかの piuparts のようなプロジェクトが
あり、pbuilder でも応用できそうです。コンセプトを実装する簡単な例として
のスクリプトは pbuilder で提供しています。
\url{/usr/share/doc/pbuilder/examples/execute_installtest.sh} です。

\begin{verbatim}
pbuilder execute \
  /usr/share/doc/pbuilder/examples/execute_installtest.sh \
  pbuilder
\end{verbatim}

このコマンドは 指定したパッケージを chroot 内部で　apt-get でインストー
ルしようとし、成功するかしないかを確認してくれます。

\subsubsection{パッケージのテスト}

パッケージのテストの機能は重要です。とくに、開発者の時間は限られており、
手動でテストを繰り返すというのは楽しいことではないからです。pbuilder は
例としてフックスクリプトを提供しています。
\url{/usr/share/doc/pbuilder/examples/B92test-pkg} はパッケージのビルド
が成功した場合に、テストを実行するようになっています。

テストファイルは\verb!debian/pbuilder-test/NN_name! (NN は数字です)にお
きます。ファイル名は run-parts の標準に従います。\footnote{ファイル名に 
'.' が入っていたら無視されますよ!}.

\subsubsection{aptitude}

pbuilder は現在 apt-get コマンドを活用しています。しかしながら、 
aptitude の普及に伴い、aptitude を活用する方法を考える時期にきているかも
しれません。

\subsubsection{apt-key support}

pbuilder はあいかわらず apt-key をサポートしていません。現在の stable リ
リースで apt-key が提供されているため、そろそろ apt-key をサポートしよう
かな。

\subsubsection{build-dependency parser}

Build-Depends を解析するパーサは古く、最適ではありません。それをうけて、
Lo\"ic Minier はいくつかの再実装を試行しています。

\subsubsection{buildd.net のような仕組みのサポート}

pbuilder はたくさんのログを提供するのですが、pbuilder 自体は歴史の概念を
もちあわせていません。pbuilder 単体ではログを集めて活用するというように
はなっていません。\footnote{\texttt{pbuildd}を作成するというプロジェクト
は存在しました。最近どうなってるのかについては把握していません。} 過去の
ビルドログをローカルに集めて、各ビルド間での差分を確認することを通して、
問題を検出できるかもしれません。debdiff などのツールと組み合わせて利用す
るとよいかもしれませんね。


\subsection{References}

\begin{itemize}
 \item \url{http://pbuilder.alioth.debian.org/} か
 \url{/usr/share/doc/pbuilder/pbuilder-doc.html}: pbuilderマニュアル
 \item cowdancer パッケージ
 \item piuparts パッケージ
 \item autodebtest: Ubuntu の自動テストシステム
 \item schroot / dchroot 
 \item buildd
\end{itemize}

\dancersection{次回}{}

未定です。内容は本日決定予定です。

参加者募集はまた後程。

\cleartooddpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\ \\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule
\end{minipage}

\end{document}
