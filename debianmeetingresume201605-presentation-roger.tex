%; whizzy paragraph -pdf xpdf -latex ./whizzypdfptex.sh
%; whizzy-paragraph "^\\\\begin{frame}\\|\\\\emtext"
% latex beamer presentation.
% platex, latex-beamer でコンパイルすることを想定。 

%     Tokyo Debian Meeting resources
%     Copyright (C) 2012 Junichi Uekawa

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warreanty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

\documentclass[cjk,dvipdfmx,12pt]{beamer}
\usetheme{Tokyo}
\usepackage{monthlypresentation}

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&")) 
%  presentation (shell-command (concat "xpdf -fullscreen " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
%  presentation (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))

%http://www.naney.org/diki/dk/hyperref.html
%日本語EUC系環境の時
\AtBeginDvi{\special{pdf:tounicode EUC-UCS2}}
%シフトJIS系環境の時
%\AtBeginDvi{\special{pdf:tounicode 90ms-RKSJ-UCS2}}

\newenvironment{commandlinesmall}%
{\VerbatimEnvironment
  \begin{Sbox}\begin{minipage}{1.0\hsize}\begin{fontsize}{8}{8} \begin{BVerbatim}}%
{\end{BVerbatim}\end{fontsize}\end{minipage}\end{Sbox}
  \setlength{\fboxsep}{8pt}
% start on a new paragraph

\vspace{6pt}% skip before
\fcolorbox{dancerdarkblue}{dancerlightblue}{\TheSbox}

\vspace{6pt}% skip after
}
%end of commandlinesmall


\title{東京エリアDebian勉強会\\　\\Buffalo Linkstation向け\\Debian Installer}
\subtitle{第139回 2016年5月度}
\author{Roger Shimizu\\rogershimizu@gmail.com}
\date{2016年5月21日}
\logo{\includegraphics[width=8cm]{image200607/openlogo-light.eps}}

\begin{document}

\frame{\titlepage{}}

\section{Agenda}
\begin{frame}{Agenda}
\begin{enumerate}
\item 自己紹介
\item 背景
\item Linkstation へ Debian のインストール仕方
\item TODO
\item Demo
\end{enumerate}
\end{frame}

\section{自己紹介}
\emtext{自己紹介}

\begin{frame}{自己紹介}
\begin{itemize}
\item 10年以上(静かな) Debian user
\item 2年前にLinkstation LS-WXL の Device-tree 対応を初め、Kernel DTS や Debian 様々への貢献を行う
\item wide-dhcpv6, adjtimex パッケージをメインテインしており
\item Debian Kernel Team と Debian Installer Team を参加しており、組み込み系 Device がより簡単に使えるように頑張ります
\end{itemize}
\end{frame}


\section{背景}
\emtext{背景}

\begin{frame}{Buffalo Linkstation NAS 歴史}
\begin{itemize}
\item 第０世代: Linkstation / Kuro-Box
\item 第１世代: Linkstation HG / Kuro-Box HG
	\begin{itemize}
	\item PowerPC architecture
	\item IDE/PATA のみ (SATA がなし)
	\item 現在あっても使いづらいと思います
	\end{itemize}
\item 第２世代: Kuro-Box Pro / Linkstation Live\\
/ Linkstation LS-GL/LS-WTGL/LS-WSGL/LS-QL
\footnote{MIPSの方が少ないて、出てすぐデスコンになってしまったので、省略させて頂きます。}
	\begin{itemize}
	\item ARM architecture
		\begin{itemize}
		\item Debian Etchまで: arm OABI (Old ABI)
		\item Debian Lennyから: armel EABI (new Embedded ABI)
		\end{itemize}
	\item Marvell orion5x 5182 chipset; SATA interface
	\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{Buffalo Linkstation NAS 歴史 (続き)}
\begin{itemize}
\item 第３世代: Linkstation LS-XHL/LS-CHL/LS-WXL\\
\& Linkstation LS-VL/LS-WVL/LS-QVL, etc
	\begin{itemize}
	\item Marvell kirkwood 6281 / 6282 chipset
	\item armel architecture なので、第２世代と rootfs の互換性があり、また Debian Kernel 4.4 から同じ「-marvell」という flavour で対応されます。
	\end{itemize}
\item 第４世代: LS-210/LS-220/LS-410/LS-420, etc
	\begin{itemize}
	\item Marvell armada-370 chipset
	\item armhf architecture
	\item 残念ながら、Kernel の方がまだ対応されてない
	\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{Debian Installer}
\begin{itemize}
\item Debian Installer では、様々機器に Debian をインストールしてくれるツールです。
	\begin{itemize}
	\item 非 Linux な OS でも対応される、例え kFreeBSD や GNU/Hurd など
	\item モニターなど表示デバイスが付いてない機器でも対応される──network-console イメージ\\
	　⇒ ちょうど Buffalo Linkstation など NAS 機器に向け
	\end{itemize}
\item 現在対応されてる Linkstation リスト:
\footnote{d-i daily が含まれる}
	\begin{itemize}
	\item Kuro-Box Pro / Linkstation Pro/Live
	\item Linkstation LS-GL / LS-WSGL / LS-WTGL
	\item Linkstation LS-XHL / LS-CHLv2 / LS-WXL / LS-WSXL / LS-VL / LS-WVL / LS-QVL\\
	　⇒ 第２世代と第３世代はほとんど対応されてます
	\end{itemize}
\end{itemize}
\end{frame}


\section{Linkstation へ Debian のインストール仕方}
\emtext{Linkstation へ Debian のインストール仕方}

\begin{frame}{D-I インストール手順}
Buffalo Linkstation では、u-boot という boot loader が、1番目の partition (/dev/sda1 or /dev/md0) に保存される kernel と initrd を読み込んで起動を行います。
それから、D-I イメージを1番目の partition に置いとけば、debian installer が起動されます。
大体の手順は、下記の通りとなります。
\begin{itemize}
\item 1番目の partition をフォーマットする(既に存在するなら省略可)
\footnote{1番目の partition は ext2/ext3 に限られます。}
\item D-I kernel/initrd イメージを、1番目の partition にコピーする。D-I イメージは下記URLでダウンロード出来ます。
	\begin{itemize}
	\item https://d-i.debian.org/daily-images/armel/daily/orion5x/network-console/buffalo
	\item https://d-i.debian.org/daily-images/armel/daily/kirkwood/network-console/buffalo
	\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{D-I インストール手順 (続き)}
\begin{itemize}
\item Linkstation を起動し、暫く待って、DHCPでIPを割り当てられたら、そのIPに SSH にします。
\item 画面を沿って、普通な debian install 行うことが出来ます。
\end{itemize}
\end{frame}

\begin{frame}[containsverbatim]{詳細な手順 (その 0)}
LinkstationのHDDをLinkstationから外し、SATA-USBアダプターなど方法経由でPCに接続します。例えば、その HDD が /dev/sdc として説明します。
LS-WXL/WSXL/WVL/QVL などRAID機器の場合は、すべてのHDDを同じ partition にしても良いです。
\begin{commandline}
# parted /dev/sdc
(parted) mklabel gpt
(parted) mkpart boot 2048s 1024MiB
(parted) mkpart root 1024MiB 6144MiB
(parted) mkpart swap 6144MiB 6400MiB
(parted) mkpart data 6400MiB -1
(parted) set 1 raid on
(parted) set 2 raid on
(parted) set 3 raid on
(parted) set 4 raid on
(parted) quit
\end{commandline}
\end{frame}

\begin{frame}[containsverbatim]{詳細な手順 (その 1)}
\begin{itemize}
\item Partition を作ったら、確認するとこうなります。
\end{itemize}
\begin{commandline}
(parted) print
Model: SAMSUNG HM250HI (scsi)
Disk /dev/sdc: 250GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags:
Num Start   End     Size    File sys  Name  Flags
 1  1049kB  1074MB  1073MB            boot  raid
 2  1074MB  6442MB  5369MB            root  raid
 3  6442MB  6711MB  268MB             swap  raid
 4  6711MB  250GB   243GB             data  raid
\end{commandline}
\begin{itemize}
\item RAIDの場合は他の HDD も同じようにセットしてください。
\end{itemize}
\end{frame}

\begin{frame}[containsverbatim]{詳細な手順 (その 2)}
\begin{itemize}
\item kernel/initrd イメージを第１番目 partition にコピーします。(例え、LS-WXL のイメージ)
\item RAID の複数HDDの場合は、念のためすべてHDDをコピーしましょう。
\end{itemize}
\begin{commandlinesmall}
# mkfs.ext3 /dev/sdc1
# mount /dev/sdc1 /mnt; cd /mnt
# wget https://d-i.debian.org/daily-images/armel/daily/kirkwood/\
  network-console/buffalo/ls-wxl/uImage.buffalo
# wget https://d-i.debian.org/daily-images/armel/daily/kirkwood/\
  network-console/buffalo/ls-wxl/initrd.buffalo
# cd - ; umount /mnt
\end{commandlinesmall}
\end{frame}

\begin{frame}[containsverbatim]{詳細な手順 (その 3)}
\begin{itemize}
\item HDDs を Linkstation に戻して、起動させます。
\item 暫く待つと、Android/iOS アプリ「Fing」のような IP/port scanner で Linkstation に割り当てた IP を見つけます。また、DHCP サーバ側のログでも
\item IP を分かると、SSH コマンドを叩くと debian installer 画面が出て来る：
\end{itemize}
\begin{commandline}
$ ssh installer@<IP of Linkstation>
\end{commandline}
\begin{itemize}
\item D-I SSHのデフォルトパスワードは「install」となります。
\end{itemize}
\end{frame}

\begin{frame}[containsverbatim]{インストール時に伝えたいポイント(その 0)}
\begin{itemize}
\item ほとんど RAID についてポイントなので、LS-GL/CHL/XHL/VL などRAIDなしの機種ならスキップください。
\item もし RAID の設定が見つからない場合は、Partman の画面から一旦「バック」し、「Download installer components」に partman-md などモジュールを選択してから、出来るようになります。
\end{itemize}
\end{frame}

\begin{frame}[containsverbatim]{インストール時に伝えたいポイント(その 1)}
\begin{itemize}
\item もし D-I で RAID を新規する場合、一番目の /dev/md0 が metadata=0 (version 0.90) にしないと再起動しなくなります。原因は u-boot が第１番目 partition の kernel/initrd を読み込まなくなるため。現在 partman-md に設定出来なくて、command line にしましょう：
\begin{commandline}
# mdadm --create /dev/md0 --level=1 --raid-devices=2 \
  -e 0 /dev/sda1 /dev/sdb1
\end{commandline}
\item または (他のHDDが後にします)
\begin{commandline}
# mdadm --create /dev/md0 --level=1 --raid-devices=2 \
  -e 0 /dev/sda1 missing
\end{commandline}
\item /dev/md0 以外の RAID は partman-md で設定しても良いです。
\end{itemize}
\end{frame}

\begin{frame}[containsverbatim]{インストール時に伝えたいポイント(その 2)}
\begin{itemize}
\item RAID を新規すると resync 作業が始められ、とても重くて、D-I に影響ならないように /dev/md0 以外の resync 速度を制限かけた方が良いです：
\end{itemize}
\begin{commandline}
# echo 100 > /sys/block/md{1,2,3}/md/sync_speed_max
\end{commandline}
\begin{itemize}
\item インストールを終わって再起動したら、RAID resync は自動的に再開されるので、特に作業が必要なし。
\end{itemize}
\end{frame}

\begin{frame}[containsverbatim]{インストール後の設定}
\begin{itemize}
\item u-boot 設定を確認・変更のための fw\_printenv / fw\_setenv
	\begin{itemize}
	\item 変更して起動しない場合があり、修復手段があまりなくて、気をつけましょう。
	\item ほとんどの機種は下記の設定が済みです：
	\end{itemize}
\begin{commandlinesmall}
# echo /dev/mtd2 0x00000 0x10000 0x10000 > /etc/fw_env.config
\end{commandlinesmall}
	\begin{itemize}
	\item Kuro-Box Pro は mtd/flash の数が多いので、下記の設定にしてください。
	\end{itemize}
\begin{commandlinesmall}
# echo /dev/mtd5 0x00000 0x10000 0x10000 > /etc/fw_env.config
\end{commandlinesmall}
\end{itemize}
\end{frame}

\begin{frame}[containsverbatim]{インストール後の設定(続き)}
\begin{itemize}
\item 他の機器で起動ログを確認するための netconsole
	\begin{itemize}
	\item Linkstation の設定：
	\end{itemize}
\begin{commandlinesmall}
# cat << EOT >> /etc/initramfs-tools/modules
marvell
mv643xx_eth
netconsole netconsole=@192.168.11.150/,6666@192.168.11.1/
mvmdio
EOT
update-initramfs -u
\end{commandlinesmall}
	\begin{itemize}
	\item 他のログ収集の機器の設定：
	\end{itemize}
\begin{commandlinesmall}
$ sudo ip a add 192.168.11.1/24 dev eth0
$ nc -l -u -p 6666 | tee ~/netconsole.log
\end{commandlinesmall}
\end{itemize}
\end{frame}


\section{TODO}
\emtext{TODO}

\begin{frame}{これからのこと}
\begin{itemize}
\item D-I に screen/tmux を対応する
	\begin{itemize}
	\item SSH connection が切れても、再接続すると元の状態に再開されます。
	\item シェルやログなど便利にアクセス出来ます。
	\end{itemize}
\item 第４世代の armhf/armada-370 Linkstation を対応する
\end{itemize}
\end{frame}


\section{Demo}
\emtext{Demo}

\begin{frame}{Buffalo Linkstation NAS のインストールデモ}
\begin{itemize}
\item 2-Bay 2.5’ HDD model Linkstation LS-WSXL
\end{itemize}
\end{frame}

\end{document}

;;; Local Variables: ***
;;; outline-regexp: "\\([ 	]*\\\\\\(documentstyle\\|documentclass\\|emtext\\|section\\|begin{frame}\\)\\*?[ 	]*[[{]\\|[]+\\)" ***
;;; End: ***
