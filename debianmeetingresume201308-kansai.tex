%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Kansai Debian Meeting resources
%     Copyright (C) 2007 Takaya Yamashita
%     Thank you for Tokyo Debian Meeting resources

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image200708; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{kansaimonthlyreport}
\usepackage[dvips]{xy}
\usepackage{ulem}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2013}
\newcommand{\debmtgdate}{25}
\newcommand{\debmtgmonth}{8}
\newcommand{\debmtgnumber}{73}

\begin{document}

\begin{titlepage}

% 毎月変更する部分、本文の末尾も修正することをわすれずに

 第\debmtgnumber{}回 関西 Debian 勉強会資料

\vspace{2cm}

\begin{center}
\includegraphics{image200802/kansaidebianlogo.png}
\end{center}

\begin{flushright}
\hfill{}関西 Debian 勉強会担当者 佐々木・倉敷・のがた・かわだ・八津尾 \\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日
\end{flushright}

\thispagestyle{empty}
\end{titlepage}

\dancersection{Introduction}{Debian JP}

\vspace{1em}

 関西Debian勉強会はDebian GNU/Linuxのさまざまなトピック
 (新しいパッケージ、Debian特有の機能の仕組、Debian界隈で起こった出来事、
 などなど）について話し合う会です。

 目的として次の三つを考えています。
 \begin{itemize}
  \item MLや掲示板ではなく、直接顔を合わせる事での情報交換の促進
  \item 定期的に集まれる場所
  \item 資料の作成
 \end{itemize}

 それでは、楽しい一時をお楽しみ下さい。

\newpage

\begin{minipage}[b]{0.2\hsize}
 {\rotatebox{90}{\fontsize{80}{80}
{\gt 関西 Debian 勉強会}}}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\setcounter{tocdepth}{1}
\tableofcontents
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{最近のDebian関係のイベント報告}{Debian JP}

\subsection{}

\subsection{}

\subsection{Debian Project}

\dancersection{事前課題}{Debian JP}

今回は以下の課題を出題しました.
\begin{screen}
  \begin{enumerate}
  \item %
    構成管理システムをどのように活用(している/したい)かを記述してください
  \end{enumerate}
\end{screen}
参加者の皆さんの解答は以下の通りです:

\clearpage
\dancersection{puppet による構成管理の実践}{倉敷 悟}

\subsection{概要}

このセッションでは、まっさらな Wheezy 環境に puppet をセットアップし、
実際にマニフェストを書いて、Debian アーカイブの部分ミラーを構成させて
みようと思います。

\subsection{puppet のインストールと編集環境のセットアップ}

puppet は、中央にサーバを置く形でも動作させることができますが、今回は
スタンドアローンでバッチ的に動作させることで使っていきます。
そのため、まずは puppet のコマンドラインクライアントをインストール
してください。

\begin{commandline}
sudo apt-get install puppet
\end{commandline}

また、構成管理する OS 上でマニフェストの操作も行いますので、好みの
テキストエディタをインストールしてください。emacs であれば、puppet-el
\footnote{vim の場合は vim-puppet} というパッケージを使うと、予約語の
色分けなどをしてくれるので便利です。

\begin{commandline}
sudo apt-get install emacs puppet-el
\end{commandline}

引き続き、マニフェスト用のディレクトリ構造を作ります。

\begin{commandline}
mkdir -p /etc/puppet/manifests
※mkdir -p /path/to/<manifest-dir>/manifests
\end{commandline}


特定のディレクトリ/manifests というお作法はこの先も繰り返し使って
いきます。今回は、エントリポイントとなるマニフェストファイルをここに
設置します。

\subsection{完成図の検討}

では、構成管理としてやりたいことを検討します。今回は、Debian アーカイブの
部分ミラーを構成する、ということになりますので、ざっくりと下記のような
構成で検討してみます。

\begin{itemize}
\item
  アーキテクチャは amd64 だけでいいや
\item
  ディストリビューションは Wheezy で、その更新も含めよう
\item
  とりあえず必要最低限 (required) のパッケージだけをミラーする
\item
  リポジトリの管理は reprepro を使ってみよう
\item
  puppet は環境設定だけで、ミラー実行は(とりあえず)手でやるかな
\item
  アクセスは http でやろう
\end{itemize}

細かいところは、多少は好みで変更してもらっても構いませんが、時間がかかる
ので、対象を増やすのであれば回線がリッチな時にやることをおすすめします。

上記に付随して、

\begin{itemize}
\item
  Web サーバは apache2 でいいかな
\item
  Secure Apt のための GPG 設定は archive-keyring を流用
\item
  配置場所は /var/www/mirror で所有者 www-data くらい？
\end{itemize}

といったことも考える必要がでてきます。

TBD

\subsection{全体像を下書きしてみる}

おおよその完成イメージができたら、それを実現するためのトップレベルの
マニフェストを、「こう書けたら嬉しい」という感じで下書きしてみます。

先程作成しておいたディレクトリで、site.pp というファイルを編集して
いきます。

\begin{commandline}
vi /etc/puppet/manifests/site.pp

# 必要になりそうなパッケージを class として列挙
class {
  'apache2':;
  'reprepro':;
  'debian-archive-keyring':;
}

# reprepro をよしなに設定してほしい
reprepro::mirror { '/var/www/mirror':
  owner => 'www-data', group => 'www-data',
  architecture => 'amd64',
  distribution => 'wheezy',
  partial => 'required',
}

# デフォルトサイトを無効化して、ミラー用のサイトを追加
apache2::site {
  'default': ensure => false;
  '/var/www/mirror':;
}
\end{commandline}

前回のおさらいも兼ねて、puppet のマニフェスト書式について口頭で簡単な
おさらいをします。資料としては前回の分を参照してください。

TBD (前回へのアンカー？)

\subsection{必要な class を作る}

前節でとりあえず並べた class の要素はまだ存在しないため、このままでは
実行できません。それぞれ作ってあげる必要があります。
まずは、class 定義の枠と、パッケージのインストールだけをするように作って
みましょう。

\begin{commandline}
class apache2 {
  package { 'apache2':; }
}

class reprepro {
  package { 'reprepro':; }
}

class debian-archive-keyring {
  package { 'debian-archive-keyring':; }
}
\end{commandline}

TBD
\subsubsection{apache2}


\subsubsection{reprepro}

今回は reprepro 自体の使い方は主眼ではないので、簡単に紹介だけしておきます。

reprepro は、指定したディレクトリに Debian のミラーを構成するツールです。
指定ディレクトリに、決まったフォーマットで設定ファイルを用意しておくことで、
柔軟にミラーを構成できるので、ちょっとした個人用とか、社内だけで使うといった
用途で、気軽にミラーを用意することができます\footnote{パブリックなフルミラーを用意したい場合は、別途専用のツールがあります。}。

reprepro を動作させるために、conf/distributions と conf/updates、2 つの
設定ファイルが必要になります。
ミラーのファイル置き場にするディレクトリに移動してください。
ここでは、wheezy の部分ミラーを作成しますので、ひとまず下記の内容で
ファイルを作成してください。

\begin{commandline}
Codename: wheezy
Architectures: i386
Description: wheezy-mirror
Components: main contrib
Update: wheezy-mirror-update wheezy-security
\end{commandline}

\begin{commandline}
Name: wheezy-mirror-update
Method: http://ftp.jp.debian.org/debian
Components: main contrib
Architectures: i386
VerifyRelease: AED4B06F473041FA
FilterFormula: Priority (==required)

Name: wheezy-security
Method: http://security.debian.org/debian-security
Suite: wheezy/updates
UDebComponents: none
VerifyRelease: AED4B06F473041FA
FilterFormula: Priority (==required)
\end{commandline}

Secure APT 用の公開鍵は、debian-archive-keyring を下記のように
参照したものです。
部分ミラーについては、専用の公開鍵を別途作成しましょう。

\begin{commandline}
TBD
\end{commandline}

設定が終わったら、正しく動作するか確認します。

\begin{commandline}
reprepro -V
\end{commandline}

少し時間がかかりますが、指定したミラーからファイルをダウンロードする
はずです。
終わったら、ノードの /etc/apt/souces.list を少しいじって、apt-get から
アクセスできるかどうか確認しておくといいでしょう。

さて、ここまでで reprepro が動作する設定ができあがりましたので、これを
puppet のマニフェストに移していきましょう。

一旦、reprepro が作成したファイル類を全て削除します(別にしなくても構い
ませんが、ここまでのテスト内容を掃除するためです)。

\begin{commandline}
rm -r db/ dists/ pool/
\end{commandline}

先程作成した、reprepro クラスを開き、設定ファイルを流しこむ方法を考えます。
パラメータをテンプレートで受けるなど、やり方はいくつかありますが、ここでは
単純に、ファイルをそのまま置くだけとしておきます。

ミラーは、配置するディレクトリを変更することで、ノード内に複数作成することが
できるので、クラスではなく、リソースとして定義します。

\begin{commandline}
class reprepro {
  package { 'reprepro':; }
}

define reprepro::mirror (
  $distributions,
  $updates,
  ) {
  # ミラーの配置ディレクトリを作成する
  ## リソース名としてフルパスが渡されてくる想定
  file { "$name":
    ensure => directory,
  }
  -> file { "${name}/conf":
    ensure => directory,
  }
  -> file { # 設定ファイルの名前はパラメータとして受け取る
    "${name}/conf/distributions":
      content => $distributions;
    "${name}/conf/updates":
      content => $updates;
  }
}
\end{commandline}


パラメータ指定をやめてファイルを直接与えることにしたので、呼び出し元も
変更する必要があります。

\begin{commandline}
# reprepro をよしなに設定してほしい
reprepro::mirror { '/var/www/mirror':
  owner => 'www-data', group => 'www-data',
  distributions => 'Codename: wheezy
Architectures: i386
Description: wheezy-mirror
Components: main contrib
Update: wheezy-mirror-update wheezy-security',
  updates       => 'こちらも同様に'
}
\end{commandline}

ここまでで、puppet を実行することで、reprepro の設定ファイルが準備され、
後はコマンドを実行するだけ、という状態になります。

最終的には reprepro コマンドの実行も puppet にやらせるといいのですが、
話が広がってしまうので、今回はここまでとしておきます。

\subsection{マニフェストの適用とデバッグ}

さて、ここまでで作成したマニフェストを実行すると、

\begin{itemize}
\item apache2 がセットアップされて、ミラーのディレクトリが公開される
\item ミラーのディレクトリに reprepro の設定が用意される
\end{itemize}

はずですので、早速試してみましょう。まずは、dry run から。

\begin{commandline}
puppet apply /etc/puppet/manifests/site.pp --noop
\end{commandline}

スペルミスや、記号抜けなど、書式違いがあれば puppet が教えてくれますので、
出力内容を確認してみてください。

問題なさそうなら、--noop を削って、そのまま実行しましょう。


\subsection{マニフェストの整理}

puppet は、モジュールという単位でマニフェストを分割することができます。

今回は、さほど大きなマニフェストを書いているわけではないので、site.pp
だけでも十分見通しがききますが、1ファイルにダラダラ書いていくにも限度が
あります。ある程度大きく育ってきたら、マニフェストを分割しましょう。

\subsubsection{パッケージモジュール}

モジュールをどういう単位で切り出すかは、個人の好みもあると思いますが、
ここではとっかかりとして「パッケージ単位」をおすすめしておきます。

では、パッケージに対応した puppet モジュールの置き場所を決めましょう。
例えば、

mkdir -p /etc/puppet/modules/

などとします。このディレクトリ以下に、モジュール名のディレクトリを作成
していくことになりますが、Debian での利用を考えると、「ソースパッケージ名」
を使うといいでしょう (バイナリパッケージが細かく分割されていたりするので)。

例えば、apache2 のモジュールを作るのであれば、

mkdir -p /etc/puppet/modules/apache2/manifests
emacs /etc/puppet/modules/apache2/manifests/init.pp

のようにします。「モジュール名/manifests/init.pp」はルールなので、別の
ファイル名にすることはできません。
とりあえず、先程作成した、apache2 クラスの内容をこちらに移動させてみて
ください。

パッケージモジュールの内容を決める上では、次のことに注意するといいでしょう。
\begin{itemize}
\item
  パッケージ固有の内容に絞り、サイト固有の設定は可能な限り含めない
\item
  後で再利用できるようにパラメータを決める
\end{itemize}

\subsubsection{サービスモジュール}

パッケージモジュールを切り離した後は、ノード/サイト固有の設定が
site.pp に残っている状態になっているはずです。そのうち、今作業している
ノードだけでなく別のノードでも再利用しそうなロール (うちでは Web サーバは
いつもこの設定で作るようにしてるんだ、とか) も、可能であればモジュールと
して切り出しておきましょう。

puppet から見ると、用途に関係なくモジュールはモジュールなのですが、
パッケージモジュールと区別するために、便宜的にサービスモジュールと呼んで
おきます。
puppet の書式ガイドライン的には、モジュール名として頭に s\_ をつける
ことになっています。

サービスモジュールはサイト固有の内容になりますので、パッケージモジュール
ほど境界を気にしなくてもいいでしょう。

例えば、部分ミラーのロールを作るのであれば、

mkdir -p /etc/puppet/services/s\_partial\_mirror/manifests
emacs /etc/puppet/services

\subsection{ここからの育て方}

ひとまず、今回のセッションで Debian アーカイブのローカルミラーが
お手軽に作れるようになっていますので、次のステップとして、

reprepro の設定ファイル指定がダサすぎるのでなんとかする
ローカルミラーを参照するように sources.list を設定する
ローカルミラーに独自パッケージを追加できるように reprepro の設定を追加する
手動のままだった reprepro のコマンド実行を含める



\dancersection{今後の予定}{Debian JP}

\subsection{関西 Debian 勉強会}


\subsection{東京エリア Debian 勉強会}



%
% 冊子にするために、4の倍数にする必要がある。
% そのための調整
\dancersection{メモ}{}
\mbox{}\newpage
\mbox{}\newpage
%% \mbox{}\newpage

\printindex
%\cleartooddpage

 \begin{minipage}[b]{0.2\hsize}
  \rotatebox{90}{\fontsize{80}{80} {\gt 関西 Debian 勉強会} }
 \end{minipage}
 \begin{minipage}[b]{0.8\hsize}

 \vspace*{15cm}
 \rule{\hsize}{1mm}
 \vspace{2mm}
 \includegraphics[width=2cm]{image200502/openlogo-nd.eps}
 \noindent \Large \bf Debian 勉強会資料\\ \\
 \noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
 \noindent \normalfont 関西 Debian 勉強会 （編集・印刷・発行）\\
 \rule{\hsize}{1mm}
 \end{minipage}

\end{document}
