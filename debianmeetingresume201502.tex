%; whizzy chapter -dvi
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。
 
%     Tokyo Debian Meeting resources
%     Copyright (C) 2012 Junichi Uekawa
%     Copyright (C) 2011 Nobuhiro Iwamatsu

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}
% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2015}
\newcommand{\debmtgmonth}{2}
\newcommand{\debmtgdate}{21}
% started from zero:
% (let ((year 2013) (month 7)) (+ (* (- year 2005) 12) month -1))
\newcommand{\debmtgnumber}{123}

% tikz picture の為のマクロ設定
\usepackage[dvipdfmx]{graphicx}
\usepackage{tikz}

\begin{document}

\begin{titlepage}
\thispagestyle{empty}
% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料\\
\hspace*{-2cm}
\includegraphics{image2012-natsu/dotdeb.pdf}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

% ここはアップデートすること
% 全角文字にしないとフォントのサイズが合わないので注意
\rotatebox{10}{\fontsize{30}{30} {\gt 特集：kFreeBSDにおけるJail構築}}\\

\vspace*{-2cm}
\hfill{}\includegraphics[height=6cm]{image200502/openlogo-nd.eps}
\end{titlepage}

\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\begin{multicols}{2}
\tableofcontents
\end{multicols}
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{事前課題}{野島 貴英}

今回の事前課題は以下です:
\begin{enumerate}
\item 本日、何の作業をやるかを宣言ください。
\item (オプション) どこで今回の勉強会の開催を知りましたか？
\item (オプション) 何について聞きたい／参加者と話をしたいですか？
\end{enumerate}
この課題に対して提出いただいた内容は以下です。
\begin{multicols}{2}
{\small
\input{image201502/prework.tex}
}
\end{multicols}

\dancersection{Debian Trivia Quiz}{野島 貴英}

 Debianの昨今の話題についてのQuizです。

今回の出題範囲は\url{debian-devel-announce@lists.debian.org} や \url{debian-news@lists.debian.org}に投稿された
内容などからです。

\begin{multicols}{2}
\input{image201502/quiz.tex}
\end{multicols}

\dancersection{最近のDebian関連のミーティング報告}{野島 貴英}

\subsection{第122回東京エリアDebian勉強会}

\begin{itemize}
\item 場所はスクウェア・エニックスさんのセミナルームをお借りしての開催でした。
\item 参加者は8名でした。
\item セミナ内容は @henrichさんにより「Emacs関連パッケージのDebianパッケージ作成について」でした。
\item 残りの時間でhack timeを行い、成果発表をしました。
\item 宴会の代わりに、「祥龍房 新宿イーストサイドスクエア店」で夕食会をやりました。
\end{itemize} 

　セミナですが、Debian Developerの@henrichさんにより、Emacs関連パッケージのDebianパッケージ作成について発表がありました。emacsのelispプログラムをパッケージ化する際、dh\_makeを使ってテンプレートを作ってパッケージ化するのですが、もろもろdh\_makeの機能で足らない・不都合な部分をBTSして直してもらうという事も併用されているのが印象的でした。勉強会資料にもありますが、「Policy を読んで tips を確認する手間を省くには dh-make パッケージをハックしてしまえ」というのは、Debian開発の上で非常に正しい姿と思います。

% % (query-replace-regexp "<.*?>" "")
% % (query-replace-regexp "^[	 ]\+" "")

%-------------------------------------------------------------------------------
\dancersection{Debian GNU/kFreeBSDにおけるJail構築を試してみた}{杉本 典充}
%-------------------------------------------------------------------------------
\index{debian-kfreebsd-jail}

\subsection{はじめに}

Debian GNU/kFreeBSDは、FreeBSDカーネルで動作するDebianです。
近頃はdockerを実装例としたコンテナ環境に復権（?!）の兆しがあるようにも思えます。そこで、Debian GNU/kFreeBSDをホストとして、FreeBSD Jail環境の構築を試してみます。

\subsection{Debian PortsとDebian GNU/kFreeBSD}

Debian Ports \footnote{\url{https://www.debian.org/ports/}}とは、さまざまなCPUやカーネルで動作するように移植を行うプロジェクトのことです。

FreeBSDカーネルで起動するDebianを作るプロジェクトがあり、そのDebianのことを「Debian GNU/kFreeBSD」と呼んでいます(kはkernelのこと)。現在ではIntel CPUのアーキテクチャのみあります(kfreebsd-amd64、kfreebsd-i386)。Debian 6 (Squeeze)ではテクノロジープレビューとして初めてstableリリースされました。Debian 7 (Wheezy)でも継続してstableリリースされたのですが、Debian 8 (Jessie)ではDropされることが決まっています。\footnote{\url{https://lists.debian.org/debian-devel-announce/2014/09/msg00002.html}において、stableを維持しつつsidの開発を進めるにはそれなりに人手が必要であるが、kFreeBSDを作業する人手は不足していることが指摘されています。}

\subsection{Debianにおけるコンテナ環境の構築方法}

Debianにおいて、コンテナ環境を構築するにはdebootstrapを使います。通常はホスト環境と同じアーキテクチャを引数に指定して実行します。\footnote{debootstrapについては昔の記事にまとめたものがあります。「debootstrap を有効活用してみよう」\url{http://tokyodebian.alioth.debian.org/pdf/debianmeetingresume2013-natsu.pdf}}

\begin{commandline}
# apt-get install debootstrap
# mkdir -p /srv/jail
# cd /srv/jail
# debootstrap --arch=[arch] [release] [dir] http://ftp.jp.debian.org/debian
\end{commandline}

ホスト環境のアーキテクチャと異なるアーキテクチャのコンテナ環境を用意すると普通は動作しません。
ところが、Debianではコンテナ環境とqemuを組み合わせることでエミュレーション動作させつつ、見た目はコンテナ環境でバイナリを実行させる方法があります。これをCrossDebootstrapと言います。\footnote{\url{https://lists.debian.org/debian-mips/2011/02/msg00031.html} 2011年頃にkfreebsd-mips対応をしていた動きがあるようで、これが動くようになればkfreebsdでCrossDebootstrapを使える日がくるかもしれません。}

\begin{commandline}
# apt-get install qemu binfmt-support qemu-user-static
# debootstrap --foreign --arch=[arch] [release] [dir] http://ftp.jp.debian.org/debian
# cp /usr/bin/qemu-[arch]-static /[dir]/usr/bin/
# chroot [dir]
# /debootstrap/debootstrap --second-stage
\end{commandline}

\subsection{Debian GNU/kFreeBSDをホストとしたJail環境の構築}

Debian GNU/kFreeBSD上でJail環境を構築してみました。環境は以下で行いました。

\begin{itemize}
  \item ホスト環境 
  \begin{itemize}
    \item Debian GNU/kFreeBSD unstable amd64
    \item FreeBSD-10.1 kernel (10.1~svn274115-2)
  \end{itemize}
  \item ネットワーク環境 
  \begin{itemize}
    \item ホストとコンテナが同一ネットワーク(192.168.0.0/24)
  \end{itemize}
  \item コンテナ環境
  \begin{itemize}
    \item FreeBSD Jailにて起動する
  \end{itemize}
\end{itemize}

jailコマンドはaptでインストールできます。

\begin{commandline}
# apt-get install freebsd-utils
# which jail
/usr/sbin/jail
\end{commandline}

ただし現状では、jls\footnote{jlsは起動しているjailを一覧表示するコマンドです。Jail環境として動作しているコンテナは、kernelによってjidという番号を付与され識別されます。}、jexec\footnote{jexecはJail環境内でコマンドを実行するコマンドです。実行例は 「\# jexec 1 /bin/sh」}コマンドはパッケージ化されていません。そのため、今回はJail環境でsshdを動かし、sshログインできるようにすることをゴールとします。

Jail環境を作成して起動するには以下の作業を行います。

\begin{itemize}
  \item Jail環境の動作に必要なバイナリや設定ファイル等のディレクトリツリーを配置する
  \item ネットワークデバイスにIP Alias設定を行う
  \item Jail環境内の動作に必要な/devやファイルシステムのmountを行う
  \item jailコマンドを実行してJail環境を起動する
\end{itemize}


\subsubsection{kfreebsd-amd64、kfreebsd-i386のJail環境}

ホスト環境と同じアーキテクチャのJail環境を作成します。以下の手順はkfreebsd-amd64を指定していますが、kfreebsd-i386も同様の手順で構築することができます。

\begin{commandline}
# mkdir -p /srv/jail
# cd /srv/jail
# debootstrap --arch=kfreebsd-amd64 wheezy jail_kf64_1 http://ftp.jp.debian.org/debian
\end{commandline}

Jail環境内の設定ファイルを変更します。

\begin{commandline}
# cd /srv/jail
# vi jail_kf64_1/etc/resolv.conf
nameserver 192.168.0.1

# vi jail_kf64_1/etc/hostname
jail_kf64_1
\end{commandline}

Jail環境内でsshdが動くように設定します。

\begin{commandline}
# chroot jail_kf64_1
# apt-get install openssh-server
# passwd
# adduser user
# passwd user
\end{commandline}

Jail環境を起動するにはdebootsrapしたディレクトリをjailコマンドの引数に指定します。Debianのwebサイトにjailを起動する前処理を含めたスクリプトの例があります\footnote{\url{https://wiki.debian.org/Debian_GNU/kFreeBSD/Jails}}。複数のJail環境を構築するため、スクリプトと起動パラメータを記述した設定ファイルに分割するよう修正しました。

設定ファイルは以下です。

\begin{commandline}
$ cat jail_kf64_1
#!/bin/sh
JID=1
JID_HOST=jail_kf64_1
JID_IPADDR=192.168.0.61
JID_NETMASK=255.255.255.0
JID_SH_PARAM=''-- -c''
JID_CMD=''/etc/init.d/rc S && /etc/init.d/rc 2''
\end{commandline}

起動スクリプトは以下です。

\begin{commandline}
$ cat jail-bootstrap.sh
#!/bin/sh

. ./$1

echo ``----''
echo ``start prison.''
echo ``[target] JID: $JID, name: $JID_HOST''
echo ``----''
echo

NIC_DEV=em0

# add ip alias
/sbin/ifconfig $NIC_DEV alias $JID_IPADDR netmask $JID_NETMASK


# Linux-like /proc and /sys filesystems
mount -t linprocfs linprocfs /srv/jail/$JID_HOST/proc
mount -t linsysfs linsysfs /srv/jail/$JID_HOST/sys

# Ramdisk required for /run
mount -t tmpfs tmpfs /srv/jail/$JID_HOST/run

# A read-only /dev filesystem with restricted set of devices
mount -t devfs devfs /srv/jail/$JID_HOST/dev
# :XXX: ruleset 4 must be initialised as explained earlier in this Wiki page
devfs -m /srv/jail/$JID_HOST/dev rule -s 4 applyset
# Ensure the jail has some essential devices
for DEVICE in null random urandom zero
do if [ ! -e /srv/jail/$JID_HOST/dev/$DEVICE ]
    then
        echo ``error: device '/dev/$DEVICE' MUST be available in the jail''
        exit 1
    fi
done

# Ensure the jail has only a limited set of devices
#for DEVICE in mem kmem
#do if [ -e /srv/jail/$JID_HOST/dev/$DEVICE ]
#    then
#        echo ``error: device '/dev/$DEVICE' MUST NOT be available in the jail''
#        exit 1
#    fi
#done

# Compatibility symlink from /dev/shm to /run/shm
ln -s /run/shm /srv/jail/$JID_HOST/dev/

# Optionally enable networking
HOSTNAME=$JID_HOST
# :XXX: this IP address *must* be assigned to one of the host's interfaces before the guest can use it
IP=$JID_IPADDR

mkdir -p /var/run/jail
jail -J /var/run/jail/$JID.jid -c jid=$JID \
  name=jail$JID \
  path=/srv/jail/$JID_HOST \
  host.hostname=$JID_HOST \
  ip4.addr=$IP \
  command=/bin/sh $JID_SH_PARAM ``$JID_CMD''
\end{commandline}

スクリプトを実行してJail環境を起動します。

\begin{commandline}
$ sudo ./jail-bootstrap.sh jail_kf64_jail

----
start prison.
[target] JID: 1, name: jail_kf64_1
----

devfs rule: ioctl DEVFSIO_SAPPLY: No such process
[info] Using makefile-style concurrent boot in runlevel S.
hostname: the specified hostname is invalid
kern.module_path: /lib/modules/10.1-0-amd64
sysctl: kern.module_path=/lib/modules/10.1-0-amd64: Operation not permitted
[....] Loading devfs rules...devfs ruleset: ioctl DEVFSIO_SUSE: Operation not permitted
 (warning).
mount: tmpfs: Operation not permitted
mount: tmpfs: Operation not permitted
[ ok ] Activating swap...done.
mount: /: unknown special file or file system
mount: /run: unknown special file or file system
mount: /proc: unknown special file or file system
mount: /sys: unknown special file or file system
[ ok ] Activating lvm and md swap...done.
[....] Checking file systems...fsck from util-linux 2.25.2
done.
[ ok ] Cleaning up temporary files... /tmp.
[ ok ] Mounting local filesystems...done.
/etc/init.d/mountall.sh: 59: kill: No such process

[ ok ] Activating swapfile swap...done.
mount: tmpfs: Operation not permitted
mount: tmpfs: Operation not permitted
[ ok ] Cleaning up temporary files....
[....] Starting device state change daemon : devddevd: Can't open devctl device /dev/devctl: Device or resource busy
 failed!
[....] Configuring network interfaces...ifconfig: up: permission denied
ifconfig: socket(family 28,SOCK_DGRAM: Protocol not supported
done.
[ ok ] Cleaning up temporary files....
[FAIL] startpar: service(s) returned failure: hostname.sh kldutils ... failed!
[info] Using makefile-style concurrent boot in runlevel 2.
[....] Starting enhanced syslogd: rsyslogdln: failed to create symbolic link '/dev/xconsole': Operation not permitted
. ok
[ ok ] Starting periodic command scheduler: cron.
[ ok ] Starting OpenBSD Secure Shell server: sshd.
\end{commandline}

Jail環境へsshログインします。

\begin{commandline}
$ ssh user@192.168.0.61
user@192.168.0.61's password:

user@jail_kf64_1:~$
\end{commandline}

Jail環境内のプロセスをすべて停止したい場合はJail環境内で以下コマンドを実行します。

\begin{commandline}
root@jail_kf64_1:~# sh /etc/init.d/rc 0
\end{commandline}


\subsubsection{FreeBSD-10.1-RELEASEのJail環境}

FreeBSDのディレクトリツリーを取得して展開します。

\begin{commandline}
# mkdir -p /srv/jail/jail_fb101_1
# cd /srv/jail/jail_fb101_1
# wget http://ftp.jaist.ac.jp/pub/FreeBSD/releases/amd64/amd64/10.1-RELEASE/base.txz
# tar xvf base.txz
# ls
COPYRIGHT  bin dev  lib      media  proc    root  sys  usr
base.txz   boot  etc  libexec  mnt    rescue  sbin  tmp  var
\end{commandline}

Jail環境内の設定ファイルを変更します。

\begin{commandline}
# vi etc/resolv.conf
nameserver 192.168.0.1
\end{commandline}

Jail環境内でsshdが動くように設定します。

\begin{commandline}
# vi etc/rc.conf
sshd_enable=''YES''
sendmail_enable=''NONE''

# cd ..
# chroot jail_fb101
# passwd
# adduser user
# passwd user
\end{commandline}

FreeBSD-10.1-RELEASEのJail環境を起動するスクリプトの設定ファイルは以下です。

\begin{commandline}
$ cat jail_fb101_1
JID=3
JID_HOST=jail_fb101_1
JID_IPADDR=192.168.0.63
JID_NETMASK=255.255.255.0
JID_SH_PARAM=''''
JID_CMD=''/etc/rc''
\end{commandline}

Jail環境を起動します。

\begin{commandline}
$ sudo ./jail-bootstrap.sh jail_fb101_1

----
start prison.
[target] JID: 3, name: jail_fb101_1
----

mount: /srv/jail/jail_fb101_1/usr/src/sys: No such file or directory
mount: /srv/jail/jail_fb101_1/run: No such file or directory
devfs rule: ioctl DEVFSIO_SAPPLY: No such process
/etc/rc: WARNING: $hostname is not set -- see rc.conf(5).
Creating and/or trimming log files.
ln: /dev/log: Operation not permitted
Starting syslogd.
ELF ldconfig path: /lib /usr/lib /usr/lib/compat /usr/local/lib
32-bit compatibility ldconfig path: /usr/lib32
Clearing /tmp (X related).
Updating motd:.
Performing sanity check on sshd configuration.
Starting sshd.
Starting cron.

Mon Feb 16 22:43:36 UTC 2015
\end{commandline}

Jail環境へsshログインします。

\begin{commandline}
$ ssh user@192.168.0.63
Password for user@jail_fb101_1:

user@jail_fb101_1:~ %
\end{commandline}

Jail環境内のプロセスをすべて停止したい場合はJail環境内で以下コマンドを実行します。\footnote{\url{https://www.freebsd.org/doc/en/books/handbook/jails-build.html}にそう記述がありプロセスはあらかた停止しているように見えますが、kernelではまだjidが生きているようでゴミが残ってしまうようです。}

\begin{commandline}
root@jail_fb101_1:/ # sh /etc/rc.shutdown
\end{commandline}


\subsubsection{linux-i386のJail環境}

【注意】debianとしては動きませんでしたので、試したところまで述べます。


FreeBSD kernelにはLinuxバイナリ互換機能というものがあり、32bitのlinuxバイナリを動かすことができます。FreeBSDにおいてLinuxバイナリ互換機能を有効にするには、linux\_base Portsをインストールし、linux.koをkldloadします。Debian GNU/kFreeBSDではkernelにstatic linkしていますのでlinux.koのロードは不要でした。

Linuxバイナリ互換機能を動かす場合は、ホスト環境のsysctl設定でlinux kernelのバージョンを指定する必要があります。今回はlinux-2.6.32を採用しているsqueezeにしてみました。\footnote{バージョンが異なった状態でchrootしてコンテナ内のバイナリを実行すると「FATAL: kernel too old」というエラーが発生します。（新しくてもtoo oldのようです）} \footnote{FreeBSD portsにおいて「linux\_base-c6」が実験的に提供されており、機能はCentOS-6のlinux kernel相当です。CentOS-6のlinux kernelは2.6.32を採用しており、squeezeと同じです。}

\begin{commandline}
# vi /etc/sysctl.conf
compat.linux.osrelease=2.6.32

# sysctl -p /etc/sysctl.conf
compat.linux.osrelease: 2.6.16 -> 2.6.32
\end{commandline}


\begin{commandline}
# mkdir -p /srv/jail
# cd /srv/jail
# debootstrap --foreign --arch=i386 squeeze jail_linux32_1 http://ftp.jp.debian.org/debian
\end{commandline}


chrootでコンテナ環境に入ってみます。コンテナ環境の中でシェルは動きますのでlinuxバイナリ互換機能は動いているようです。

\begin{commandline}
# chroot jail_linux32_1
I have no name!@test-kf2:/# 
\end{commandline}

しかし、debootstrapのsecond-stageでエラーになりました。

\begin{commandline}
I have no name!@test-kf2:/# /debootstrap/debootstrap --second-stage
/debootstrap/debootstrap: 1303: /debootstrap/debootstrap: cannot create //test-dev-null: Operation not supported
E: Cannot install into target '/' mounted with noexec or nodev
\end{commandline}

すんなり動いてはくれない状況です。mount絡みのエラーですので、mountできるようにコンテナの中を設定するか、debootstrapのスクリプトを修正するなど対処すると動くのかもしれません。

今回試せたのはここまででした。

\subsection{おわりに}

Debian GNU/kFreeBSDでFreeBSD Jail環境の構築を試してみました。
Debian GNU/kFreeBSD on FreeBSDの構成でも動作することは確認していますので試してみるのもおもしろいです。\footnote{FreeBSD Portsに/usr/ports/sysutils/debootstrapがあります。}

本家FreeBSDのJailのように便利に利用するツールのパッケージが足りていない状況ですので、Debian GNU/kFreeBSDの開発を進めるとどんどん使いやすくなると思います。

\subsection{参考資料}
\begin{itemize}
  \item Debian/kFreeBSDでjailを使う \url{http://hachulog.blogspot.jp/2011/11/debiankfreebsdjail.html}
  \item Debian\_GNU kFreeBSD Jails  \url{https://wiki.debian.org/Debian\_GNU/kFreeBSD/Jails}
  \item あんどきゅめんてっど でびあん2013年夏号 「debootstrap を有効活用してみよう」 杉本典充 \url{http://tokyodebian.alioth.debian.org/pdf/debianmeetingresume2013-natsu.pdf}
\end{itemize}

%-------------------------------------------------------------------------------
\dancersection{会場での無線LANのつなぎ方}{野島 貴英,Roger}
%-------------------------------------------------------------------------------
 \subsection{はじめに}

　今回試験として、会場側でフィルタ無しのグローバル回線を用意しました。
ただ、会場側のセキュリティポリシーにより、wpa-psk AES hidden SSIDという
方式での提供となります。

　以下にDebianマシンでの接続方法を記載します。

 また、自分の環境では違うやり方でつながったという方は、野島まで
教えて下さい。こちらでもノウハウとして溜めていく予定です。

 \subsection{wpasupplicant及び/etc/network/interfacesを利用の場合}

 もっとも良いマニュアルは、/usr/share/doc/wpasupplicant/README.Debian.gz
となります。困った場合はこちらも合わせてご参照下さい。

　以下に/etc/network/interfacesの定義について会場の例を記載します。

\begin{commandline}
$ sudo vi /etc/network/interfaces
-----以下のエントリがなければ追記ここから----------
iface wlan0_debian inet dhcp
     wpa-conf /etc/wpa_supplicant/wpa_supplicant_debian.conf
-----以下のエントリがなければ追記ここまで----------
$ sudo vi /etc/wpa_supplicant/wpa_supplicant_debian.conf
-----以下のエントリを追記ここから----------
network={
     ssid=<<会場のSSID>>
     psk=<<会場のパスワード>>
     scan_ssid=1
}
-----以下のエントリを追記ここまで----------
$ sudo chmod 600 /etc/wpa_supplicant/wpa_supplicant_debian.conf
$ sudo ifup wlan0=wlan0_debian
\end{commandline}
%$

 また、ハマってしまった時のデバッグ方法は、
/usr/share/doc/wpasupplicant/README.Debian.gz中の''4. Trubleshooting''の章が便利です。

 \subsection{その他の無線LAN用パッケージを利用の場合}

　すみません、自分が情報を持たないため、現場で教えて下さい。

\cleartooddpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule

\end{document}
