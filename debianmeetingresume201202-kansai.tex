%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Kansai Debian Meeting resources
%     Copyright (C) 2007 Takaya Yamashita
%     Thank you for Tokyo Debian Meeting resources

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image200708; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{kansaimonthlyreport}
\usepackage[dvips]{xy}


% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2012}
\newcommand{\debmtgdate}{26}
\newcommand{\debmtgmonth}{2}
\newcommand{\debmtgnumber}{56}

\begin{document}

\begin{titlepage}

% 毎月変更する部分、本文の末尾も修正することをわすれずに

 第\debmtgnumber{}回 関西 Debian 勉強会資料

\vspace{2cm}

\begin{center}
\includegraphics{image200802/kansaidebianlogo.png}
\end{center}

\begin{flushright}
\hfill{}関西 Debian 勉強会担当者 佐々木・倉敷・のがた・かわだ \\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日
\end{flushright}

\thispagestyle{empty}
\end{titlepage}

\dancersection{Introduction}{Debian JP}

 関西 Debian 勉強会はDebian GNU/Linux のさまざ
 まなトピック(新しいパッケージ、Debian 特有の機能の仕組、Debian 界隈で起
 こった出来事、などなど）について話し合う会です。

 目的として次の三つを考えています。
 \begin{itemize}
  \item MLや掲示板ではなく、直接顔を合わせる事での情報交換の促進
  \item 定期的に集まれる場所
  \item 資料の作成
 \end{itemize}

 それでは、楽しい一時をお楽しみ下さい。

\newpage

\begin{minipage}[b]{0.2\hsize}
 {\rotatebox{90}{\fontsize{80}{80}
{\gt 関西 Debian 勉強会}}}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\setcounter{tocdepth}{1}
\tableofcontents
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{最近のDebian関係のイベント報告}{Debian JP}

\subsection{第 55 回関西 Debian 勉強会}
55 回目の関西 Debian 勉強会は 1 月 28 日と 29 日の二日間の温泉合宿とし
て開催されました。\\
用意した apt のミラーサーバにソースパッケージが含まれていないという思わ
ぬ状況になりましたが、いつもの勉強会会場とは違った場所で集中して Hack
ができました。

\subsection{第 85 回東京エリア Debian 勉強会}
85 回目の東京エリア Debian 勉強会が 2 月 18 日に開催されました。\\
参加者が少なかったようですが KDE 開発、月刊 debhelper についての発表が
ありました。

\subsection{第 0 回福岡 Debian 勉強会}
同じく 2 月 18 日に福岡でも Debian 勉強会が開催されました。\\
0 回目となる今回の勉強会では Debian サーバの量産方法、DKMS とパッケージ
作成、キーサインパーティなどが行なわれたようです。\\
今後も Debian 勉強会が開催されていくとよいですね。

\clearpage

\dancersection{事前課題}{Debian JP}

今回は以下の課題を出題しました.
\begin{screen}
  \begin{description}
  \item[事前課題1] chroot について知っていますか。
    \begin{enumerate}
    \item 知らない人、chroot について調べたことを記入してください。
    \item 知っている人、PAM とオートマウンタの設定を触ったことはありますか?\\
      設定を触ったことがあるかたはその内容も記入してください。
    \end{enumerate}
  \item[事前課題2] DebianPolicy の7章に目を通しておいてください。
  \end{description}
\end{screen}

参加者の皆さんの解答は以下の通りです.

\begin{prework}{ kozo2 }
 \begin{enumerate}
  \item 知ってます
  \item ないです
  \item 読みます
 \end{enumerate}
\end{prework}

\begin{prework}{ 西山和広 }
\begin{enumerate}
 \item 知っています。
       \begin{itemize}
        \item PAM は pam-auth-update がなかった頃に libpam-ldap や libpam-tmpdir を使う設定をしました。オートマウンタは LDAP と組み合わせてホームディレクトリをマウントするのに使ったことがあります。
       \end{itemize}
\end{enumerate}
\end{prework}

\begin{prework}{ 佐藤誠 }
 \begin{enumerate}
  \item Yes. \\
        Linux From Scratch やGentoo Linux 
        のインストールのときに使っていました。

        Debian でもあれこれしたいときによく使います。

        最近はchrootが進化したような jail(8)とか
        lxc とかをちょこちょこ触っています
  \item ありません(汗
 \end{enumerate}
\end{prework}

\begin{prework}{ 川江 }
 \begin{enumerate}
  \item 同一PC上で、「異なる」root directory環境を提供する。
        \begin{itemize}
         \item 触った事はありません。
        \end{itemize}
  \item All right
 \end{enumerate}
\end{prework}

\begin{prework}{ 山下康成 }
 \begin{enumerate}
  \item 知ってます
        \begin{itemize}
         \item ずっと以前に触ったことはありますが、もう忘れてます。
        \end{itemize}　
  \item ざっと
 \end{enumerate}
\end{prework}

\begin{prework}{ 酒井　忠紀 }
 \begin{enumerate}
  \item chroot は、以下のように使用したことがあります。
        \begin{itemize}
         \item Debianベースにシステムにおいて、Linux Kernel を
               Android拡張し、chroot で Debian から Android に
               切り替える
         \item Andorid から Android の initプロセス配下を
               全て kill し、chroot 起動元の Debian のコンソールに戻る
        \end{itemize}
  \item PAM や オートマウンタ の設定を触ったことはありません。
        Debian の GNOME だと、USB などの自動マウントは
        autofs ではなく、nautilus で行っているのを
        見たことがあります。
 \end{enumerate}
\end{prework}

\begin{prework}{ かわだてつたろう }
 \begin{enumerate}
  \item 知っています。
        \begin{itemize}
         \item 触ったことはありません。発表を楽しみにしています。
        \end{itemize} 
  \item みておきます。
 \end{enumerate}
\end{prework}

\begin{prework}{ gdevmjc }
 \begin{enumerate}
  \item chroot について、知っています。\\
        PAM は、pam\_limits, pam\_chroot, pam\_ldap などの設定を触ったことがあります。pa\_wheel を追加したこともあります。
        オートマウンタは、マスターマップファイル、間接マップファイルともに触ったことが余す。 NFS や bind のマップを定義しました。
  \item はい、とりあえずチラ見しました。
 \end{enumerate}
\end{prework}

\begin{prework}{ 0xBCD1BC92 }

 \begin{enumerate}
  \item Yes 
        \begin{itemize}
         \item chrootで、PAMとオートマウンターの設定をしたことがない。 
        \end{itemize}
  \item Debian Policyの7章を眺めました。
 \end{enumerate}
\end{prework}

\begin{prework}{ 水野源 }
 \begin{enumerate}
  \item Yes
  \item autofsはYes、PAMは……忘れた
  \item ぉぅぃぇー
 \end{enumerate}
\end{prework}

\begin{prework}{ Y.YATSUO }
 \begin{enumerate}
  \item いいえ。 \\
        概要: \\
        ルートディレクトリを変更してプロセスがその外にアクセスできないようにする
       
        使われ方:
        \begin{itemize}
         \item Debian ではクリーンなビルド環境を作る
         \item セキュリティ強化の為にデーモン系をchroot環境で動かす 
        \end{itemize}
  \item 読んでおきます
 \end{enumerate}
\end{prework}

\begin{prework}{ lurdan }
 \begin{enumerate}
  \item yes
  \item no
  \item yes
 \end{enumerate}
\end{prework}

\begin{prework}{ のがたじゅん }
 \begin{enumerate}
  \item 知ってます。\\
        交野市のXubuntuの話の中で、LDAPで認証してホームをマウントするのにpam\_mountを使っただか使いたいとか話しがあって、その辺調べようと思ってたけどそのまま棚上げになってます。
  \item 日本語で読んでもいいですか (´；ω；｀) \\
       \url{http://www.debian.or.jp/community/devel/debian-policy-ja/policy.ja.html/ch-relationships.html}
 \end{enumerate}
\end{prework}

\begin{prework}{ 佐々木洋平 }
 \begin{enumerate}
  \item 知ってます。git-buildpackage 用に cowbuilder を走らせる git-builder という shell script を使ってます。
  \item はい。某所ではサーバ御本尊の \$HOME を NFS でクライアントに提供していて、LDAP で認証後に autofs で mount しています。
  \item 読んでおきます。
 \end{enumerate}
\end{prework}

\clearpage
\input{image201202/autofschroot.tex}

\clearpage
\dancersection{emacs24で問題なく使える t-code.deb を作った話}{西田 孝三}

第54回関西Debian勉強会では「t-codeのバグレポをしてみた」という題で発表しました。
前回の発表ではDebianのバグトラッキングシステムを使ってt-codeパッケージのバグレポートからDebianパッケージの作成を試み、失敗するところで止まっていました。
今回はまず問題なく動作するパッケージを作成すると共に、とりあえずパッケージを作成する(いわゆるオレオレパッケージ)にはどのようなことを行えばよいかを下記の4点に分けてお伝えします。

\begin{enumerate}
\item (バグを含む)現在のDebianパッケージのソースコードの取得と、ビルド方法の確認
\item バグ修正を含むソースコードへの置き換えとビルド、オレオレパッケージの作成
\item オレオレパッケージの動作確認
\item (修正が必要な場合)Debianディレクトリ下のファイルの変更
\end{enumerate}

\subsection{現在のDebianパッケージのソースコードの取得と、ビルド方法の確認}
まず既存のDebianパッケージのソースコードを取得し、ビルドすることでパッケージ作成方法の確認をします。
パッケージのソースコードの取得を行うにはapt-getコマンドにsourceオプションを付けパッケージを指定します。

\begin{commandline}
kozo2@debian:~/sandbox$ apt-get source t-code
kozo2@debian:~/sandbox$ ls
t-code-2.3.1            t-code_2.3.1-3.dsc
t-code_2.3.1-3.diff.gz  t-code_2.3.1.orig.tar.gz
\end{commandline}

これでソースが取得できます。今回はとにかくパッケージを作ることが目的ですので*.dsc, *.diff.gz, *.orig.tar.gzの意味は説明せず、t-code-2.3.1へ移動し、まずこのソースを用いてビルドを行いパッケージ(.debファイル)を作成してみます。これにはdebuildコマンドを用います。

\begin{commandline}
kozo2@debian:~/sandbox$ cd t-code-2.3.1/
kozo2@debian:~/sandbox/t-code-2.3.1$ ls
acinclude.m4  ChangeLog.old  COPYING  install-sh   mazegaki       skkinput3
aclocal.m4    config.guess   debian   kinput2      missing
AUTHORS       config.sub     doc      lisp         mkinstalldirs
bushu-util    configure      etc      Makefile.am  NEWS
ChangeLog     configure.in   INSTALL  Makefile.in  README
kozo2@debian:~/sandbox/t-code-2.3.1$ debuild -us -uc
\end{commandline}

debuildコマンドのオプション -us -ucは署名はせずに単にpackageにbuildする時に用います。
これで一つ上のdirectoryに.debファイルができます。

\begin{commandline}
kozo2@debian:~/sandbox/t-code-2.3.1$ ls ..
t-code-2.3.1            t-code_2.3.1-3_amd64.build    t-code_2.3.1-3.diff.gz  t-code_2.3.1.orig.tar.gz
t-code_2.3.1-3_all.deb  t-code_2.3.1-3_amd64.changes  t-code_2.3.1-3.dsc
\end{commandline}

\subsection{バグ修正を含むソースコードへの置き換えとビルド、オレオレパッケージの作成}

次にバグのあるソースコードを新しいソースコードに置き換え、ビルドができるかどうか試してみます。新しいソースコードはhttp://code.google.com/p/tcode/から取得します。

\begin{commandline}
kozo2@debian:~/sandbox/t-code-2.3.1$ cd ..
kozo2@debian:~/sandbox$ svn co http://tcode.googlecode.com/svn/trunk/ tcode-read-only
\end{commandline}

置き換えが必要なファイルを新しいソースコードをコピーすることで上書きします。

\begin{commandline}
kozo2@debian:~/sandbox$ cp tcode-read-only/tc/bushu-util/* t-code-2.3.1/bushu-util/
kozo2@debian:~/sandbox$ cp tcode-read-only/tc/etc/* t-code-2.3.1/etc/
kozo2@debian:~/sandbox$ cp tcode-read-only/tc/lisp/* t-code-2.3.1/lisp/
kozo2@debian:~/sandbox$ cp tcode-read-only/tc/mazegaki/* t-code-2.3.1/mazegaki/
\end{commandline}

これでビルドが通るか試します。(通ります)

\begin{commandline}
kozo2@debian:~/sandbox$ cd t-code-2.3.1
kozo2@debian:~/sandbox$ debuild -us -uc
\end{commandline}

とりあえず、置き換えたソースコードでパッケージができました。次はこれをインストールし動作確認してみます。

\subsection{オレオレパッケージの動作確認}
先程作成した用いるソースコードに変更を加えたDebianパッケージをインストールし、動作に問題がないか確認します。インストールするにはdpkgコマンドに-iオプションをつけてインストールしたい.debファイルを指定します。

\begin{commandline}
kozo2@debian:~/sandbox$ sudo dpkg -i t-code_2.3.1-3_all.deb 
Selecting previously unselected package t-code.
(Reading database ... 97587 files and directories currently installed.)
Unpacking t-code (from t-code_2.3.1-3_all.deb) ...
Setting up t-code (2:2.3.1-3) ...
install/t-code: Handling install for emacsen flavor emacs23
Processing triggers for install-info ...
kozo2@debian:~/sandbox$ 
\end{commandline}

インストールは問題ないようです。それではt-codeが問題ないかemacsを起動し試してみます。試しにt-code練習プログラムeelllの起動を試みるとemacsが下記のメッセージを出し、何か問題があることがわかります。

\begin{commandline}
Debugger entered--Lisp error: (error ``ファイル /usr/share/tc/EELLLTXT が存在しません。'')
  signal(error (``ファイル /usr/share/tc/EELLLTXT が存在しません。''))
  error(``ファイル %s が存在しません。'' ``/usr/share/tc/EELLLTXT'')
  tcode-set-work-buffer(`` *eelll: text*'' ``EELLLTXT'')
  eelll-completing-read()
  call-interactively(eelll t nil)
  execute-extended-command(nil)
  call-interactively(execute-extended-command nil nil)
\end{commandline}

\subsection{Debianディレクトリ下のファイルの変更}
先程の問題はt-codeが用いる交ぜ書き、部首合成変換用データがインストールされているディレクトリを指定するemacsの変数tcode-site-data-directoryの設定によるものです。このtcode-site-data-directoryを指定し直すにはパッケージ作成用directory下のdebian/emacsen-startupに下記の設定を追加しビルドし直します。

\begin{commandline}
;;; 50t-code.el --- Debian t-code startup file  -*-mode: emacs-lisp;-*-                                                            

;;; Code:                                                                                                                          

(let ((lispdir (concat ``/usr/share/'' (symbol-name flavor) ``/site-lisp/t-code'')))
  (when (and (featurep 'mule) (file-exists-p (concat lispdir ``/tc.elc'')))
    (if (fboundp 'debian-pkg-add-load-path-item)
        (debian-pkg-add-load-path-item lispdir)
      (setq load-path (cons lispdir load-path)))
    ;;                                                                                                                             
    (require 'tc-setup)
    (defconst tcode-site-data-directory ``/usr/share/t-code/'')
    ;;                                                                                                                             
    ))

;;; 50t-code.el ends here
\end{commandline}

\begin{commandline}
kozo2@debian:~/sandbox/t-code-2.3.1$ debuild -us -uc
kozo2@debian:~/sandbox/t-code-2.3.1$ sudo aptitude purge t-code
kozo2@debian:~/sandbox/t-code-2.3.1$ sudo dpkg -i ../t-code_2.3.1-3_all.deb 
\end{commandline}

これでemacs23や24といった新しいemacsでt-codeの交ぜ書き、部首合成変換が問題なく使えるようになっていると思います。ちなみにこのemacsen-startupのelispの内容はDebianパッケージのインストールによって/etc/emacs/site-start.d/50t-code.elにコピーされます。

\subsection{おわりに}

いかがでしたでしょうか。今回はとりあえずDebianパッケージを作るという目的でソースコードは変更を上書きしただけですが、本来は差分の変更などを記録する必要があるためまだまだやらねばならないことはあります。upstreamのt-codeの継続開発を行なっている方、これまでのt-code Debianパッケージメンテナの方への連絡といったこともそうです。そういったことに関してはまた次回の関西Debian勉強会で発表させて頂ければと思っています。


\clearpage
\dancersection{月刊 Debian Policy「パッケージの依存関係についてのルール」}{倉敷 悟}

分量も多くてなかなか読み辛いのが Debian Policy。敬遠している方もいると思います。
とはいえ、「ポリシー」と大仰な名前がついてはいますが、結局のところ書かれている内容は

「パッケージの作り方についてのルール、ガイド、ベストプラクティス」

を集めたものです。パッケージの開発をしていないとしても、ファイルの配置や依存関係に
不可解なものを感じたことがあれば、その答えがきっと見つかるはずです。


というわけで、勉強会で連続コマとして少しずつ読んでいってみることにします。いろいろ
含めて、おおよそ 1 年かけて終了することになると思います。
担当した人は、まだ担当していない人から次回の担当者を指名します。指名された人は、
まだ読まれていない章から順不同で好きな部分を選んでください。

さて、今回読むのは、パッケージの依存関係のポリシーについて記載されている 7 章です。

依存関係といって思い浮かぶのは Depends に代表される「前提として事前に必要」
ですが、dpkg では他にも色々な形で「そのパッケージと他のパッケージの関係」を
表現することができます。

さて、ポリシー本文は事前課題として当然\footnote{実は事前課題を指定した時点では、
日本語訳の存在をすっかり忘れていました}読み終わっているはずですが、簡単に
おさらいしていきましょう。空いた時間は四方山話として、フリーディスカッションの
ような形で、皆さんが舐めてきた辛酸を肴にして頂こうと思います。

\subsection{おさらい}
\subsubsection{debian/control の書式}

依存関係の指定は、debian/control ファイルに、依存関係の種類に応じたフィールドと
その値をセットすることで行います。

\begin{commandline}
Depends: libqdbm14, libestraier
\end{commandline}

必要があれば、カンマで区切って複数のパッケージ名を列挙することができます。これに
バージョン指定が入ると、

\begin{commandline}
Depends: libqdbm14 (>> 1.8.77 ), libestraier
\end{commandline}

となります。この場合、libqdbm14 の 1.8.77 では依存を満たせません。

同類がいくつかあって、そのうちどれかがあればよい、という場合はパイプ(\verb+|+)を使って

\begin{commandline}
Depends: emacs23 | emacs22 | emacs21
\end{commandline}

と書くことができます。

\subsubsection{バイナリパッケージ用フィールド}

バイナリパッケージでは、そのパッケージをインストールするために必要な情報として
依存関係が使われます。まずは基本的なものから。

\begin{description}
\item[Depends] なくては動かないパッケージを指定します。
\item[Recommends] なくても動きはするけれど、できれば一緒に使った方がいいパッケージを指定します。
\item[Suggests] 一緒に使うと便利なパッケージを指定します。主体はこのパッケージです。
\item[Enhances] 一緒に使うと便利なパッケージを指定します。主体は指定されたパッケージです。
\item[Pre-Depends] 通常の Depends よりも前の段階で依存先のパッケージがチェックされます。非推奨なので、使われている場合は何か地雷があるのかもしれません
\end{description}

一方で、少しややこしい関係性として、次のようなものがあります。

\begin{description}
\item[Breaks] 比較的最近追加されました。このパッケージをインストールすることで動作しなくなるパッケージを指定します。通常は、自パッケージの再編成で使われるようです
\item[Conflicts]完全に両立不可能なパッケージを指定します。システムにはそのうち 1 つしかインストールできません
\item[Replace] 指定したパッケージ全体、もしくは一部のファイルを、このパッケージで置き替えます
\item[Provides] (存在する場合) このパッケージが代替し得る、特定の仮想パッケージを指定します
\end{description}


\subsubsection{ソースパッケージ用フィールド}

ソースパッケージは、いわゆるインストールをして使うものではないので、Depends は
意味を持ちません。
ソースパッケージの依存関係では、そのソースパッケージをビルドするために必要な情報として
依存関係が使われます。

\begin{description}
\item[Build-Depends] ビルドするために必要なパッケージを指定します
\item[Build-Conflicts] ビルドする時にインストールされていてはいけないパッケージを指定します
\item[Build-Depends-Indep] build-indep ターゲットをビルドするために必要なパッケージを指定します
\item[Build-Conflicts-Indep] build-indep ターゲットをビルドする時にインストールされていてはいけないパッケージを指定します
\end{description}


\subsection{四方山話}

時間次第ですが、ここでは次のような話をざっくりとする予定です。

\begin{itemize}
\item Depends と Recommends と Suggests の違い
\item Provides と仮想パッケージ
\end{itemize}

会場で特にこれといって話題が出なさそうであれば、抜きうちで
事前課題の理解度テスト、みたいなことをするかも知れません。

\subsection{次号予告}

次回の担当は、yyatuo さんにお願いします (本人承諾済み)。

\clearpage
\dancersection{今後の予定}{Debian JP}

\subsection{次回}

次回は、2012年3月25日に福島区民センターで行います。\\
発表については未定ですので、みなさまの発表をお待ちしております。


% 冊子にするために、4の倍数にする必要がある。
% そのための調整
% \dancersection{メモ}{}
% \mbox{}\newpage
% \mbox{}\newpage

\printindex
 \cleartooddpage

 \begin{minipage}[b]{0.2\hsize}
  \rotatebox{90}{\fontsize{80}{80} {\gt 関西 Debian 勉強会} }
 \end{minipage}
 \begin{minipage}[b]{0.8\hsize}

 \vspace*{15cm}
 \rule{\hsize}{1mm}
 \vspace{2mm}
 \includegraphics[width=2cm]{image200502/openlogo-nd.eps}
 \noindent \Large \bf Debian 勉強会資料\\ \\
 \noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
 \noindent \normalfont 関西 Debian 勉強会 （編集・印刷・発行）\\
 \rule{\hsize}{1mm}
 \end{minipage}

\end{document}
