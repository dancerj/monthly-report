%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Tokyo Debian Meeting resources
%     Copyright (C) 2011 Junichi Uekawa

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image201101; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2011}
\newcommand{\debmtgmonth}{5}
\newcommand{\debmtgdate}{21}
% (+ (* (- 2010 2005) 12) 10) started from zero
\newcommand{\debmtgnumber}{76}

\begin{document}

\begin{titlepage}
\thispagestyle{empty}
% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料\\
\hspace*{-2cm}
\includegraphics[width=210mm]{image201003/debsen.eps}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

% ここはアップデートすること
\rotatebox{10}{\fontsize{32}{32} {\gt 特集1: xxx}}

\rotatebox{10}{\fontsize{32}{32} {\gt 特集2: yyy}}

\vspace*{-2cm}
\hfill{}\includegraphics[height=6cm]{image200502/openlogo-nd.eps}
\end{titlepage}

\dancersection{Introduction}{上川 純一}

\begin{multicols}{2}
 

 今月のDebian勉強会へようこそ。これからDebianの世界にあしを踏み入れると
 いう方も、すでにどっぷりとつかっているという方も、月に一回Debianについ
 て語りませんか？

 Debian勉強会の目的は下記です。

 \begin{itemize}
 \item \underline{Debian Developer} (開発者)の育成。
 \item 日本語での「\underline{開発に関する情報}」を整理してまとめ、アップデートする。
 \item \underline{場}の提供。
 \begin{itemize}
  \item 普段ばらばらな場所にいる人々が face-to-face で出会える場を提供
	する。
  \item Debian のためになることを語る場を提供する。
  \item Debianについて語る場を提供する。
 \end{itemize}
 \end{itemize}		

 Debianの勉強会ということで究極的には参加者全員がDebian Packageをがりがり
 と作るスーパーハッカーになった姿を妄想しています。情報の共有・活用を通し
 て Debianの今後の能動的な展開への土台として、「場」としての空間を提供す
 るのが目的です。

\end{multicols}

\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\begin{multicols}{2}
\tableofcontents
\end{multicols}
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{事前課題}{上川 純一}

今回の事前課題は以下です:
\begin{enumerate}
 \item xxx
\end{enumerate}
この課題に対して提出いただいた内容は以下です。
\begin{multicols}{2}
{\small
% \input{image201102/prework.tex}
}
\end{multicols}

\dancersection{最近のDebian関連のミーティング報告}{上川純一}
\subsection{東京エリアDebian勉強会75回目報告}

% (query-replace-regexp "<.*?>" "")
% (query-replace-regexp "^[	 ]\+" "")



\dancersection{Debian Trivia Quiz}{上川 純一}

ところで、みなさん Debian 関連の話題においついていますか？Debian関連の話
題はメーリングリストをよんでいると追跡できます。ただよんでいるだけではは
りあいがないので、理解度のテストをします。特に一人だけでは意味がわからな
いところもあるかも知れません。みんなで一緒に読んでみましょう。

今回の出題範囲は\url{debian-devel-announce@lists.deban.org} や \url{debian-devel@lists.deban.org}に投稿された
内容とDebian Project Newsからです。

\begin{multicols}{2}
% \input{image201101/quiz.tex}
\end{multicols}

%-------------------------------------------------------------------------------
\dancersection{Apache2 のモジュールをつくってみた}{上川純一}
%-------------------------------------------------------------------------------
\index{apache}

Apache httpd というウェブサーバがあります。おそらく定番と言われるウェブ
サーバで、多くの人が利用していると思います。ウェブサーバとして多くの機能
を提供しているApacheですが、モジュールという仕組みで機能拡張出きるように
なっています。
今回はApacheモジュールを作ってみることにします。

\subsection{Apacheモジュールをつくりたいとき}

Apacheモジュールが作りたいときはどういうときでしょうか。
作りたいと思ったときがつくりどき。

Apacheモジュールでできることはどういうことでしょうか。Apacheの受け取る入
力(HTTP Request)から出力(HTTP Response)のほぼ任意の場所にフックとして割り
込むことができて、入出力のデータを加工することが可能です。

\subsection{Debian の Apache パッケージの構成}

ところで、httpd と Debian apache2 はどれくらい違うかご存知でしょうか。

Debian パッケージのREADME.Debian を見てみましょう。
\cite{Apache2ReadmeDebian}

ざっと眺めただけでも以下の点で特徴があります。

\begin{itemize}
 \item  apache2コマンドが環境変数に依存している。
 \item  apache2ctl / /etc/init.d/apache2 を利用しないと起動とかできない。
 \item  設定ファイルの配置が全然違う。
 \item  a2enmod / a2dismod コマンドが追加されている。
\end{itemize}

\subsection{Apacheモジュールの作成}

普通のApacheモジュールの作成の流れをみてみましょう。

\subsubsection{テンプレート生成}

apxs2 コマンドを利用してテンプレートを作成します。
モジュール名でディレクトリが作成されます。

\begin{commandline}
$ apxs2 -g -n dancerqps
$ cd dancerqps
$ ls 
$ ls
Makefile  mod_dancerqps.c  modules.mk
\end{commandline}

\subsubsection{ソースコード編集}

ソースコードを編集しましょう。この場合、自動で生成された
\url{mod_dancerqps.c}がメインのモジュールソースコードです。

まず一番下に一番重要な構造が定義されています。ここで重要なのは
\verb!dancerqps_register_hooks! を登録しているところでしょうか。

\begin{commandline}
module AP_MODULE_DECLARE_DATA dancerqps_module = {
    STANDARD20_MODULE_STUFF,
    NULL,                  /* create per-dir    config structures */
    NULL,                  /* merge  per-dir    config structures */
    NULL,                  /* create per-server config structures */
    NULL,                  /* merge  per-server config structures */
    NULL,                  /* table of config file commands       */
    dancerqps_register_hooks  /* register hooks                      */
};
\end{commandline}


\verb!dancerqps_register_hooks!で実際にフックの登録を行います。
ここでは、アウトプットフィルタを登録しています。
\begin{commandline}
static void dancerqps_register_hooks(apr_pool_t *p) {
  ap_register_output_filter(dancerqps_name, dancerqps_filter,
			    NULL, AP_FTYPE_RESOURCE);
}
\end{commandline}

そして、実際に各リクエストのアウトプットに対して実効するフィルタのコード
を書きます。

\begin{commandline}
static apr_status_t dancerqps_filter(ap_filter_t *f, apr_bucket_brigade *bb) {
  /* ここでなにか処理をする */
  ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, f->r,
		"dancerqps processing was here!");
  return ap_pass_brigade(f->next, bb);
}
\end{commandline}

\subsubsection{モジュールのファイルインストール}

モジュールをビルドしてインストールする一連の手順をしてくれるコマンドがあ
ります。

\begin{commandline}
$ sudo apxs2 -c -i mod_dancerqps.c
\end{commandline}

\subsubsection{モジュールを有効にする}

apxs2 コマンドでモジュールを有効にする方法は a2enmodなどのコマンドの存在
を無視しているようなのでa2enmodなどと整合性のとれるような方法をとります。

\subsubsubsection{Debian way 1}

めんどくさい方法だけどシステム運用者としては便利かもしれない方法。
a2enmodとかができるよ。

\subsubsubsection{Debian way 2}

デフォルトでは空のファイルだけど、/etc/apache2/httpd.conf に書き込むとその設定が有効になるよ。

\subsubsubsection{Debian的な方法から乖離しているっぽい方法}

apache をコマンドラインから設定ファイルを指定して起動することができます。
DebianのApacheは環境変数を設定しないと直接は起動できなくなっているので、
面倒な手続きが必要になります。


\begin{thebibliography}{}
 \bibitem{Apache2ReadmeDebian} \url{/usr/share/doc/apache2.2-common/README.Debian.gz}
\end{thebibliography}


\printindex

\cleartooddpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule

\end{document}
