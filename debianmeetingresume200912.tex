%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。


%     Tokyo Debian Meeting resources
%     Copyright (C) 2009 Junichi Uekawa

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image200812; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2009}
\newcommand{\debmtgmonth}{12}
\newcommand{\debmtgdate}{12}
\newcommand{\debmtgnumber}{59}

\begin{document}

\begin{titlepage}
\thispagestyle{empty}

% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料

\hspace*{-2.4cm}
\includegraphics[width=210mm]{image200801/2008title.eps}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

\end{titlepage}


\dancersection{Introduction}{上川 純一}

\begin{multicols}{2}
 
 
 今月のDebian勉強会へようこそ。これからDebianの世界にあしを踏み入れると
 いう方も、すでにどっぷりとつかっているという方も、月に一回Debianについ
 て語りませんか？

 Debian勉強会の目的は下記です。

 \begin{itemize}
 \item \underline{Debian Developer} (開発者)の育成。
 \item 日本語での「\underline{開発に関する情報}」を整理してまとめ、アップデートする。
 \item \underline{場}の提供。
 \begin{itemize}
  \item 普段ばらばらな場所にいる人々が face-to-face で出会える場を提供
	する。
  \item Debian のためになることを語る場を提供する。
  \item Debianについて語る場を提供する。
 \end{itemize}
 \end{itemize}		

 Debianの勉強会ということで究極的には参加者全員がDebian Packageをがりがり
 と作るスーパーハッカーになった姿を妄想しています。情報の共有・活用を通し
 て Debianの今後の能動的な展開への土台として、「場」としての空間を提供す
 るのが目的です。

 2009年の計画は仮です。

 \begin{enumerate}
  \item 新年の企画 (アンサンブル荻窪開催)
  \item OSC Tokyo
  \item VAIO P インストール記録、
	カーネル読書会　ディストリビューション大集合(小林さん)(東京大学?)
  \item Git Handson (岩松)(あんさんぶる荻窪?)
  \item 家Debianサーバ vs 職場のネットワーク(千代田区都立図書館?\footnote{\url{http://www.library.chiyoda.tokyo.jp/}})
  \item Asterisk (東京大学?)
  \item スペインにて開催
  \item Debconf報告会
  \item OSC Fall?
  \item udev + HAL(岩松さん)
  \item 3D graphics 開発（藤沢さん） 
  \item Debian サーバ+VMware + 各種OS、
	他の仮想化ツール(vserver etc.)、
	忘年会
 \end{enumerate}

 会場候補としては下記があります:

 \begin{itemize}
  \item 大学
  \item 恵比寿SGIホール
  \item Googleオフィス
  \item 公民館(あんさんぶる荻窪等)
  \item 都立会議室(無線LAN)
  \item 健保の施設
 \end{itemize}

\end{multicols}

\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\tableofcontents
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{事前課題}{上川 純一}

今回の事前課題は以下のうちどれかです:

\begin{enumerate}
 \item ...
\end{enumerate}

この課題に対して提出いただいた内容は以下です。

%\input{image200912/prework.tex}

\dancersection{最近のDebian関連のミーティング報告}{まえだこうへい}
\subsection{東京エリアDebian勉強会58回目報告}
% (query-replace-regexp "<.*?>" "")
% (query-replace-regexp "^[	 ]\+" "")

東京オリンピック青少年総合センターで開催しました。参加者は、あけどさん、
なかおさん、吉田さん、やまねさん、山本さん、本庄さん、日比野さん、あらき
さん、高橋(emasaka)さん、つじたさん、岩松さん、まえだの12名でした。

Debian での数学ことはじめとして、gnuplot, Octave, Rの入門についての話を
まえだが行いました。gnuplot と R でのプロットのやり方と、R と Octave の
それぞれの拡張パッケージである CRAN, Octave-Forge からの Debian パッケー
ジ化するためのポイントポイントについて議論できたので、参加された方は
gnuplot と Rを自習して使えるようになると同時に、Octave-Forge と CRAN の
拡張パッケージをガンガン Debian パッケージにするべく ITP していることで
しょう。

もう一つのネタとして岩松さんが Debian auto-builder ネットワークについての
話をされました。Debian を支える重要なシステムであるにも関わらず、このシ
ステムを理解している DD も少ないとのことなので、とても意義のあるセッショ
ンでした。特にドキュメント化されていない loop-depends の対応の話には溜飲
を下ろした人が多かったのではないかと思います。今回の話で、auto-builder
に興味を持ったヒトは、ぜひ Debian/SH4のポーティングに参加しましょう。

宴会は、石臼挽きたて蕎麦と酒肴の店 心粋 参宮橋店にて。Rolf さんが宴会か
ら合流され、宴会場でのキーサインパーティが行われました。

\dancersection{各種イベント開催実績}{上川 純一}
\label{sec:debmtg2009results}
\index{debianjp@Debian JP} 
\index{とうきょうえりあ@東京エリアDebian勉強会}

今月で6年目のDebian勉強会が終了しました。
Debian Developerになった人がいたり変化もみられ、私生活の面でも
結婚したメンバーが多数いたり、
転職したメンバーがいたり、当時と所属が変わっていないメンバーのほうがめずらしくなってきました。


Debian 開発者の育成を目的として開催してきた東京エリアDebian勉強会も今回
で5年目が終了しました。
事前課題事後課題を設定しており、予習復習を必要だとうたっている勉強会です
が、実際にどれくらい実施されているのか、まずは事前課題の実施実績を確認し
てみましょう。
\fgref{fig:attendandprepostwork}です。
各月の数字は\tbref{tab:attendandprepostwork}です。

% sqlite> .separator ' & ' 
% sqlite>  select year, month, sum(type='attendance'), sum(type='prework'), sum(type='postwork') from attend group by year,month order by year, month ;

\begin{figure}[ht]
 \includegraphics[width=1\hsize]{image200812/memberanalysis/attend.png}
\caption{東京エリアDebian勉強会事前課題・事後課題提出実績(12ヶ月移動平均)}\label{fig:attendandprepostwork}
\end{figure}

\begin{table}[ht]
 \caption{東京エリアDebian勉強会事前課題・事後課題提出実績}\label{tab:attendandprepostwork}
\begin{minipage}{0.5\hsize}
\begin{tabular}{|l|r|r|r|r|}
 \hline
   年&月 & 参加人数 & 事前課題　& 事後課題 \\
 \hline
 2005 & 1 & 20 & 0 & 3 \\
 2005 & 2 & 15 & 12 & 6 \\
 2005 & 3 & 10 & 8 & 4 \\
 2005 & 4 & 9 & 6 & 2 \\
 2005 & 5 & 6 & 6 & 4\\
 2005 & 6 & 13 & 10 & 5\\
 2005 & 7 & 12 & 7 & 4\\
 2005 & 8 & 9 & 6 & 2\\
 2005 & 9 & 14 & 7 & 4\\
 2005 & 10 & 10 & 5 & 3\\
 2005 & 11 & 7 & 6 & 3\\
 2005 & 12 & 8 & 5 & 3\\
 2006 & 1 & 9 & 7 & 3\\
 2006 & 2 & 8 & 4 & 2\\
 2006 & 3 & 6 & 0 & 0\\
 2006 & 4 & 15 & 11 & 6\\
 2006 & 5 & 7 & 2 & 1\\
 2006 & 6 & 14 & 9 & 4\\
 2006 & 7 & 2 & 2 & 4\\
 2006 & 8 & 17 & 9 & 7\\
 2006 & 9 & 12 & 8 & 5\\
 2006 & 10 & 22 & 15 & 7\\
 2006 & 11 & 3 & 12 & 7\\
 2006 & 12 & 15 & 7 & 4\\
\end{tabular}
\end{minipage}
\begin{minipage}{0.5\hsize}
\begin{tabular}{|l|r|r|r|r|}
 \hline
   年&月 & 参加人数 & 事前課題　& 事後課題 \\
 \hline
 2007 & 1 & 15 & 6 & 4\\
 2007 & 2 & 13 & 8 & 4\\
 2007 & 3 & 0 & 6 & 16\\
 2007 & 4 & 18 & 14 & 6\\
 2007 & 5 & 21 & 14 & 7\\
 2007 & 6 & 1 & 0 & 1\\
 2007 & 7 & 18 & 12 & 3\\
 2007 & 8 & 25 & 18 & 5\\
 2007 & 9 & 0 & 7 & 5\\
 2007 & 10 & 10 & 1 & 6\\
 2007 & 11 & 19 & 10 & 6\\
 2007 & 12 & 11 & 11 & 4\\
 2008 & 1 & 22 & 11 & 4\\
 2008 & 2 & 0 & 1 & 0\\
 2008 & 3 & 37 & 27 & 11\\
 2008 & 4 & 17 & 13 & 3\\
 2008 & 5 & 20 & 14 & 3\\
 2008 & 6 & 10 & 8 & 2\\
 2008 & 7 & 17 & 12 & 4\\
 2008 & 8 & 10 & 0 & 4\\
 2008 & 9 & 17 & 13 & 5\\
 2008 & 10 & 11 & 0 & 7\\
 2008 & 11 & 22 & 14 & 6\\
\end{tabular}
\end{minipage}

\end{table}

昨年からは勉強会は東京と関西の両方で開催されるようになっています。
東京エリアDebian勉強会と、関西Debian勉強会について簡単に出席数で実績をみてみましょう。
まず、東京についてグラフにしてみると\fgref{fig:peoplechart}になります。

\begin{figure}[h]
 \begin{center}
  \includegraphics[width=1\hsize]{image200812/people-chart.png}
  \includegraphics[width=1\hsize]{image200812/serialized.png}
 \end{center}
\caption{東京エリアDebian勉強会の参加人数推移}
\label{fig:peoplechart}
\end{figure}


具体的な数字と、トピックを見てみましょう。
 
\begin{table}[ht]
\begin{minipage}{0.5\hsize}
 \caption{東京エリアDebian勉強会参加人数(2005年)}\label{tab:count}
 \begin{center}
  \begin{tabular}{|l|c|p{10em}|}
 \hline
   & 人数 & 内容 \\
 \hline
   2005年1月 & 21 & 秘密\\
   2005年2月 & 10 & debhelper1\\
   2005年3月 & 8 &  (早朝) debhelper2、social contract\\
   2005年4月 & 6 & debhelper3\\
   2005年5月 & 8 & DFSG、dpkg-cross、lintian/linda\\
   2005年6月 & 12 & alternatives、d-i\\
   2005年7月 & 12 & toolchain、dpatch\\
   2005年8月 & 7 & Debconf参加報告、ITPからアップロードまで\\
   2005年9月 & 14 & debconf\\
   2005年10月 & 9 & apt-listbugs、バグレポート、debconf翻訳、debbugs\\
   2005年11月 & 8 & DWN翻訳フロー、statoverride\\
   2005年12月 & 8 & 忘年会\\
 \hline
  \end{tabular}
 \end{center}
\end{minipage}
\begin{minipage}{0.5\hsize}
 \caption{東京エリアDebian勉強会参加人数(2006年)}\label{tab:count2006}
 \begin{center}
  \begin{tabular}{|l|c|p{10em}|}
 \hline
 & 参加人数 & 内容\\
 \hline
 2006年1月 & 8 & policy、Debian勉強会でやりたいこと\\
 2006年2月 & 7 & policy、multimedia \\
 2006年3月 & 30 & OSC: debian勉強会、sid \\
 2006年4月 & 15 & policy、\LaTeX{} \\
 2006年5月 & 6 & mexico \\
 2006年6月 & 16 & debconf、cowdancer\\
 2006年7月 & 40 & OSC-Do: MacBook Debian \\
 2006年8月 & 17 & 13執念 \\
 2006年9月 & 12 & 翻訳、Debian-specific、oprofile \\
 2006年10月 & 23 & network、i18n会議、Flash、apt \\
 2006年11月 & 20 & 関西開催： bug、sid、packaging \\
 2006年12月 & 14 & 忘年会 \\
 \hline
  \end{tabular}
 \end{center}
\end{minipage}
 \end{table}

\begin{table}[t]
\begin{minipage}{0.5\hsize}
 \caption{東京エリアDebian勉強会参加人数(2007年)}\label{tab:count2007}
 \begin{center}
  \begin{tabular}{|l|c|p{10em}|}
 \hline
 & 参加人数 & 内容\\
 \hline
2007年1月 & 15 & 一年を企画する \\
2007年2月 & 13 & dbs, dpatch\\ 
2007年3月 & 80 & OSC仮想化 \\
2007年4月 & 19 & quilt, darcs, git\\
2007年5月 & 23 & etch, pbuilder, superh \\   
2007年6月 & 4 & エジンバラ開催：Debconf7 実況中継 \\
2007年7月 & 18 & Debconf7 参加報告\\
2007年8月 & 25 & cdn.debian.or.jp \\   
2007年9月 & 14 & exim \\   
2007年10月 & 30 & OSC Tokyo/Fall(CUPS) \\   
2007年11月 & 19 & live-helper, tomoyo linux kernel patch, server\\
2007年12月 & 11 & 忘年会\\
 \hline
  \end{tabular}
 \end{center}
\end{minipage}
\begin{minipage}{0.5\hsize}
 \caption{東京エリアDebian勉強会参加人数(2008年)}\label{tab:count2008}
 \begin{center}
  \begin{tabular}{|l|c|p{10em}|}
 \hline
 & 参加人数 & 内容\\
 \hline
2008年1月 & 23 & 一年を企画する \\
2008年2月29+1日 & 36 & OSC  \\
2008年3月 & 37 & データだけのパッケージ、ライセンス \\
2008年4月 & 17 & バイナリパッケージ \\
2008年5月 & 20 & 複数のバイナリパッケージ \\
2008年6月 & 10 & debhelper \\
2008年7月 & 17 & Linux kernel patch / module パッケージ \\
2008年8月 & 10 & Debconf IRC会議とDebian温泉 \\
2008年9月 & 17 & po4a, 「Debian メンテナのお仕事」 \\
2008年10月 & 11? & OSC Tokyo/Fall \\
2008年11月 & 17 & 「その場で勉強会資料を作成しちゃえ」 Debian を使った \LaTeX{} 原稿作成合宿 \\
2008年12月 & ? & 忘年会 \\
 \hline
  \end{tabular}
 \end{center}
\end{minipage}
\end{table}

それでは、関西Debian勉強会の出席状況を確認してみましょう。
グラフで見ると\fgref{fig:kansaipeoplechart}になります。
表で見ると\tbref{tab:count2007kansai}

\begin{figure}[h]
 \begin{center}
  \includegraphics[width=1\hsize]{image200812/kansai.png}
 \end{center}
\caption{関西の参加人数推移}
\label{fig:kansaipeoplechart}
\end{figure}


\begin{table}
\begin{minipage}{0.5\hsize}
 \caption{関西Debian勉強会参加人数(2007年)}\label{tab:count2007kansai}
 \begin{center}
  \begin{tabular}{|l|c|p{10em}|}
 \hline
 & 参加人数 & 内容 \\
 \hline
2007年3月 & 19 & 開催にあたり \\
2007年4月 & 25 & goodbye、youtube、プロジェクトトラッカー\\
2007年6月 & 23 & 社会契約、テーマ、debian/rules、bugreport\\
2007年7月 & 20前後 & OSC-Kansai \\
2007年8月 & 20 & Inkscape、patch、dpatch\\
2007年9月 & 16 & ライブラリ、翻訳、debtorrent\\
2007年10月 & 22& 日本語入力、SPAMフィルタ\\
2007年11月 & 20前後 & KOF \\   
2007年12月 & 15& 忘年会、iPod touch\\   
 \hline
  \end{tabular}
 \end{center}
\end{minipage}
\begin{minipage}{0.5\hsize}
 \caption{関西Debian勉強会参加人数(2008年)}\label{tab:count2008kansai}
 \begin{center}
  \begin{tabular}{|l|c|p{10em}|}
 \hline
 & 参加人数 & 内容 \\
 \hline
2008年2月 & 20 & PC Cluster, GIS, \TeX \\
2008年3月 & 23 & bug report, developer corner, GPG \\
2008年4月 & 24 & coLinux, Debian GNU/kFreeBSD, sid \\
2008年5月 & 25  & ipv6, emacs, ustream.tv\\
2008年6月 & 20  & pbuilder, hotplug, ssl\\
2008年8月 & 13  & coLinux \\
2008年9月 & 17  & debian mentors, ubiquity, DFSG\\
2008年10月 & 11  & cdbs,cdn.debian.or.jp \\
2008年11月 & 35  & KOF \\
2008年12月 & ?  & \\
 \hline
  \end{tabular}
 \end{center}
\end{minipage}
\end{table}

\dancersection{2009年を振り返ってみる}{上川 純一}

\subsection{最近のトレンドと今後の推移}

最近どんなことが
あって、これからどういうことがあるでしょうか。
みんなで予想してみましょう。

{\footnotesize
\begin{tabular}[t]{|p{8em}|p{8em}|p{12em}|p{8em}|p{8em}|}
\hline
2007 &2008 &2009 &2010 & 2011 \\
\hline
%2007
VT・AMD-V(仮想化技術)が普及(ML115!)、

黒箱(ARM)、
OpenBlocks(PPC?)、
iPhone登場、 
HSDPA 月額5000円くらいに、
google mobile、

VISTAリリース、 
Leopardリリース、 

GPL3.0、
メモリ2Gがコモディティーに、
SparcT2がオープン、 
ニコニコ動画、
& 
%2008
python 3.0
ruby 1.9

wine 1.0, wine64 登場

RoR 2.0 登場で普及に

4コア・64bit のCPUがデスクトップに普及、
Core2Quad 値下げ。

ニコニコ動画1000万ユーザ突破、
初音ミクブームに

地デジ関連のPC製品の普及

勉強会の普及(楽天とか)

公衆無線LAN (wireless gate)

携帯電話の売上が落ちる、
iPhone, Android 登場、
emobile 100円PC抱きあわせ
(eeePC, Dell mini9)
Zaurus販売終了。

Chumby 発売。

サーバの仮想化 ESXi・シンクライアント

MacBook Air 発売、
無線 802.11n が実機に

SystemZ10 発表

世界経済の崩壊(IT投資緊縮財政、職を失う人が増加)

FreeBSD 7 (malloc, ZFS ?)

Debian次世代育成計画始動

Debian Maintainer 制度始動

セキュリティー関連(OpenSSL 事件、DNS事件)

クラウド関連が流行?

Nintendo DSi

&
%2009

tile window manager boom ?

Lenny リリース予定

Debian 合同結婚式

デスクトップ、8コア、4GB? 8GB?

ノートパソコン、2コア、2GB?

Linux が標準インストールのPC。

SSD の値段と容量がこなれる?
HDDがなくなる?高くなる?

ファイルシステムかわる?

ipv6 使えるようになってる?

Bluray が普及?

DL禁止法? torrent に逆風?

&
%2010

消費税上昇に伴う繁忙期

クラウドにより、単純なホスティング業者がつづかない?
一部は自社でもつようになる?

Squeezeリリース

USB 3.0 搭載、wireless USB vs Bluetooth ?

組み込みCPUはAtomに統一?Armは残ってる?

kFreeBSD オフィシャルアーキテクチャに

ruby 2.0 リリース?

&
%2011

 \\

\hline
\end{tabular}

}

\clearpage

\dancersection{lxc }{まえだこうへい}
\label{sec:lxc}
\index{仮想化} 

Debian 勉強会に参加されている面々は、そろそろ Xen とか KVM とか飽きてき
た向きが多いかと思います。そこで、最近、Linux Kernel に新たにマージされ
たlxc という仮想化技術について紹介します。

\subsection{はじめに}
\subsubsection{lxc の概要}
lxc\footnote{\url{http://lxc.sourceforge.net/}} は、正式名称を Linux
Containers と言い、コンテナ自体が稼働するためのカーネルの機能と、コンテ
ナを管理するためのとユーザツールから構成されます。lxc は kernel 2.6.29
で完全にマージされ、フル機能が使えるようになっています。kernel 2.6.29 よ
り前のカーネルでは、kernel 2.6.27 以降であればパッチを当てれば使うことが
できます。

lxc は GPL2 の元、公開されていて、開発およびメンテナンスは、Daniel
Lezcano 氏が実質一人で行っています。

Debian では、Squeeze/Sid からパッケージ化されており、一つ前の最新版
\footnote{2009年11月27日現在、0.6.3。}がパッケージとなっています。

\subsubsection{他のコンテナ型仮想化技術との比較}

コンテナ型の仮想化技術というと有名なのは、Solaris Containers や FreeBSD
jailがありますが、Linux では Linux-VServer, OpenVZ\footnote{Parallels
Virtuozzo ContainersのOSS版。}などがあります。いずれも既に使ったことがあ
る方が多いのではないのでしょうか。

lxc では、大きく分類してシステムコンテナと、アプリケーションコンテナの2
つがあります。前者は、いわゆるOSの仮想化です。init から起動して、仮想OS
の空間を提供します。後者は、chroot によるアプリケーションの分離に近いで
す。通常は、単一アプリケーションを分離するだけなので、とても軽くシンプル
なのが特徴です。

\subsection{導入してみる}
\subsubsection{ソースコードを取得する}
ユーザスペースのツールは、SourceForge から取得することができます。
開発は git で行われており、git リポジトリから取得します。

\begin{commandline}
$ git-clone git://lxc.git.sourceforge.net/gitroot/lxc/lxc
\end{commandline}

Debian では前述のとおり、Squeeze/Sid でパッケージになっている
\footnote{\url{http://packages.debian.org/search?keywords=lxc&searchon=names&exact=1&suite=all&section=all}}
ので、最新版である必要がなければ、この手順は飛ばしても良いでしょう。

\subsubsection{カーネルオプションを有効にする}
lxc の機能をフルに活用するには以下のカーネルオプションが有効になっている
必要があります。

\begin{commandline}
* General
  * Control Group support
    -> namespace cgroup subsystem
    -> cpuset support
    -> Group CPU scheduler
    -> control group freeze subsystem
    -> Basis for grouping tasks (Control Groups)
    -> Simple CPU accounting
    -> Resource counters
    -> Memory resource controllers for Control Groups
    -> Namespace support
    -> UTS namespace
    -> IPC namespace
    -> User namespace
    -> Pid namespace
  * Network support
    -> Networking options
      -> Network namespace support
\end{commandline}

これらが有効になっているかを確認するには、lxcのソースツリーに含まれている、
src/lxc/lxc-checkconfig.in というシェルスクリプトを実行すれば、現在起動
中のカーネルでどのカーネルオプションが無効になっているかをチェックできま
す。

また、Debian パッケージでは、/usr/bin/lxc-checkconfig としてインストール
されています。Squeeze/Sid で Debian のカーネルパッケージ\footnote{2009年
11月27日現在、linux-image-2.6.30-2-amd64}を使っている環境で確認すると以
下の結果になります。Cgroup memory controller のみが無効になっているよう
です。

\begin{commandline}
$ lxc-checkconfig 
Kernel config /proc/config.gz not found, looking in other places...
Found kernel config file /boot/config-2.6.30-2-amd64
--- Namespaces ---
Namespaces: enabled
Utsname namespace: enabled
Ipc namespace: enabled
Pid namespace: enabled
User namespace: enabled
Network namespace: enabled
Multiple /dev/pts instances: enabled

--- Control groups ---
Cgroup: enabled
Cgroup namespace: enabled
Cgroup device: enabled
Cgroup sched: enabled
Cgroup cpu account: enabled
Cgroup memory controller: disabled
Cgroup cpuset: enabled

--- Misc ---
Veth pair device: enabled
Macvlan: enabled
File capabilities: enabled
\end{commandline}

\subsubsection{Debian でのインストール}

ここから先は、Squeeze/Sid でパッケージを使うことを前提として話を進めます。
先ほど、フル機能を使うのに必要なカーネルオプションについては確認しました。
では、実際に Debian で lxc を使うために必要なパッケージは何かというと
lxc だけです。

\begin{commandline}
$ sudo apt-get install lxc
\end{commandline}

以上です、としても良いですが、実際のところ、lxc パッケージをインストール
しただけでは、コンテナだけを起動させるだけで終わらせるのであれば良いかも
しれませんが、実際に lxc を活用しようと考えているなら使い物にはならない
でしょう。次に挙げる他のパッケージをインストールしておく必要があります。

\begin{itemize}
 \item iproute : コンテナのネットワーク設定を行うため。
 \item debootstrap : コンテナのイメージを作成するため。
\end{itemize}

\subsubsection{ネットワークの設定}
\subsubsubsection{\textbf{ブリッジの設定}}

必要なパッケージをインストールしたら、まずはブリッジの設定を行う必要があります。
/etc/network/interfaces で直接ブリッジの設定をすれば良いと思いますが。シェ
ルスクリプトを用意して、それをpost-up で実行させれば良いでしょう。

\begin{figure}
\begin{commandline}
#!/bin/sh

brctl addbr br0                             <- ブリッジデバイスの追加
brctl setfd br0                             <- ブリッジデバイス br0 の設定
ifconfig br0 192.168.0.1 promisc up
brctl addif br0 eth0
ifconfig eth0 0.0.0.0 up
route add -net default gw 192.168.0.254 br0 <- ホスト OS のゲートウェイ
\end{commandline}
\caption{ブリッジ設定用のシェルスクリプト}
\end{figure}

interfaces は以下のように設定します。
\begin{commandline}
$ cat /etc/network/interfaces 
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto eth0
allow-hotplug eth0
iface eth0 inet static
	address 192.168.0.101
	netmask 255.255.255.0
	broadcast 192.168.0.255
	pre-up  /etc/init.d/iptables start
	post-up /etc/network/if-up.d/brctl.sh
\end{commandline}

以上のあと、ブリッジの設定がきちんとされているか確認してみると、以下のよ
うになります。
\begin{commandline}
$ /usr/sbin/brctl show
bridge name	bridge id		STP enabled	interfaces
br0		8000.00wwwwyyyyxxno		eth0
							veth0_14820
							veth0_15932
							veth0_17164
\end{commandline}
ちなみに``veth0\_''の後ろの数字は、コンテナで起動した init プロセスのプロセスID
です。


\subsubsubsection{\textbf{IP フォワードと NAT の設定}}

ホスト OS とコンテナ、コンテナとホスト OS の外部のネットワーク、コンテナ
間での通信は、上記の設定だけでなく、IP フォワードや NAT の設定をする必要
があります。例えば、コンテナ起動後、ホスト OS から ssh でログインするの
にも、IP フォワードが必要となります。

\begin{commandline}
$ sudo bash -c ``echo 1 > /proc/sys/net/ipv4/ip_forward''
\end{commandline}

IP フォワードを設定するととで、ホスト OS の外部のネットワークへの通信や、
コンテナ同士の通信も行えるようにはなります。\footnote{同じブロードキャス
トドメインの場合。}

一方、ホスト OS の外部ネットワークからはこのままではアクセスできません。
アクセスを許可するには、ホスト OS でポートフォワーディングや、宛先 NATな
どを行う必要があります。ポートフォワーディングを行うのであれば、以下のよ
うなルールを設定します。

\begin{commandline}
$IPTABLES -t nat -A PREROUTING -d 192.168.0.1 -p tcp --dport 80 -i br0 -j DNAT --to 192.168.0.101
$IPTABLES -t nat -A PREROUTING -d 192.168.0.1 -p tcp --dport 5984 -i br0 -j DNAT --to 192.168.0.102
\end{commandline}

ここでの設定は、デフォルトポリシーが全て ACCEPTであることを前提にしてい
ますが、実際には当然 DROP にすると思いますので、FORWARD のルールなども定
義する必要があります。Netfilter のルールとIPフォワーディングの許可はスク
リプトにして、/etc/network/interface で pre-up として設定しておくと良い
でしょう。

なお、FORWARD チェインのデフォルトポリシーが ACCEPT である場合は問題あり
ませんが、DROP や REJECT に設定してある場合は、コンテナ同士での通信はで
きません。FORWARD チェインでの ACCEPT ルールが必要になります。

\subsubsection{システムコンテナの作成}

では、システムコンテナのイメージを作成してみます。lxc のパッケージに含まれる、
/usr/share/doc/lxc/examples/lxc-debian.gz を使って、Debian のシステムコ
ンテナを作成します。

まず、このファイルをホームディレクトリなどで伸張します。
\begin{commandline}
$ gzip -dc /usr/share/doc/lxc/examples/lxc-debian.gz > ~/lxc-debian
\end{commandline}

次に、cgroup ファイルシステムをマウントします。/etc/fstab に下記一行を追
記します。マウントポイントは任意の場所で構いません。

\begin{commandline}
cgroup  /var/local/cgroup  cgroup  defaults  0  0
\end{commandline}

追記したら、マウントポイントのディレクトリを作成し、マウントします。

\begin{commandline}
$ sudo mkdir /var/local/cgroup
$ sudo mount cgroup
\end{commandline}

それでは、先ほどの lxc-debian スクリプトを使ってコンテナイメージを作成し
ます。このスクリプトでは debootstrap を使ってイメージが作成されますが、
ディストリビューションは lenny になっています。前述した通り本環境は
Squeeze/Sid ですので、コンテナも Squeeze/Sid の方が良ければ、コンテナイ
メージを作成する前に予めスクリプトを書き換えておく必要があります。
また、パッケージも、デフォルトで apache2 がインストールされたり、一方、
sudo や vi, dig コマンドが無かったりするので、そのままインストールすると
不便であったりするので、予めインストールするパッケージの指定を変更してお
く必要があります。lxc-debian スクリプト内の debootstrap コマンドの
\verb/--include/オプションでパッケージの指定は変更できます。
また、sshd の設定や、ネットワークの設定も予め設定しておくと便利です。以
下、変更済みファイルとの diff の結果を掲載しておきます。

\begin{commandline}
$ diff -u  a/lxc-debian b/lxc-debian 
--- a/lxc-debian	2009-11-30 21:22:59.000000000 +0900
+++ b/lxc-debian	2009-10-30 17:58:20.000000000 +0900
@@ -8,8 +8,8 @@
 MNTFILE=
 TMPMNTFILE=
 UTSNAME=
-IPV4="172.20.0.21"
-GATEWAY="172.20.0.1"
+IPV4="192.168.0.101"
+GATEWAY="192.168.0.1"
 MTU="1500"
 
 # These paths are within the container so do not need to obey configure prefixes
@@ -99,14 +99,14 @@
 SyslogFacility AUTH
 LogLevel INFO
 LoginGraceTime 120
-PermitRootLogin yes
+PermitRootLogin no
 StrictModes yes
 RSAAuthentication yes
 PubkeyAuthentication yes
 IgnoreRhosts yes
 RhostsRSAAuthentication no
 HostbasedAuthentication no
-PermitEmptyPasswords yes
+PermitEmptyPasswords no
 ChallengeResponseAuthentication no
 EOF
 }
@@ -259,8 +259,8 @@
 	        # download a mini debian into a cache
 		echo "Downloading debian minimal ..."
 		debootstrap --verbose --variant=minbase --arch=$ARCH \
-		    --include ifupdown,locales,libui-dialog-perl,dialog,apache2,netbase,net-tools,iproute,openssh-server \
-		    lenny $CACHE/partial-$ARCH http://ftp.debian.org/debian
+		    --include ifupdown,locales,libui-dialog-perl,dialog,sudo,vim-tiny,dnsutils,netbase,net-tools,iproute,openssh-server \
+		    sid $CACHE/partial-$ARCH http://cdn.debian.or.jp/debian
 		
 		RESULT=$?
 		if [ "$RESULT" != "0" ]; then
\end{commandline}

それでは、コンテナを作成します。コンテナを作成する場所は任意の場所にでき
ます。通常、lxc-debian スクリプトを実行を実行したディレクトリの下に
debianディレクトリを自動的に作成し、その下にコンテナイメージである
rootfs が作成されます。配置したいディレクトリが無ければ作成し、そのディ
レクトリへ移動し、\texttt{sudo lxc-debian create}を実行します。

\begin{commandline}
$ sudo mkdir /var/cache/lxc
$ cd /var/cache/lxc
$ sudo bash /home/kohei/lxc-debian create
What is the name for the container ? [debian] hoge                 <- コンテナの名前
What hostname do you wish for this container ? [hoge]              <- コンテナのホスト名
What IP address do you wish for this container ? [192.168.0.101] <- コンテナの IPアドレス
What is the gateway IP address ? [192.168.0.1]                 <- コンテナから見たデフォルトゲートウェイのアドレス
What is the MTU size ? [1500]
Specify the location of the rootfs [./rootfs.hoge]
Specify the location for an extra fstab file [(none)]
(snip)
Choose your architecture
1) amd64
2) i386
#? 1                                                               <- Core 2 Duo のマシンなのでアーキテクチャは amd64 を選択。
Architecture amd64 selected
Checking cache download ...Found.
Copying rootfs ...Done.
(snip)
update-rc.d: using dependency based boot sequencing
Done.

You can run your container with the 'lxc-start -n hoge'
\end{commandline}

これで、/var/cache/lxc/debian/rootfs.hoge という名前でコンテナイメージの
ディレクトリが作成され、ここに、debootstrap による Debian イメージのコピー
が作成されます。初めて \texttt{lxc-debian create} を実行すると、
debootstrap でダウンロードされるキャッシュイメージが、
/var/cache/lxc/debian/rootfs-architecture として作成されます。\footnote{今回は
amd64 を選択しているので、/var/cache/lxc/debian/rootfs-amd64 となります。}

コンテナ自体のメタ情報は、/var/lib/lxc ディレクトリのコンテナ名のディレ
クトリ以下にあります。ツリー表示すると以下のようになっています。

\begin{commandline}
$ tree hoge/
couchdb/
|-- cgroup
|-- config
|-- fstab
|-- init
|-- network
|   `-- veth0
|       |-- ifindex
|       |-- link
|       |-- mtu
|       |-- name
|       `-- up
|-- nsgroup -> /var/local/cgroup/hoge
|-- pts
|-- rootfs
|   `-- rootfs -> /var/cache/lxc/debian/rootfs.hoge
|-- state
|-- tty
`-- utsname

5 directories, 13 files
\end{commandline}

\subsubsection{システムコンテナの起動}

システムコンテナの起動の前に、やることがあります。コンテナイメージに、ロ
グイン可能なユーザアカウントを作成することと、/etc/hosts を書き換えるこ
とです。前者は、コンテナ作成後にそのまま起動させたのでは、ログインするこ
とができません。ホストOS 側と同じユーザアカウントで問題なければ、
/var/cache/lxc/debian/rootfs.hoge/etc/ディレクトリの下の、passwd,
shadow, group をホストのそれで上書きしておくと良いでしょう\footnote{今後
作成するコンテナ全てに共通して言えることなので、キャッシュイメージである、
/var/cache/lxc/debian/rootfs-amd64/etc/ディレクトリ以下を上書きしておい
た方が良いかもしれません。}。後者はコンテナ自身の名前解決の設定が目的で
す。現状では、コンテナの/etc/hosts は、一律、

\begin{commandline}
127.0.0.1	localhost
127.0.1.1	ホストOSのホスト名
\end{commandline}

となっており、上記の2行目が、/etc/hostname と異なるため、ユーザアカウン
トを作っても、ログイン時に名前解決で時間が掛かってしまいます。
ですので、予め、ホストOSのホスト名になっている部分をコンテナのホスト名に書き換えておく必要
があるわけです。\footnote{これは、lxc-debian スクリプト自体でコンテナの
ホスト名を書き換えるようにしておけば済む話だと思うんですけどね。}

上記の設定を終えたら、システムコンテナを起動します。
システムコンテナの起動は、\texttt{lxc-start} コマンドを使います。一つの
環境で複数のコンテナを起動できるので、コンテナ名の指定が必ず必要です。コ
ンテナ名の指定には、オプション\texttt{-n} を使います。

\begin{commandline}
$ sudo lxc-start -n hoge
\end{commandline}

このまま起動させると、現在のシェルでそのままコンテナのコンソールが表示さ
れます。ログインするにはそのままコンソールログインすれば良いでしょう。
バックグラウンドで起動させるには、\texttt{-d} オプションをつけます。

\begin{commandline}
$ sudo lxc-start -n hoge -d
\end{commandline}

KVM や Xen などのようにカーネルから起動させる訳ではなく、init プロセスか
ら起動させるので、起動完了までに要する時間はわずかです。

\subsection{コンテナのライフサイクル}

Linux コンテナのライフサイクルは他の仮想化技術と大きく異なるところはなく、
次の図の様になります。

\includegraphics[width=0.8\hsize]{image200912/lxc/lxc-lifecycle.eps}

この図での状態を遷移させるためのコマンド、つまりコンテナを管理するための
コマンドは以下の通りです。

\begin{enumerate}
 \item コンテナの起動
       \begin{itemize}
	\item lxc-start(システムコンテナ)
	\item lxc-execute(アプリケーションコンテナ)
       \end{itemize}
 \item コンテナの一時停止(lxc-freeze)
 \item コンテナの再開(lxc-unfreeze)
 \item コンテナの停止(lxc-stop)
 \item コンテナの廃棄(lxc-destroy)
 \item コンテナの再起動(lxc-restart)
\end{enumerate}

\subsection{lxc の仕組みを見てみる}
\subsubsection{リソースを制御する}

lxc では、コンテナのリソースを制御するために、cgroup というカーネルの機
能を使っています。cgroup とは、Control group の略です。Linux Kernel では
これが出てくるまでは、プロセス単位でのリソース制御を行っていました。
cgroup を使うと、〜〜〜。lxc では、\texttt{lxc-cgroup} コマンドを用い、
コンテナのリソースの設定を表示したり、値をセットすることができます。

\subsection{libvirtで制御する}
lxc は、libvirt で既にサポートされています。libvirt は C 言語で書かれた、
様々な仮想化技術を抽象化して管理するためのライブラリで、lxc 以外には、
QEMU, KVM, Xen, OpenVZ, VirtualBoxがサポートされています。libvirt はまた
いろいろなプログラム言語に対するバインディングを提供しています。C 言語以
外に、Perl, Ruby, Python, OCaml から利用できます。libvirt 自体でも、対話
形式でも使える ゲスト OS やコンテナの管理ツール virsh があります。ここでは
virsh を使って、lxc のコンテナの作成から起動、停止 について見てみます。

まず、パッケージとしては、libvirt-bin, halをインストールします。
\footnote{本資料を作成している途中の段階では、libvirt-bin のバージョンは
0.7.2-3で、このバージョンでは、hal が Depends に指定されていなかっ
たため、libvirtd が起動しないバグがありましたが、0.7.2-4 で修正されてい
ます。}

\subsection{まとめ}
\subsection{参考文献}

\begin{itemize}
\item LXC\\
      \url{http://lxc.sourceforge.net/lxc.html}

\item LXC: Linux コンテナツール ; IBM developer Works Japan\\
      \url{http://www.ibm.com/developerworks/jp/linux/library/l-lxc-containers/}\footnote{
      今年の2月の記事ですが内容が若干古く、現在存在しないコマンドもある
      ので要注意。}
\end{itemize}

%\printindex

\cleartooddpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\ \\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule


\end{document}
