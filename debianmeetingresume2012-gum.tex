%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Tokyo Debian Meeting resources
%     Copyright (C) 2011 Junichi Uekawa
%     Copyright (C) 2011 Nobuhiro Iwamatsu

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image201201; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2012}
\newcommand{\debmtgmonth}{6}
\newcommand{\debmtgdate}{23}
% (+ (* (- 2012 2005) 12) 12 -1) started from zero
\newcommand{\debmtgnumber}{95}


\begin{document}

\dancersection{Gentoo/Prefix on Debian}{青田直大}
\label{sec:your-label}

\subsection{はじめに}

いきなりGentooが出てきて驚かれたかもしれません.ここではDebian下で
Gentoo Prefixをインストールする方法について解説します.

\subsection{Gentoo Prefix}
\subsubsection{Gentooとは}
GentooはDebianやRPMと違ったソースベースのディストリビューションです.
ebuildというパッケージビルド方法や,パッケージの依存関係などを記述した
bashスクリプト風のファイルが"カテゴリー/パッケージ名/パッケージ名-パッ
ケージバージョン.ebuild"というファイル名で保管されています. emergeとい
うコマンドは, この 「Portageツリー」というパッケージ情報ファイルツリー
を読んで指定されたパッケージをビルド・インストールするパッケージ管理ソフ
トになっています.

\subsubsection{Prefixサポート}

Gentooも基本的にはLinux上のディストリビューションですが, Debianの
Debian GNU/kFreeBSDと同様にFreeBSD上でのパッケージ管理を目的とした
Gentoo/FreeBSDなどの開発も行なわれています. そういったLinux以外での
Gentooのサポートを総称して, Gentoo/Altと呼んでいます.
\footnote{http://www.gentoo.org/proj/en/gentoo-alt/} そのGentoo/Altの中
にGentoo Prefixというものがあります.
\footnote{http://www.gentoo.org/proj/en/gentoo-alt/prefix/index.xml} こ
れはGentooのシステムを使って(基本的には)他のOS上で, 任意のディレクトリ
にパッケージのインストールを行なえるようにするものです. たとえば, Mac
OS X上で動かして, MacPortsやhomebrewの代わりに使ったり, あるいは
FreeBSD上で使ったり, はたまたLinux上で使うことももちろんできます.

\subsection{Gentoo/Prefix on Debian}

さてここからが本題で, このGentoo/PrefixをDebianで使ってみます. おそらく
なんでそんなことを…? と思われるかもしれません. 以下のような点があげら
れるかと思います.

\begin{itemize}
\item 非rootユーザでも好きなところにインストールできる
\item Debianにないパッケージをインストールする時に楽できる
\item 技術的に楽しい?
\end{itemize}

Prefixインストールでは好きなディレクトリにインストールできるため, たと
えば自分のホームディレクトリの中などにインストールするようにしてしまえ
ばroot権限がなくともパッケージをインストールすることができます. また,
(もし万が一) Debianにないパッケージがあったとして, それがGentooの方にあ
れば, 自分でビルド方法や依存を調べることなく, Gentooのパッケージシステ
ムにおまかせしてしまうことができる, というわけです.

\subsubsection{インストール}

では, さっそくDebian上にインストールしてみましょう. まずはビルドに必要
なパッケージをインストールしておきます. 

\begin{commandline}
% apt-get install bzip2 build-essential bison libreadline-dev libncurses-dev autoconf xz-utils
\end{commandline}

つぎに, Prefixをインストールする場所を決めて,  変数EPREFIXに設定し, PATHも通しておきます.

\begin{commandline}
% export EPREFIX="$HOME/gentoo"
% export PATH="$EPREFIX/usr/bin:$EPREFIX/bin:$EPREFIX/tmp/usr/bin:$EPREFIX/tmp/bin:/usr/bin:/bin:$PATH"
\end{commandline}

Prefixをインストールするためのスクリプトを取得し, そのスクリプトを使っ
てパッケージ管理ソフトPortageと, パッケージ情報のPortageツリーをインス
トールしていきます. 

\begin{commandline}
% wget http://overlays.gentoo.org/proj/alt/browser/trunk/prefix-overlay/scripts/bootstrap-prefix.sh?format=txt \
  -O bootstrap-prefix.sh
% chmod 755 bootstrap-prefix.sh
% ./bootstrap-prefix.sh $EPREFIX tree
% ./bootstrap-prefix.sh $EPREFIX portage
\end{commandline}

この時点でemergeコマンドが使えるようになります. ここからはemergeを使っ
て, Prefix環境を整えていきます. このあたりはあまり今回の主題ではないの
で残りはPrefixのドキュメン
ト\footnote{http://www.gentoo.org/proj/en/gentoo-alt/prefix/bootstrap-solaris.xml}
を参考にしてください. \footnote{いまのDebianだとmultiarchの影響でうまく
  動かないところもあるかもしれません…}

\begin{commandline}

\end{commandline}

\subsection{apt-emerge}

ここまでで, Gentoo/Prefixを解説してきました. しかし, これではあまりに
Gentooすぎますね. Gentoo/Prefixの中にもDebian側で入っているはずのプログ
ラム・ライブラリがインストールされてしまってなんだか無駄なような気がし
てしまいます. 特にDebianだとさくさくとバイナリパッケージからインストー
ルされてしまうのに, Gentooだとソースからビルドされて待つのもなかなか大
変なものです. なんとかDebianにあるものはDebianのものを使いつつ, Gentoo
ではどうしても必要なものだけをインストールすることはできないでしょうか.

Gentooではetc/portage/profile/package.providedファイルに以下のように書
くことで, そのパッケージがインストールされていると「見做す」ことができます. 

\begin{commandline}
sys-power/acpi-1.6
sys-power/acpid-2.0.16
sys-process/at-3.1.13
sys-devel/autoconf-2.69
sys-devel/automake-1.11.3
app-shells/bash-4.2
\end{commandline}

Debian側にあるパッケージをこうやってGentoo側のパッケージ名にマップして,
package.providedファイルに書くことで, Gentoo側で依存としてパッケージが
ビルド・インストールされることがなくなります. こうして

\begin{enumerate}
\item Gentooのemergeでの依存パッケージを把握
\item Gentooでの依存パッケージ名をDebianのパッケージ名にマップ
\item インストールされたDebianのパッケージ名をGentooのパッケージ名にマップ
\item マップされたパッケージ名をpacakge.providedに追記
\item 再度依存関係を計算しなおして2に戻る
\item これ以上Debianからインストールできなければemergeを開始
\end{enumerate}

といったプロセスを行ない, 最小限のパッケージだけで目的のGentooのパッケー
ジをインストールすることができます. この時に肝となるのが, 「Gentooでの
  依存パッケージの把握」と「GentooとDebianとのパッケージの相互マップを
  どうするのか」の二点です.

\subsubsection{Gentooでの依存パッケージ}

emergeに対して以下のオプションをつけて出力を解析します.

\begin{itemize}
\item -p (--pretend): インストールを実行せずインストールパッケージ一覧だけを出力します
\item -q (--quiet): 無駄な情報を出力しないようにします
\item -t (--tree): インストールするパッケージを依存関係のツリー状に出力します
\end{itemize}

-tが一番重要なところです. これを指定することでこのようにツリー状に出力されます

\begin{commandline}
%  emerge -pqt --quiet-repo-display chromium
[ebuild  N    ] www-client/chromium-20.0.1132.21 
...
[nomerge      ] www-client/chromium-20.0.1132.21 
[ebuild  N    ]  dev-libs/nss-3.13.4 
[ebuild  N    ]   dev-libs/nspr-4.9 
[ebuild  N    ]    sys-devel/autoconf-2.13 
[ebuild  N    ]     sys-devel/autoconf-wrapper-12 
[ebuild  N    ]   dev-db/sqlite-3.7.12.1 
...
\end{commandline}

このツリーの浅いところからDebianのパッケージへとマップしていきます. 浅
いところからマップしていくことで, できるだけ多くの依存解決をDebian側に
おまかせします. つまり, たとえばここで dev-libs/nsprをDebian側でインス
トールすることに成功すればこのツリーを

\begin{commandline}
[ebuild  N    ] www-client/chromium-20.0.1132.21 
...
[nomerge      ] www-client/chromium-20.0.1132.21 
[ebuild  N    ]  dev-libs/nss-3.13.4 
[ebuild  N    ]   dev-db/sqlite-3.7.12.1 
...
\end{commandline}

ここまで一気に縮小することができるというわけです. 

\subsubsection{GentooからDebianへのマップ}

Gentooのパッケージ名からDebianのパッケージ名へのマッピングを行ないます.
Gentooのパッケージ名にはカテゴリがついていますが, Debianの方にはそれが
ないので, とりあえず外してしまいます. そして, 以下の順番で探索をかけます. 

\begin{itemize}
\item libパッケージ名-dev
\item パッケージ名-dev
\item パッケージ名
\end{itemize}

Gentooのパッケージでは一般にDebianの*-devに入るようなものがインストール
されているので, *-devを優先してインストールするようにしています. 

また, dev-rubyカテゴリのものにはruby-をパッケージ名につけるなどの工夫を
したり, どうしてもこれでマップできないものは明示的にマッピングを書くな
どの対処もしています.

\subsubsection{DebianからGentooへのマップ}

こうしてDebianへとパッケージをインストールできたら, インストールできた
パッケージのバージョンを取得してGentooのパッケージ名へのマップをしてい
きます. これは単純にdpkg -l ...の結果を使うだけですね. 現状Debianの仮想
パッケージから選択される実際のパッケージのバージョンをとれず, うまくマッ
プできていません….

\subsubsection{実行サンプル}

これらのアイデアを実装したのがapt-emergeスクリプトになります. このスク
リプトは基本的に上記のemergeが使えるようになった段階で使えるようになっ
ていますが, 一部のパッケージはGentooのコア部分に大きく食いこんでいるの
でそれらはGentooで入れておかないといけません. また, Debianのmultiarchに
対応するようにCFLAGS/LDFLAGSを調整します.
 
\begin{commandline}
% vi $EPREFIX/etc/make.conf
CFLAGS="-O2 -I/usr/include/x86_64-linux-gnu"
LDFLAGS="${LDFLAGS} -L/usr/lib/x86_64-linux-gnu"
% FEATURES="-collision-protect" emerge -avg1 --nodeps bash eselect eselect-python python portage libffi
\end{commandline}

これでapt-emergeが動くようになるはずです. apt-emergeを動かすと自動的に必要なパッケージをapt-getに渡し, 可能な限りの依存を解決してから, emergeに処理を渡します.

例としてTwitterクライアント
mikutter\footnote{http://mikutter.hachune.net}をapt-emergeでインストー
ルしてみましょう. これはRubyとRuby/Gtk2などを使ったパッケージなので, 普
通にemergeするだけであれば, gtkなど大量にビルドされるはずです
が……apt-emerge mikutter後にGentoo側になにがインストールされているかを
リストアップしてみましょう(仮想パッケージは除いてあります)

\begin{commandline}
% eix -I -c |grep -v virtual
[I] app-admin/eselect (1.3.1@06/03/2012): Gentoo's multi-purpose configuration and management tool
[I] app-admin/eselect-python (20111108@06/03/2012): Eselect module for management of multiple Python versions
[I] app-admin/python-updater (0.10-r2@06/04/2012): Script used to reinstall Python packages after changing of active Python versions
[U] app-shells/bash (4.2_p28@06/03/2012 -> 4.2_p29): The standard GNU Bourne again shell
[I] app-shells/push (1.5@06/04/2012): A POSIX shell function to treat a variable like an array, quoting args.
[I] dev-lang/python (2.7.3-r2(2.7)@06/04/2012): Python is an interpreted, interactive, object-oriented programming language.
[I] dev-libs/libffi (3.0.11@06/04/2012): a portable, high level programming interface to various calling conventions.
[I] net-misc/mikutter (9999@06/04/2012): mikutter is simple, powerful and moeful twitter client
[I] sys-apps/baselayout-prefix (1.12.14@06/04/2012): Baselayout for Gentoo Prefix installs
[I] sys-apps/portage (2.2.01.20430@06/04/2012): Prefix branch of the Portage Package Manager, used in Gentoo Prefix
[I] sys-apps/tcp-wrappers (7.6.22@06/04/2012): TCP Wrappers
[I] sys-devel/gnuconfig (20120116@06/04/2012): Updated config.sub and config.guess file from GNU
\end{commandline}

ご覧のように10個程度しかGentoo側にはインストールされていませんが,
mikutter-9999 (SVN trunkのバージョン)がしっかりとインストールされています.

\subsection{これから}

apt-emergeのスクリプトはまだコンセプトが実装されただけで, いろんな部分
がad-hocになっています. よりDebianのパッケージ名とGentooのパッケージ名
とのマッピングの推測を賢くしたり, 必要な固定マップデータを拡充し,
Debianのvirtualパッケージをうまく処理したりするなど, より使いやすいビル
ドシステムを作れればと思います. 自分自身Debianに深く知識を持っているわ
けではないので, もしかするともっと効率のよい実装もあるかもしれません….
もし興味を持っていただければ, 開発参加・アドバイスしていただけましたら
幸いです. 

\dancersection{IPython notebookとその周辺}{本庄弘典}
\label{sec:ipython-notebook}

\subsection{はじめに}

最近ipythonのqtconsoleでコンソール上にグラフを描画しているスクリーンショットを見る機会があり、
ちょっとかっこいいかなとロクに使ったことがないPythonを使い始めました。
今回はipython qtconsoleを使用したグラフの描画から、
Mathmatica notebooksのようなWebベースの数式処理システムipython notebookをPython初心者の視点で紹介してみたいと思います。

\subsection{IPython}

ipythonはFernando Perez氏によって作成されたPythonのインタラクティブシェルで、
現在の最新リリースバージョンは0.12.1です。
Pythonはそれ自体でインタラクティブシェルの機能を持っていますが、
ipythonはPythonシェルと比較して次の特徴を持っています。

\begin{itemize}
 \item terminalでの使用に加えQt等を用いたグラフィカルなコンソールが使用可能
 \item コード補完
 \item シンタックスハイライト
 \item 並列コンピューティングが可能
 \item Webベースのnotebook(ipython 0.12から)
\end{itemize}

Pythonシェルとipythonは次の図のように、
プロンプト等に違いがあります。

\begin{figure*}[b]
  \begin{tabular}{cc}
    \begin{minipage}[b]{0.5\textwidth}
      \includegraphics[width=1.0\hsize]{images/ipython-pythonshell.png}
      \label{pythonshell}
    \end{minipage}
    \begin{minipage}[b]{0.5\textwidth}
      \includegraphics[width=1.0\hsize]{images/ipython-terminal.png}
      \label{ipython}
    \end{minipage}
  \end{tabular}
  \caption{pythonシェルとipythonの違い}
\end{figure*}

\subsection{IPython qtconsole}

ipythopnにqtconsoleオプションを指定して実行することにより、
GUI環境でのipythonが起動します。
またこの環境で--pylab inlineを指定して起動することで、
コンソール内にグラフを表示させることが可能となります。

\begin{commandline}
$ ipython qtconsole --pylab matplotlib
\end{commandline}

この環境では前述のグラフ表示に加え、
複数行をまとめて扱うコマンドの履歴などが使用できます。
グラフを描画すると次のように表示されます。

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.6\hsize]{images/ipython-mandelbrotset.png}
  \end{center}
  \caption{qtconsoleでマンデルブロ集合}
  \label{fig:ipython-qtconsole}
\end{figure}

testingでのipython qtconsoleおよびmatplotlibは次のコマンドでインストール出来ます。

\begin{commandline}
$ sudo aptitude install ipython-qtconsole python-matplotlib
\end{commandline}

またsqueezeはbackportsを使用してインストールを行いました。
まず/etc/apt/sources.listに次の行を追加し、

\begin{commandline}
deb http://backports.debian.org/debian-backports squeeze-backports main
\end{commandline}

aptitude update \&\& aptitude upgradeを実行した後、
次のコマンドでインストールします。

\begin{commandline}
$ sudo aptitude install python-setuptools python2.6-dev ncurses-dev libzmq-dev python-pygments python-matplotlib pyqt4-dev-tools
\end{commandline}

パッケージのインストール後、
pythonのeasy\_installコマンドを使用してipythonをインストールします。

\begin{commandline}
$ sudo easy_install readline pyzmq ipython
\end{commandline}

\subsection{IPython notebook}

ipython notebookはWebベースの数式処理システムで、
次の機能を備えています。

\begin{itemize}
 \item Pythonコードの実行と結果の表示
 \item Markdownによるマークアップ可能なノート
 \item MathJaxによる \TeX 形式での数式の記述
\end{itemize}

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.80\hsize]{images/ipython-gacha.png}
  \end{center}
  \caption{ipython notebookの使用例}
  \label{fig:ipython-gacha}
\end{figure}

testingには次のコマンドでインストール可能です。

\begin{commandline}
$ sudo aptitude install ipython-notebook python-matplotlib python-tornado
\end{commandline}

squeezeはqtconsoleと同様にbackportsを使用します。
ここではsqueezeのiceweaselが古いためこちらもapt lineに追加しています。

\begin{commandline}
deb http://backports.debian.org/debian-backports squeeze-backports main
deb http://mozilla.debian.net/ squeeze-backports iceweasel-release
\end{commandline}

aptitude update \&\& aptitude upgradeを実行した後、
インストールは次のコマンドで行いました。

\begin{commandline}
$ sudo aptitude install python-setuptools python2.6-dev ncurses-dev libzmq-dev python-pygments python-matplotlib
\end{commandline}

パッケージをインストールした後、
pythonのeasy\_installコマンドを使用してipythonをインストールします。

\begin{commandline}
$ sudo easy_install readline pyzmq ipython tornado
\end{commandline}

またこのままではMathJaxがCDNを指しているので、
pythonを管理者権限で実行しローカルにインストールします。

\begin{commandline}
from IPython.external.mathjax import install_mathjax
install_mathjax()
\end{commandline}

squeezeのウェブブラウザはどれも古く、
Web Socketの問題からnotebookでは使えません。
そこで最新版のiceweaselを導入します。
ipython notebookは起動時にデフォルトブラウザを起動するため、
導入後はiceweaselをデフォルトブラウザに指定してください。

\begin{commandline}
$ sudo aptitude install -t squeeze-backports iceweasel
\end{commandline}

ipython notebookは次のコマンドで起動します。

\begin{commandline}
$ ipython notebook --pylab inline
\end{commandline}

他のマシンから接続を行う場合、
ブラウザを起動させないためオプション''--no-browser''を、
アクセス許可を与えるためnotebookを起動させるマシンのipアドレスをオプション''--ip''で指定します。

\begin{commandline}
$ ipython notebook --pylab inline --no-browser --ip 192.168.1.40
\end{commandline}

初回起動時には次のような画面が表示されます。

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.67\hsize]{images/ipython-notebook.png}
  \end{center}
  \caption{ipython notebookを起動した直後}
  \label{fig:ipython-notebook}
\end{figure}

「New Notebook」ボタンをクリックすることで新規ノートブックが作成され、
空のノートブックがブラウザに表示されます。
MarkdownとPythonのCellはCtrl-m mおよびCtrl-m cで切り替えることができ、
その他コマンドの詳細はCtrl-m hで表示されます。

作成されたノートブックは表示されているディレクトリ(ここでは/home/hiro/)に''$<$ ノートブックのタイトル$>$.ipynb''というファイル名で保存されます。
このファイルの中身はJSON形式となっています。

\subsection{最後に}

今回はipython qtconsoleおよびnotebookをDebianで使用する方法を紹介しました。
Ubuntu 12.04ではどちらもパッケージとして提供されているため、
wheezyではインストール作業が簡単になると思われます。
これを機会にipythonを活用していただければ幸いです。

\end{document}
