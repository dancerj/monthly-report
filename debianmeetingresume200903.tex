%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。


%     Tokyo Debian Meeting resources
%     Copyright (C) 2009 Junichi Uekawa

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image200901; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2009}
\newcommand{\debmtgmonth}{3}
\newcommand{\debmtgdate}{21}
\newcommand{\debmtgnumber}{50}



\begin{document}

\begin{titlepage}
\thispagestyle{empty}

% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料

\hspace*{-2.4cm}
\includegraphics[width=210mm]{image200801/2008title.eps}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

\end{titlepage}

\dancersection{Introduction}{上川 純一}

\begin{multicols}{2}
 
 
 今月のDebian勉強会へようこそ。これからDebianの世界にあしを踏み入れると
 いう方も、すでにどっぷりとつかっているという方も、月に一回Debianについ
 て語りませんか？

 Debian勉強会の目的は下記です。

 \begin{itemize}
 \item \underline{Debian Developer} (開発者)の育成。
 \item 日本語での「\underline{開発に関する情報}」を整理してまとめ、アップデートする。
 \item \underline{場}の提供。
 \begin{itemize}
  \item 普段ばらばらな場所にいる人々が face-to-face で出会える場を提供
	する。
  \item Debian のためになることを語る場を提供する。
  \item Debianについて語る場を提供する。
 \end{itemize}
 \end{itemize}		

 Debianの勉強会ということで究極的には参加者全員がDebian Packageをがりがり
 と作るスーパーハッカーになった姿を妄想しています。情報の共有・活用を通し
 て Debianの今後の能動的な展開への土台として、「場」としての空間を提供す
 るのが目的です。

 2009年の計画は仮です。

 \begin{enumerate}
  \item 新年の企画 (アンサンブル荻窪開催)
  \item OSC Tokyo
  \item VAIO P インストール記録、
	カーネル読書会　ディストリビューション大集合(小林さん)(東京大学?)
  \item Git Handson (岩松)(あんさんぶる荻窪?)
  \item 家Debianサーバ vs 職場のネットワーク(千代田区都立図書館?\footnote{\url{http://www.library.chiyoda.tokyo.jp/}})
  \item Asterisk (東京大学?)
  \item スペインにて開催
  \item Debconf報告会
  \item OSC Fall?
  \item udev + HAL(岩松さん)
  \item 3D graphics 開発（藤沢さん） 
  \item Debian サーバ+VMware + 各種OS、
	他の仮想化ツール(vserver etc.)、
	忘年会
 \end{enumerate}

 会場候補としては下記があります:

 \begin{itemize}
  \item 大学
  \item 恵比寿SGIホール
  \item Googleオフィス
  \item 公民館(あんさんぶる荻窪等)
  \item 都立会議室(無線LAN)
  \item 健保の施設
 \end{itemize}

\end{multicols}


\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
%
% there are too many entries in 200901, usually
% we have tocdepth=2.
%
\setcounter{tocdepth}{1}
\tableofcontents
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{事前課題}{上川 純一}

??

{\bf 問題}

\begin{enumerate}
 \item xxx
\end{enumerate}

この課題に対して提出いただいた内容は以下です。

\begin{multicols}{2}
\input{image200903/prework.tex}
\end{multicols}

% image200903/prework.tex 内部にテキストを追加してください。
%
%

\dancersection{最近のDebian関連のミーティング報告}{上川 純一}
\subsection{東京エリアDebian勉強会48回目報告}
% (query-replace-regexp "<.*?>" "")
% (query-replace-regexp "^[	 ]\+" "")

\subsection{東京エリアDebian勉強会49回目報告}
% (query-replace-regexp "<.*?>" "")
% (query-replace-regexp "^[	 ]\+" "")


\subsection{Ubuntu XXX}

やまねさんが書く?

\subsection{Linux Consortium 10 years event }

\url{http://www.debian.or.jp/blog/events/linuxconsortium10th.html}
についてやまねさんが書く?

% ===============================================================
\dancersection{カーネル読書会　ディストリビューション大集合}{小林儀匡}
\index{kernel}
\index{SVM}
\index{distribution}
\index{ぶんさん@分散}
% ===============================================================

%============================================================
\dancersection{adviをデバッグしてみた}{日比野 啓}
\index{OCaml}
\index{TeX}
%============================================================

2008年11月のLaTeXを使ったハンズオンで、wizzytex-modeから使われている
adviがときどき固まってしまう問題について調べてみました。

\subsection{adviがまる?}

adviは一見普通のDVI viewerなのですが、なぜかOCamlという変わった言語で実装されています。
今回はadviから呼ばれるghostscriptが止まっているらしい、
ということまで分かっている状態から調べ始めました。

\subsection{とりあえずアタリをつける}

とりあえず、問題が起きているソースを取ってきて展開してみます。

\begin{commandline}
% apt-get  source advi
...
dpkg-source: extracting advi in advi-1.6.0
dpkg-source: info: unpacking advi_1.6.0.orig.tar.gz
dpkg-source: info: applying advi_1.6.0-13.diff.gz
% cd advi-1.6.0
% ls *.ml
addons.ml     drawimage.ml  font.ml            gs.ml             main.ml     search.ml      transimpl.ml
ageometry.ml  driver.ml     global_options.ml  gterm.ml          misc.ml     shot.ml        ttfont.ml
...
\end{commandline}

*.mlというのがOCamlのソースファイルです。なんか、gs.mlとかいうそのものズバリっぽいものが見えます。
gs.mlの中をまずgsで検索していってみると、

\begin{commandline}
...
  let command = Config.gs_path in
  let command_args =
    [|
      command; 
      "-dNOPLATFONTS"; "-dNOPAUSE";
      "-sDEVICE=" ^ (if !antialias then x11alpha else x11);
      "-q";
      "-dSAFER";
      "-";
    |] in

  let _ = debugs command;
...
\end{commandline}

おお、それっぽい。あと、デバッグ用っぽい機能 - debugs を発見。
さらにこんどはcommandで探していくと、

\begin{commandline}
...
  let lpd_in, lpd_out = Unix.pipe () in
...
  let leftout = Unix.out_channel_of_descr lpd_out in
...
  let pid =
    Unix.create_process command command_args lpd_in rpd_out
      (* Unix.stdout *) Unix.stderr
...
    method line l =
      try
        showps l;
        output_string leftout l;
        output_char leftout '\n';
...
\end{commandline}

どうやらgsにパイプでPSを書きこんでいるようです。
showps とかいうのでPSの中身を見ることができるんじゃないかなーとか。

\subsection{まじめに調べてみたんですが...}

もう一度、こんどはgs.mlの最初の方からデバッグ用の機能だけ見ていきます。

\begin{commandline}
...
let debugs = Misc.debug_endline;;
...
let showps_ref = ref false;;
let showps s =
  if !showps_ref then (print_endline  (Printf.sprintf "%s" s));;
...
Options.add
  "--showps" (Arg.Set showps_ref)
  "  ask advi to print to stdout a copy\
  \n\t of the PostScript program sent to gs.";;
...
\end{commandline}

\verb|Misc.| というのは Miscという別のモジュールへの参照です。ここでは単にmisc.mlの中を見ればよさそうです。
\verb|showps_ref|は書き換え可能なフラグのようです。
と思ったらすぐ下にコマンドライン引数からフラグをセットできるようになっているようです。
misc.mlの中も見てみると、

\begin{commandline}
...
(* Debugging. *)
let forward_debug_endline =
  ref (function (_ : string) -> failwith "undefined forward debug_endline");;

let debug_endline s = (!forward_debug_endline s : unit);;

let set_forward_debug_endline f = forward_debug_endline := f;;
...
\end{commandline}

さらに\verb|set_forward_debug_endline|でgrepすると、\verb|global_options.ml|が引っかかるので、その中も見てみると

\begin{commandline}
...
(* To print debugging messages. *)
let debug_endline = Options.debug "--debug" " General debug";;

(* Setting the forward in Misc. *)
Misc.set_forward_debug_endline debug_endline;;
...
\end{commandline}

結局、どっちもコマンドラインから設定できるようですね。
さっそく試してみると、

\begin{commandline}
% platex debianmeetingresume200812-presentation.tex
...
% advi debianmeetingresume200812-presentation.dvi
...
/usr/bin/gs
-dNOPLATFONTS
-dNOPAUSE
-sDEVICE=x11
-q
-dDELAYSAFER
-
...
%!PS-Adobe-2.0
%%Creator: Active-DVI
%!
[1 0 0 -1 0 0] concat
(/usr/share/texmf-texlive/dvips/base/texc.pro) run
(/usr/share/texmf-texlive/dvips/base/special.pro) run
...
%% Newpage

grestore
0 0 moveto
TeXDict begin 12769384 12769384 div dup /Resolution X /VResolution X end
TeXDict begin /DVImag 194.845342 def end
gsave
flushpage (...
) print flush 
\end{commandline}

たしかにgsのコマンドラインらしきものと、それから書きこんだPSの内容らしいものが見えてます。
PSで目印となる文字列を出力される命令 \verb|flushpage (...) print flush| をgsに書きこんで、
その出力を待っているようなのですが、戻ってきていないようです。

gsが止まってしまう場合とそうでない場合も比べてみたのですが、
止まってしまう場合のPSの最小セットを割り出すのが難しく、よくわかりませんでした。

\subsection{別の回避策?}

なにか別の方法で止まってしまうのを回避できないか、とgsの出力を待っている部分も見てみます。

\begin{commandline}
...
let rec select fd_in fd_out fd_exn timeout =
  (* dirty hack: Graphics uses itimer internally! *)
  let start = Unix.gettimeofday () in
  try
    Unix.select fd_in fd_out fd_exn timeout
  with
    Unix.Unix_error (Unix.EINTR, _, _) as exn ->
      let now = Unix.gettimeofday () in
      let remaining = start +. timeout -. now in
      if remaining > 0.0 then select fd_in fd_out fd_exn timeout else [], [], []
...
      match select [ rpd_in ] [] [] 1.0 with
      | [], _, _ ->
          begin match Unix.waitpid [ Unix.WNOHANG ] pid with
          | x, Unix.WEXITED y when x > 0 ->
              raise (Killed "gs exited")
          | 0, _ ->
              raise (Killed "gs alive but not responding")
          | _, _ ->
              raise (Killed "gs in strange state")
          end
...
\end{commandline}

gsの出力をselectで待っているようです。タイムアウトも仕込んであるようです。
なぜうまくいっていないのでしょう。

ここでは前半で定義されているselectに注目です。
せっかくタイムアウトの残り時間を計算しているのに、渡しているのはもとの値です。
どうりでいつまでたってもタイムアウトしないわけです。

\begin{commandline}
...
if remaining > 0.0 then select fd_in fd_out fd_exn timeout else [], [], []
...
\end{commandline}

これを
\begin{commandline}
...
if remaining > 0.0 then select fd_in fd_out fd_exn remaining else [], [], []
...
\end{commandline}

と直すと、gsを待ってもタイムアウトするようになります。
gsが固まる原因を取り除くような根本的な解決はできませんでしたが、
とりあえずは advi が止まらないようにはなりそうです。

% ===============================================================
\dancersection{Debian on chumbyの作り方 }{まえだこうへい}
\index{chumby}
\index{lenny}
\index{chroot}
% ===============================================================

OSC 2009 Tokyo/Springでの東京エリア Debian 勉強会のブースで、Debian on
chumby を行いました。今回はその環境の作り方についてまとめました。
\begin{multicols}{2}
\subsection{概要}
今回、実はchumbyの上でネイティブにDebianを動かしたわけではありません。
USBメモリにインストールしたDebianにchrootして擬似的に動かしてい
るように見せかけました。ネイティブに動かすとなるとブートローダをいじる必
要がありますが、今回はchumby自体はほとんど変更せずに済む方法をとりました。

\subsubsection{chumbyの仕様}
chumbyは、インターネットに接続可能な無線LAN環境が必要で、接続できな
ければアナログ時計のwidgetの表示しかできません。また、書き込み可能なメモ
リ領域はフラッシュメモリも64MBのうち、わずかです\footnote{jffs2ファイルシステムで/pspとしてマウントされています。}。当然、Debianをローカルにインストールすることはできないので、USBメモリを外部ストレージとして使います。

もう一つの制約は、chumbyは、ext2などを使えません。USBメモリを使う場合は
vfatのみです。しかしvfatではLinuxをインストールできません\footnote{原因
はsymlinkを作成できないこと、適切なパーミッションを設定できないこと、な
ど。}。そこで、大きく３つやることがあります。
\begin{enumerate}
\item chumbyのカーネルリビルド
\item USBメモリへのDebianインストール
\item USBメモリのDebianへのchroot設定
\end{enumerate}
\subsection{環境構築}
\subsubsection{前提条件}
\textbf{環境構築時に最低限必要なもの}
\begin{itemize}
\item chumby
\item USBメモリ
\item Debian環境構築用のPC
\item ネットワーク環境
\end{itemize}
\subsubsection{chumbyのカーネルリビルド}
前述のとおり、chumbyのkernelはext2を使えません。今回、USBメモリにはext2
フォーマットでDebianをインストールするので、chumby自体もext2を読み込める
ようにします。
まず、下記リンク先からchumbyのカーネル構築用のツールキットを入手します。
手順はリンク先に従います。
\begin{itemize}
\item GNU Toolchain\footnote{\url{http://wiki.chumby.com/mediawiki/index.php/GNU_Toolchain}}
\item GCC Toolchain\footnote{\url{http://wiki.chumby.com/mediawiki/index.php/GCC_Toolchain}}
\end{itemize}
これらのツールキットは、/usr以下に展開されるので、kvm/qemuなどの仮想OS環
境に、環境を構築すると良いでしょう。
\begin{commandline}
$ cd /
$ sudo tar zxf ~/arm-linux-v4.1.2b.tar.gz
$ sudo tar zxf ~/Gcc-3.3.2-glibc-2.3.2.tar.gz
$ sudo mkdir -p /opt/Embedix/usr/local/arm-linux
$ sudo ln -s /usr \
 /opt/Embedix/usr/local/arm-linux/gcc-3.3.2-glibc-2.3.2
$ sudo vi /usr/bin/arm-linux-make
$ sudo chmod +x /usr/bin/arm-linux-make
\end{commandline}
/usr/bin/arm-linux/makeには以下のように記述します。
\begin{commandline}
#!/bin/sh
echo make ARCH=arm CROSS=arm-linux- CC=arm-linux-gcc \
 AR=arm-linux-ar NM=arm-linux-nm RANLIB=arm-linux-ranlib \
 CXX=arm-linux-g++ AS=arm-linux-as LD=arm-linux-ld \
 STRIP=arm-linux-strip BUILDCC=gcc BUILD_CC=gcc \
 CC_FOR_BUILD=gcc ``$@''
exec make ARCH=arm CROSS=arm-linux- CC=arm-linux-gcc \
 AR=arm-linux-ar NM=arm-linux-nm RANLIB=arm-linux-ranlib \
 CXX=arm-linux-g++ AS=arm-linux-as LD=arm-linux-ld \
 STRIP=arm-linux-strip BUILDCC=gcc
 BUILD_CC=gcc CC_FOR_BUILD=gcc ``$@''
\end{commandline}
私のchumbyのファームウェアは1.6\footnote{確認方法は、sshでchumbyにログイ
ン後、chumby\_version -fを実行します。}なので、Wikiのfirmware 1.6の手順を実施し
ます。
\begin{itemize}
\item Hacking Linux for chumby - ChumbyWiki\footnote{\url{http://wiki.chumby.com/mediawiki/index.php/Hacking_Linux_for_chumby}}
\end{itemize}
また、カーネルビルド用の環境には次のDebianパッケージは最低限入れておく必
要があります。
\begin{itemize}
\item make
\item gcc
\item libncurses5-dev
\item libncursesw5-dev
\item zip
\end{itemize}
また、chumby用のカーネルソースコードと、chumbyへ新しいカーネルをインストールす
るためにアライメントするPerlスクリプトをそれぞれダウンロードしておきます。
\begin{itemize}
\item linux-2.6.16-chumby-1.6.0.tar.gz\footnote{\url{http://files.chumby.com/source/ironforge/build733/linux-2.6.16-chumby-1.6.0.tar.gz}}
\item align.pl\footnote{\url{http://files.chumby.com/source/ironforge/build396/align.pl}}
\end{itemize}

カーネルソースを展開し、make menuconfigでext2を組み込みます\footnote{モ
ジュールにしても構いませんが、その場合は手動でカーネルモジュールをロード
する必要があるので面倒です。}。
\begin{commandline}
$ cd
$ mkdir kernel
$ cd kernel
$ cp ~/{align.pl,linux-2.6.16-chumby-1.6.0.tar.gz} ./
$ tar zxf linux-2.6.16-chumby-1.6.0.tar.gz
$ cd linux-2.6.16-chumby-1.6.0
$ ARCH=arm BOARD=mx21ads CROSS_COMPILE=arm-linux- \
 make menuconfig
$ ARCH=arm BOARD=mx21ads CROSS_COMPILE=arm-linux- make
$ perl ../align.pl arch/arm/boot/zImage
$ zip k1.bin.zip arch/arm/boot/zImage
\end{commandline}
これで、kernel/linux-2.6.16-chumby-1.6.0/ディレクトリ直下に、k1.bin.zip
が生成されます。これをUSBメモリのvfat領域にコピーします。
\begin{commandline}
$ sudo mount -t vfat /dev/sda1 /media/usb
$ sudo mkdir /media/usb/update2
$ sudo cp -i k1.bin.zip /media/usb/update2/
$ sudo umount /media/usb
\end{commandline}
chumbyをspecial option modeで起動し、kernelをアップデートします。
\begin{enumerate}
\item chumbyの電源をOFFにした状態でUSBメモリを挿します。
\item タッチスクリーンを押したまま、電源を入れる。途中で押したままにする
      とspecial option modeになるよ、と表示されるのでそのまま押しつづけ
      ます。
\item special option modeのメニュー画面で''install updates''をクリックし
      ます。
\item ``Install from USB flash drive''をクリックすると、kernelがアップデー
      トされ、自動的に再起動されます。
\end{enumerate}
\subsubsection{USBメモリへのDebianインストール}
次に、USBメモリにDebianをインストールしますが、USBメモリにはchumby自体の設
定を行うためのファイルを置くvfat領域も必要なので、fdiskコマンドで
/dev/sda1をvfat、/dev/sda2をLinux用領域を作り、mkfsコマンドでファイルシ
ステムを作成しておきます。
\begin{commandline}
$ sudo fdisk /dev/sda
$ sudo mkfs.vfat /dev/sda1
$ sudo mke2fs    /dev/sda2
\end{commandline}
このsda2の方に、Debianをインストールします。chumbyは、EABI(armel)ではな
く、OABI(arm)であるため、arm版のインストーラを用意する必要があります。し
かし、Qemuではarmelのサブアーキテクチャversatileしかサポートしていないた
め、arm版のkernelイメージを起動させることしかできません。なので、今回は、
同じOABIのアットマークテクノ社のarmadillo-9用に公開されているDebian Etchイメー
ジを利用しました。下記リンク先から、5つのtarボールを全てダウンロードします。
\begin{itemize}
 \item debian directory - Armadillo 開発者サイト\footnote{\url{http://armadillo.atmark-techno.com/filebrowser/armadillo-9/debian}}
\end{itemize}
ext2領域をマウントし、tarボールを展開します。
\begin{commandline}
$ sudo mount /dev/sda2 /mnt
$ cd /mnt
$ tar zxf ~/debian-etch-a9-1.tgz
$ tar zxf ~/debian-etch-a9-2.tgz
$ tar zxf ~/debian-etch-a9-3.tgz
$ tar zxf ~/debian-etch-a9-4.tgz
$ tar zxf ~/debian-etch-a9-5.tgz
\end{commandline}
chumbyの電源を落とし、このUSBメモリを挿して電源を入れると、自動的にext2
領域もマウントされ、この下の領域のバイナリも正常に実行できます。
\subsubsection{USB環境へのchroot準備}
USBメモリのDebian環境にchrootし、そしてその環境下でEtchからLennyにバー
ジョンアップさせます。まず、sshでログインし、/proc、/dev、devptsをバインドさせ
ます。
\begin{commandline}
chumby:~# mount -o bind /proc /mnt/usb2/proc
chumby:~# mount -o bind /dev  /mnt/usb2/dev
chumby:~# mount -t devpts devpts /mnt/usb2/dev/pts/
chumby:~# chroot /mnt/usb2
chumby:/1 df
Filesystem    1K-blocks      Used Available Use% Mounted on
/dev/hda1       1373548    181321   1118946  14% /
tmpfs           1373548    181321   1118946  14% /lib/init/rw
sysfs           1373548    181321   1118946  14% /sys
udev            1373548    181321   1118946  14% /dev
tmpfs           1373548    181321   1118946  14% /dev/shm
devpts          1373548    181321   1118946  14% /dev/pts
\end{commandline}
apt lineをetchからlennyに書き換え、バージョンアップを行うと、問題なくアッ
プグレードできるはずです。

次に、chrootのDebianで、sshを自動起動させるた
め、次の設定を行います。22/tcpはchumby自体のsshdが使うので別のポートを割
り当てる方が良いでしょう。

\textbf{/mnt/usb2/etc/ssh/sshd\_config (一部抜粋)}
\begin{commandline}
Port 2222
(snip)
PermitRootLogin no
StrictModes yes
RSAAuthentication yes
PubkeyAuthentication yes
(snip)
PermitEmptyPasswords no
ChallengeResponseAuthentication no
PasswordAuthentication no
(snip)
\end{commandline}
次に、chumby側の設定。USBメモリに配置したWidgetをロードさせる手順の応用
で、6.2.3で作成したvfat領域の直下に、以下の内容でdebugchumbyというファイ
ル名でスクリプトを作成します。
\begin{commandline}
#!/bin/bash

mount -o bind /proc /mnt/usb2/proc
mount -o bind /dev  /mnt/usb2/dev
mount -t devpts devpts /mnt/usb2/dev/pts/
chmod 666 /mnt/usb2/dev/null
chroot /mnt/usb2 /bin/hostname chumby
chroot /mnt/usb2 /usr/sbin/sshd
\end{commandline}
これで、次回以降、自動的にchroot環境のDebianのsshdが2222/tcpで起動するよ
うになります。

\subsection{OSC会場での展示準備}
6.1でも書きましたが、Chumnyはインターネットに繋がらないと単なる時計です。
理由は、起動時にchumby.comからcontrolpanel.swfという管理コンソールの
flashファイルや、その他自分で設定しているWidgetをダウンロードしてくるた
めです。そこで、簡単なWidgetを作成し、画面上はそれを表示しつつ、スタンド
アロン環境でも有線LANを介してSSHでログインできるようにします。

\subsubsection{前提条件}
\textbf{環境構築に加えて必要なもの}
\begin{itemize}
\item mtascパッケージ
\item USB-Ethernet変換アダプタ
\item クロスケーブル
\item 展示用のPC
\end{itemize}

\subsubsection{Widget作成}
chumbyのWidgetはFlashです。Debianを使っているのでWidgetはもちろんテキス
トエディタでActionScriptを書いて、フリーソフトウェアでコンパイルします。
今回の展示で表示させていたWidgitのソースコードは以下のとおりです。
\begin{commandline}
class DisplayDebian {
  public static function main(mc:MovieClip):Void
  {
    var app = new DisplayDebian(mc);
  }

  public function DisplayDebian(mc:MovieClip)
  {
    mc.createEmptyMovieClip(``image'',
    mc.getNextHighestDepth());
    var image:MovieClip = mc.image;
    var imageArr:Array = [ ``./openlogo.png'' ];
    image._xscale= 100;
    image._yscale= 100;
    image._x= 69;
    image._y= 0;
    image.loadMovie(imageArr[0]);

    var textField:TextField = mc.createTextField('textField',
    mc.getNextHighestDepth(), 15, 10, 320, 240);
    var fmt:TextFormat = new TextFormat('', 24, 0x000000);
    textField.text = '東京エリア Debian 勉強会\n\n\n' +
    '次回は3/21,東大で開催予定';
    textField.setTextFormat(fmt);
  }
}
\end{commandline}
これをHoge.asとして保存し、同じディレクトリに
openlogo.png\footnote{Debian.orgのサイトのロゴ
\url{http://www.debian.org/logos/openlogo.xcf.gz}を利用。そのままでは画
像サイズが合わないため、gimpで高さ240ピクセルに収まるようにリサイズして
います。}を配置します。

そして以下のワンライナー(ascompile.sh)の引数として渡し、コンパイルします。
\begin{commandline}
$ ./ascompile.sh Hoge.as
\end{commandline}
ワンライナーascompile.shは以下のように記述します。
\begin{commandline}
#!/bin/bash
test -z $1 && exit 1
mtasc -swf `basename $1 .as`.swf -main $1 -header \
 320:240:12 -version 8
\end{commandline}
コンパイルすると、Hoge.swfというflashファイルができます。このHoge.swfを
Widgetとして読み込むために、profile.xmlという名前で設定します。

\begin{commandline}
<?xml version=''1.0'' encoding=''utf-8'' ?>
<profile>
 <widget_instances>
  <widget_instance id=''1''>
   <widget>
    <name>Debian Logo</name>
    <description>Debian GNU/Linux Logo</description>
    <version>1.0</version>
    <mode time=''30'' mode=''timeout'' />
    <access sendable=''false'' deletable=''false''
     access=''private'' virtualable=''false'' />
    <user username=''Kouhei Maeda'' />
    <thumbnail href=''file:////mnt/usb/openlogo.png''
     contenttype=''image/png'' />
    <movie href=''file:////mnt/usb/Hoge.swf''
     contenttype=''application/x-shockwave-flash'' />
   </widget>
   <access access=''private'' />
   <mode time=''30'' mode=''timeout'' />
   <widget_parameters>
    <widget_parameter>
     <name>auther1</name>
     <value>Kouhei</value>
    </widget_parameter>
    <widget_paramter>
     <name>auther2</name>
     <value>Maeda</value>
    </widget_parameter>
   </widget_parameters>
  </widget_instance>
 </widget_instances>
</profile>
\end{commandline}
このprofile.xmlおよび、Hoge.swfとopenlogo.pngをUSBメモリのvfat領域直下
にコピーします。これで、起動時にUSBメモリからこのWidgetが読み込まれるよ
うになります。

\subsubsection{スタンドアロンでの起動設定}
次に、スタンドアロンで先ほどのWidgetが読み込まれ、sshでログインできるよ
うにします。基本的にはフォーラム
\footnote{\url{http://forum.chumby.com/viewtopic.php?pid=12258}}の内容に
従って行えば問題ありません。
まず、
chumby-offline.zip\footnote{\url{http://stud3.tuwien.ac.at/~e9825447/chumby-offline.zip}}
をダウンロードします。展開するとoffline-howto.txtというドキュメントがあ
るので、これに従い設定します。profile.xmlは既に6.3.2で作成していますので、
これを利用してください。USBメモリのvfat領域の直下に以下のファイルをコピー
します。
\begin{itemize}
\item chumby-offline.zipを展開してできるofflineディレクトリ以下にある
      www/ディレクトリ\footnote{offline-howto.txtに従い、設定済みである
      こと。}
\item chumbyの/usr/widgets/controlpanel.swf
\end{itemize}
USBメモリのvfat領域の直下のdebugchumbyを次のように書き換えます。
\begin{commandline}
#!/bin/bash

killall httpd
/usr/sbin/httpd -h /mnt/usb/www
cp /mnt/usb/www/hosts.offline /psp/hosts
#cp /mnt/usb/www/hosts.online /psp/hosts

mount -o bind /proc /mnt/usb2/proc
mount -o bind /dev  /mnt/usb2/dev
mount -t devpts devpts /mnt/usb2/dev/pts/
chmod 666 /mnt/usb2/dev/null
chroot /mnt/usb2 /bin/hostname chumby
\end{commandline}
なお、オフラインモードからオフラインモードに戻す場合は、killallから３行
をコメントアウトし、hosts.onlineをコピーする行を有効にしてください。

そして最後に、USB-Ethernetアダプタを使い、有線LAN経由でアクセスできるよ
うに設定します。今までと同じく、vfat領域にuserhook1というファイルを作成
します。内容は以下のとおりです。
\begin{commandline}
#!/bin/sh

USE_DHCP=0
IPADDR=192.168.3.10
NETMASK=255.255.255.0
GATEWAY=192.168.3.1

/sbin/insmod /drivers/usbnet.ko
/sbin/insmod /drivers/pegasus.ko

ifconfig rausb0 127.0.0.1

if [ $USE_DHCP == 1 ]\daggerhen
   udhcpc -t 5 -n -p /var/run/udhcpc.eth0.pid -i eth0
else
   /sbin/ifconfig eth0 $IPADDR netmask $NETMASK
   /sbin/route add default gw $GATEWAY eth0
fi 
\end{commandline}
ちなみに、今回はBUFFALOのLUA2-TXを使っています。\footnote{これのデバイスドライ
バはpegasus.koです。}

以上で、まったくインターネットを使えない環境でも、有線LAN経由でSSH接続か
つ、液晶モニタ上にUSBに入れたWidgetを稼働させることができるようになりま
す。
\subsection{残作業}
以下が残っていますが、気が向いたらやるかもしれないし、やらないかもしれません。
\begin{itemize}
\item debootstrapでLenny arm版を作ってみてchroot環境として使えるか？
\item chroot環境からフレームバッファを乗っ取る。
\item ブートローダをハックして、直接USBブートさせる。
\end{itemize}
\subsection{おまけ：今月のヨメ八苦}
2月はこのOSC準備と別件で、ヨメよりも早く帰ってきても晩飯を作らなかった
（作れなかった）のと、毎週水曜にHack Meetingに参加するようになったため、
めっちゃ不機嫌になりました。コワ。方々のアドバイスを頂き、３月現在は``す
い〜つ''でなだめています。

\subsection{参考文献}
\begin{itemize}
\item chumbyで遊ぼう！

6.3.2のHoge.asは本書のp.48-49のMain.asを、profile.xmlはp.53のUSBメモリ
      用profile.xmlの例を、6.3.3のuserhook1はp.156のuserhook1を引用しま
      した。（一部パラメータを変更）

\begin{itemize}
\item ISBN : 978-4-7973-5039-5
\item 著者 : 米田 聡
\item 発行所 : ソフトバンククリエイティブ株式会社
\end{itemize}
\item Using Chumby offline  - Chumbysphere Forum
\begin{itemize}
\item \url{http://forum.chumby.com/viewtopic.php?pid=12258}
\end{itemize}
\item Hacking Linux for chumby - ChumbyWiki
\begin{itemize}
\item \url{http://wiki.chumby.com/mediawiki/index.php/Hacking_Linux_for_chumby}
\end{itemize}
\end{itemize}
\end{multicols}


\clearpage

%\printindex

\cleartooddpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\ \\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule


\end{document}
