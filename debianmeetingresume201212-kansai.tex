%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Kansai Debian Meeting resources
%     Copyright (C) 2007 Takaya Yamashita
%     Thank you for Tokyo Debian Meeting resources

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image200708; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{kansaimonthlyreport}
\usepackage[dvips]{xy}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2012}
\newcommand{\debmtgdate}{23}
\newcommand{\debmtgmonth}{12}
\newcommand{\debmtgnumber}{67}

\begin{document}

\begin{titlepage}

% 毎月変更する部分、本文の末尾も修正することをわすれずに

 第\debmtgnumber{}回 関西 Debian 勉強会資料

\vspace{2cm}

\begin{center}
\includegraphics{image200802/kansaidebianlogo.png}
\end{center}

\begin{flushright}
\hfill{}関西 Debian 勉強会担当者 佐々木・倉敷・のがた・かわだ \\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日
\end{flushright}

\thispagestyle{empty}
\end{titlepage}

\dancersection{Introduction}{Debian JP}

 関西Debian勉強会はDebian GNU/Linuxのさまざまなトピック
 (新しいパッケージ、Debian特有の機能の仕組、Debian界隈で起こった出来事、
 などなど）について話し合う会です。

 目的として次の三つを考えています。
 \begin{itemize}
  \item MLや掲示板ではなく、直接顔を合わせる事での情報交換の促進
  \item 定期的に集まれる場所
  \item 資料の作成
 \end{itemize}

 それでは、楽しい一時をお楽しみ下さい。

\newpage

\begin{minipage}[b]{0.2\hsize}
 {\rotatebox{90}{\fontsize{80}{80}
{\gt 関西 Debian 勉強会}}}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\setcounter{tocdepth}{1}
\tableofcontents
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{最近のDebian関係のイベント報告}{Debian JP}

\subsection{第 66 回関西 Debian 勉強会}

66 回目の関西 Debian 勉強会は 11 月 9 日、10 日に行なわれた関西オープンソース2012に出展しました。

インフォグラフィック、Wheezy DI Beta3 の DVD 配布とインストーラの実機展示、物販をブースで行ない、「Debian 7.0 "Wheezy" の紹介」と題してセミナー発表を行ないました。


\subsection{第 95 回東京エリア Debian 勉強会}
95 回目の東京エリア Debian 勉強会は 12 月 15 日に開催されました。

「im-config」、「２０１２年度東京エリアDebian勉強会の振り返り」、「日本におけるDFSGの求める自由と２０１２年改正著作権法」といった内容でした。

事前課題の各自の DFSG に関する理解から著作権、TPP と盛り上ったようです。im-config については資料に掲載されていませんのでご注意を。


\dancersection{事前課題}{Debian JP}

今回は以下の課題を出題しました.
\begin{screen}
  \begin{enumerate}
  \item 関西Debian勉強会で今年印象に残った話と来年聞きたい話を教えてください。
  \item DebianPolicy の6章に目を通しておいてください。
  \end{enumerate}
\end{screen}

参加者の皆さんの解答は以下の通りです。

\begin{prework}{ 佐々木洋平 }
未回答
\end{prework}

\begin{prework}{ のがたじゅん }
  \begin{enumerate}
  \item 今年印象に残ったのは勉強会に入らないかもしれないけど大統一と、LDAP周りはあまり話しをする事がないから残ったかな。
    来年は、パッケージを久々に作ろうと思ったら浦島太郎状態だったので今どきのパッケージの作り方とか?
  \item わかりました。
  \end{enumerate}
\end{prework}

\begin{prework}{ かわだてつたろう }
  \begin{enumerate}
  \item 温泉合宿、大統一、Ralf さんの話しがよかったです。
    来年は月刊 Debian Policy と LDAP の話しの続きをやりたいですね。
  \end{enumerate}
\end{prework}

\begin{prework}{ cuzic }
  \begin{enumerate}
  \item 初参加なので、分かりません。。。Debian も初心者なんで。
  \item 当日までにやっておきます。。。
  \end{enumerate}
\end{prework}

\begin{prework}{ yyatsuo }
  \begin{enumerate}
  \item 前半はパッケージ系(やってみた)が多く、後半は LDAP などの認証系の話題が多かったのが印象的でした。
    他にも温泉合宿、大統一勉強会、Ralf さんの EDOS の話なんかがありましたね。\\
    来年は西田さんと酒井さんのパッケージの今後を見守りたいですね。
  \item 見ておきます
  \end{enumerate}
\end{prework}

\begin{prework}{ lurdan }
  \begin{enumerate}
  \item 温泉合宿と大統一がよかったですねー。
    あと、Debian Policy の輪読や複数の人が新たにパッケージ作成に挑戦、などなど新しい試みもあったなぁとか。
    来年は wheezy も出るはずなので、またサイクルを戻して初心者講座とかするのがいいのかなぁ。
  \item ざっくりと見ておきました
  \end{enumerate}
\end{prework}

\begin{prework}{ 大林 }
  \begin{enumerate}
  \item 今回初めて参加するので「特になし」ということで
  \end{enumerate}
\end{prework}

\begin{prework}{ ワチ　マサタカ }
  \begin{enumerate}
  \item 初参加なので印象に残った話はわからないです。\\
    来年は、パッケージメンテナの人が仕事とどう両立させてるかを聞いてみたいです。
  \item 通しておきます。
  \end{enumerate}
\end{prework}

\begin{prework}{ 山城の国の住人 久保博 }
  \begin{enumerate}
  \item 
    \begin{itemize}
    \item 今年印象に残った話
      \begin{itemize}
      \item 「スクリプト言語 Konoha の Debianパッケージ化」\\
        Konoha がライセンスに関して混沌としていたのが衝撃的でした。
      \item 「News from EDOS: finding outdated packages」\\
        パッケージ管理の問題がコンピュータ科学の研究テーマに
        なっていることに感銘を受けました。
      \item 「Debian ではじめる Kerberos 認証」\\
        Active Directory 連係以外で Kerberos が使われていることや、
        今でも開発され続けているのが意外でした。
      \item また、翻訳について盛り上がったことが印象に残りました。
      \end{itemize}
    \item 来年聞きたい話
      \begin{itemize}
      \item wheezy への移行について
      \item samba4 とどうつき合っていけばいいか
      \item 開発に関すること
      \end{itemize}
    \end{itemize}
  \end{enumerate}
\end{prework}

\begin{prework}{  清野陽一 }
  \begin{enumerate}
  \item あまり参加できなかったので…。来年はたくさん参加して色々な話を聞きたいです。
  \item はーい
  \end{enumerate}
\end{prework}


\clearpage

\dancersection{Android端末（Asus Transformer TF201）へのDebianインストール奮闘記}{cuzic}

\subsection{はじめに}
\begin{itemize}
 \item cuzic
       \begin{itemize}
        \item きゅーじっく
        \item 親指シフトキーボード使い
              \begin{itemize}
               \item 親指シフト:濁音（が だ）、捨て仮名（ゃ っ）をすべて1打鍵で入力可能
               \item 親指シフトキーボードのために普段はWindowsを利用
              \end{itemize}
       \end{itemize}
 \item 最近の出来事
       \begin{itemize}
        \item Windows 8のタッチ対応のUltrabookが欲しい
              \begin{itemize}
               \item Ultrabook 
               \item タッチパネル対応
               \item フルHD (1920x1080) の高画質
               \item まともな日本語キーボード
               \item D-Sub 15pin による出力が可能（プレゼン用）
              \end{itemize}
        \item お金がなくてなかなか買えない・・・
              \begin{itemize}
               \item Android端末 (Asus Transformer Prime）を所有
              \end{itemize}
        \item Android 端末でも十分開発できるようにLinux環境構築に挑戦
       \end{itemize}
\end{itemize}

\subsection{Asus Eee Pad Transformer Prime}
\begin{itemize}
 \item Eee Pad Transformer Prime (日本名 TF201）
       \begin{itemize}
        \item キーボード付きAndroidタブレット
        \item キーボードはバッテリーでもあり、駆動時間は最大18時間
        \item 実際、日帰り出張でもまったく問題なし
       \end{itemize}
 \item 外部メモリが 64GB もある
       \begin{itemize}
        \item 正直、Androidでは使いきれない…
        \item Linuxも入れちゃおう！！！
       \end{itemize}
\end{itemize}

\subsection{むかしむかし}
\begin{itemize}
 \item 実は、TF201を買ってすぐもLinux動作にチャレンジ
 \item ぜんぜんダメだった。
       \begin{itemize}
        \item いろんなキーが入力できない
              \begin{itemize}
               \item Ctrl、Alt、｀(backtick）、＠(atmark)
              \end{itemize}
        \item ほかにもいろいろあったはずだけど思い出せない…
       \end{itemize}
 \item ほかの方法も考えた
       \begin{itemize}
        \item AndroidとLinuxのデュアルブートとか
        \item もとの環境をつぶしてLinuxだけにするとか
        \item けど、できたらAndroidの中でアプリみたいな形でLinuxを動かしたい
       \end{itemize}
 \item 今回、再チャレンジ！
\end{itemize}

\subsection{まずは Ubuntu で試そうとしてみた}
\begin{itemize}
 \item まずは root 化する
       \begin{itemize}
        \item 基本。
        \item xda-developers.com \footnote{\url{http://forum.xda-developers.com/showthread.php?t=1706588}} からツールをダウンロードして実行
        \item bat を実行するとあとはうまくやってくれる
       \end{itemize}
\item Ubuntu Installer for Android
      \begin{itemize}
       \item google play \footnote{\url{https://play.google.com/store/apps/details?id=com.appbuilder.u14410p30729&hl=ja}} からダウンロードし、インストール
       \item このアプリは実は手順書だけ。自動インストールじゃない(汗)
       \item 3種類の Ubuntu イメージがある
             \begin{itemize}
              \item Full……Unity とかといっぱいの GUI プログラム
              \item Small…LXDE と Firefox などの基本的な GUIプログラム
              \item Core……GUI なし。基本的なコマンドのみ
             \end{itemize}
      \end{itemize}
\end{itemize}

\subsection{Ubuntu インストール（Full 編）}

\begin{itemize}
 \item まずは、Full 版イメージを試そうとしてみる
       \begin{itemize}
        \item UnityとかといっぱいのGUIプログラム（3.5GB相当）
       \end{itemize}
 \item ぜんぜんうまくいかず、挫折
       \begin{itemize}
        \item インストール編
              \begin{itemize}
               \item 大きすぎて、Androidからうまくダウンロードできない
               \item パソコンからダウンロードして、Androidに移動させる
              \end{itemize}
        \item 動作編
              \begin{itemize}
               \item Unity が重すぎて、うまく動かない orz
               \item そもそも、Firefoxがぜんぜん動かない
               \item LXDE をインストールしてみる。
               \item ほかもいろいろインストールしてみる。
                     \begin{itemize}
                      \item あっという間に容量上限（4GB）に達する
                     \end{itemize}
              \end{itemize}
        \item Small に変更して、再チャレンジしてみる。
       \end{itemize}
\end{itemize}

\subsection{Ubuntu インストール（small 編）}

\begin{itemize}
 \item Small 編
       \begin{itemize}
        \item LXDEとFirefox等の GUIプログラムつき
        \item 全体で 1.5 GBだから軽い
       \end{itemize}
 \item まずまずうまくいったが、やっぱ挫折
       \begin{itemize}
        \item うまくいった点
              \begin{itemize}
               \item LXDEはだいぶ軽い。ちゃんと動く。
               \item 開発環境構築関係についてはうまくいった
              \end{itemize}
        \item だけど…
              \begin{itemize}
               \item やっぱりFirefoxは動かない
               \item Chromiumも動かない
               \item Konquerorは動く
              \end{itemize}
       \end{itemize}
 \item タイムリーにLurdanさんと話した結果、Debianで再チャレンジすることに。
\end{itemize}

\subsection{Debian をインストール}
  \begin{itemize}
   \item Debian Kit for Android \footnote{\url{http://sven-ola.dyndns.org/repo/debian-kit-en.html}}を使ってインストールした
   \item インストール方法
         \begin{itemize}
          \item 基本的には手順に従うだけ
          \item Debian 6.0.6 (squeeze) をインストールしてみた。
          \item apt-get install andromize が重要
                \begin{itemize}
                 \item Android側に追随して /etc/resolv.conf を変更する
                \end{itemize}
         \end{itemize}
   \item 動作概要

   \begin{itemize}
    \item img ファイルを loopデバイスとしてマウント
    \item chroot せず、/ 以下に usr、var などが配備される
    \item VNCサーバを起動し、AndroidアプリのVNCクライアントから、DebianのX環境にアクセスする
   \end{itemize}
   \item 結果
         \begin{itemize}
          \item Firefox（iceweasel）もちゃんと動作した！
          \item ほかのいろんなのもまぁまぁ動いた
         \end{itemize}
  \end{itemize}

\subsection{容量を増やした}
\begin{itemize}
 \item Linuxが4GB（初期値）では足りない
       \begin{itemize}
        \item 10GBくらいはDebianに割当てたい
       \end{itemize}
 \item Windows PCのVirtualboxのUbuntuで下記手順を実施
\end{itemize}

\begin{commandline}
# virtualbox側で
nc -l 9000 > debianold.img
# asus transformer prime 側で
busybox nc virtualbox 9000 < /sdcard/debian.img
# virtualbox 側で
dd if=/dev/zero of=debiannew.img bs=1M count=0 seek=10240
mke2fs -F debiannew.img
mkdir debianold debiannew
sudo mount -o loop debianold.img debianold
sudo mount -o loop debiannew.img debiannew
rsync debianold/ debiannew
umount debianold; debiannew
# asus transformer prime 側で
busybox nc -l -p 9000 > /sdcard/debian.img
# virtualbox 側で
nc prime 9000 < debiannew.img
\end{commandline}

\subsection{ハマったところ}
\begin{itemize}
 \item 追加インストールが結構必要
       \begin{itemize}
        \item （例） sudo 、netcat 
        \item Ubuntu にあるパッケージがDebianだと見つからない
              \begin{itemize}
               \item （例）leiningen（プログラミング言語clojure用の便利ツール）
              \end{itemize}
       \end{itemize}
 \item root だとネット接続可能なのに、自分で追加したユーザではネット接続不可
       \begin{itemize}
        \item 適切なグループへの追加が必要だったらしい。（ Paranoid
              Network- ing
              \footnote{\url{http://elinux.org/Android_Security}} ）
        \begin{commandline}
usermod -G inet,net\_raw,net\_admin cuzic
        \end{commandline} 
       \end{itemize}
 \item /debian ディレクトリに直接ファイルを配置したが失敗
       \begin{itemize}
        \item loop デバイスとしてマウントせず、そのまま同居したかった
        \item /debian/\{usr,etc,varなど\} を置いてみた
        \item SDカードのファイルシステムがFAT32(?)でpermissionをうまく設定できず失敗=> loop デバイスの方法で利用し続けることにした。
       \end{itemize}
 \item Ctrl, Altがうまく使えない
       \begin{itemize}
        \item Emacsなどの利用において、致命的な問題
        \item AndroidのVNC Player側の問題
        \item 改変版のAndroid VNC Viewerを使うことで解決
        \item ※ ここ
              \footnote{\url{http://code.google.com/p/android-vnc-viewer/issues/detail?id=238}}
              の Comment 28 でコンパイル済みのバイナリを利用
       \end{itemize}
\end{itemize}

\subsection{まだできていないこと}
\begin{itemize}
 \item OpenOffice.org 、LibreOfficeの利用
      \begin{itemize}
       \item なんでか、 Impressをインストールできなかった
      \end{itemize}
 \item Caps lock、「半角／全角」、「無変換」、「変換」キーの利用
       \begin{itemize}
        \item VNCプレイヤー側の問題
        \item Android側ではキーイベントを拾えるみたい
        \item 無変換、変換が使えれば夢の 親指シフト化 が実現！
        \item Caps lockとCtrlを入れ替えたい
        \item 「半角／全角」をESCにしたい
       \end{itemize}
 \item Clojure開発環境での構築
       \begin{itemize}
        \item Ubuntu だと leiningen のパッケージがある
        \item Debian には leiningen のパッケージがない
       \end{itemize}
\end{itemize}

\subsection{まとめ}
\begin{itemize}
 \item Android タブレットでのDebian稼働は十分実用的
       \begin{itemize}
        \item ブラウザやエディタも十分動かせる
        \item 容量も十分なサイズでできる
        \item 一部のキー配列（Ctrl、ESC）が気になるくらい
        \item ちょっと動作はやっぱ遅い
       \end{itemize}
 \item Android 環境とDebian環境を同時実行できるのも便利
       \begin{itemize}
        \item ブラウザはAndroidのブラウザで
        \item 開発はDebianのvi/emacsで
       \end{itemize}
 \item Android タブレットの長所を持つ開発環境の誕生
       \begin{itemize}
        \item バッテリーが長持ち、薄くて軽い
       \end{itemize}
 \item けど、ほんとうは新しいノートパソコンが欲しい
       \begin{itemize}
        \item お金がないから、AndroidタブレットのDebian化で我慢
       \end{itemize}
\end{itemize}

\clearpage

\dancersection{月刊 Debian Policy「パッケージ管理スクリプトとインストールの手順」}{かわだ てつたろう}

月刊 Debian Policy、今回読むのは第 6 章の「パッケージ管理スクリプトとインストールの手順」です。
この章ではパッケージをインストール、アップグレード、削除する際にパッケージ管理システムが走らせるスクリプトとその手順について説明されています。

さて、事前課題で内容は読んで理解していただいていると思いますのでざっと内容をみていきましょう。

\subsection{パッケージ管理スクリプト}
パッケージ管理スクリプトは次の 4 つの制御情報ファイルで、パッケージの一部として供給されます。

\begin{itemize}
\item preinst
\item postinst
\item prerm
\item postrm
\end{itemize}



\subsubsection{ファイル構成}
パッケージ管理スクリプトは実行可能ファイルでなければならず、ファイルのパーミッションは、誰でも読むことと実行可能でなければならないが誰でも書き込み可能ではいけない、{\tt 755} でなければいけません。
また、スクリプトであることが推奨されており、その場合は {\tt \#!} (shebang) で始まってなければなりません。

\subsubsection{終了ステータス}
パッケージ管理システムは終了ステータスコードを参照するので正しく終了ステータスコードを返すことが重要です。
処理が成功すれば 0 を、失敗すれば 0 以外を返さなければなりません。0 以外のステータスコードが返された場合、パッケージ管理システムはエラーと判断し以降の処理を停止します。

パッケージ管理スクリプトがシェルスクリプトなら常に {\it set -e} を使用する必要があります。

\subsubsection{PATH 環境変数}
{\tt PATH} 環境変数内から見つかることが期待できるプログラムは絶対パスで呼びだすべきではありません。
また、{\tt PATH} 環境変数はリセットすべきではありませんが、前後に付け加えることはかまいません。

\subsubsection{再入結果の同一性}
パッケージ管理スクリプトは、一度成功した処理を何度呼び出しても無害でなければならず、
失敗や中断した処理を再度呼び出しても前回の残された状態から実行しなければなりません。
いずれにせよ全ての処理が成功した場合にはパッケージ管理スクリプトは成功ステータスで終了しなければなりません。

これは、ひどく壊れたパッケージが残らないようにするためにとても重要です。

\subsubsection{パッケージ管理スクリプトからのターミナルの制御}
パッケージ管理スクリプトは、制御端末がある状態での実行が保証されていません。
ユーザとの対話ができない場合がありますので、非対話型で処理できるようにしなければなりません。

どうしても対話が必要な場合(優先順位が高く、妥当な標準回答がないなど)に制御端末が無ければパッケージ管理スクリプトは異常終了してもかまいません。
ただ、できるだけこのような状況は避けるべきです。たいていの場合、パッケージのバグと判断されます。

{\tt debconf} を用いる場合はの詳細は「3.9.1 メンテナスクリプト中のプロンプト使用について」を参照してください。


\subsection{パッケージ管理スクリプトの呼ばれ方のまとめ}
パッケージ管理スクリプトがそれぞれ呼ばれるタイミングをおおまかにいうと次のようになります。

\begin{itemize}
\item preinst  … パッケージ展開前
\item postinst … パッケージ展開後
\item prerm    … パッケージ削除前
\item postrm   … パッケージ削除後
\end{itemize}

ここからは、パッケージ管理スクリプトのすべての呼ばれ方と、呼ばれる際に依存して良い機能についてのまとめです。
{\it new-} はインストール/更新/ダウングレード対象の新バージョンのパッケージから呼ばれるもの、
{\it old-} は更新/ダウングレードされる対象の旧バージョンのパッケージから呼ばれるものです。


\subsubsection{preinst}

\begin{itemize}
\item {\it new-preinst} install
\item {\it new-preinst} install {\it old-version}
\item {\it new-preinst} upgrade {\it old-version}
  \begin{itemize}
  \item パッケージは展開前
  \item essential パッケージと Pre-Depends パッケージのファイルのみがある
  \item Pre-Depends パッケージは展開された直後か Half-Configured の可能性がある
  \end{itemize}
\end{itemize}

\begin{itemize}
\item {\it old-preinst} abort-upgrade {\it new-version}
  \begin{itemize}
  \item アップグレードに失敗した場合に呼ばれる
  \item 展開されたファイルに依存してはいけない
  \item パッケージの依存関係は満たされていないかもしれない
  \item Pre-Depends は上記と同様
  \end{itemize}
\end{itemize}


\clearpage

\subsubsection{postinst}

\begin{itemize}
\item {\it postinst} configuire {\it most-recently-configured-version}
  \begin{itemize}
  \item パッケージと依存パッケージのファイルは展開されている
  \item 巡回依存関係になければ依存パッケージは設定されている
  \end{itemize}
\end{itemize}

\begin{itemize}
\item {\it old-postinst} abort-upgrade {\it new-version}
\item {\it conflictor's-postinst} abort-remove in-favour {\it package} {\it new-version}
\item {\it postinst} abort-remove
\item {\it deconfigured's-postinst} abort-deconfigure in-favour {\it failed-install-package} {\it version} [removing {\it conflicting-package} {\it version}]
  \begin{itemize}
  \item パッケージのファイルは展開されている
  \item 依存する全てのパッケージは少くとも Half-Installed 状態、完全に展開されていないこともある
  \item 依存関係が必要となる処理は実行するべきである、依存関係が満たされていないたいていの場合 {\tt postinst} を異常終了させるのがエラー処理を考慮すると適切な処理である
  \end{itemize}
\end{itemize}


\subsubsection{prerm}

\begin{itemize}
\item {\it prerm} remove
\item {\it old-prerm} upgrade {\it new-version}
\item {\it conflictor's-prerm} remove in-favour {\it package} {\it new-version}
\item {\it deconfigured's-prerm} deconfigure in-favour {\it package-being-installed} {\it version} [removing {\it conflicting-package} {\it version}]
  \begin{itemize}
  \item パッケージは Half-Installed 状態
  \item 依存する全てのパッケージは少くとも Half-Installed 状態、完全に展開されていないエラー状態なこともある
  \end{itemize}
\end{itemize}

\begin{itemize}
\item {\it new-prerm} failed-upgrade {\it old-version}
  \begin{itemize}
  \item {\it prerm} upgrade が失敗した際に呼び出される
  \item 新しいパッケージは展開されておらず {\it preinst} upgrade と同じ制約下にある
  \end{itemize}
\end{itemize}


\subsubsection{postrm}

\begin{itemize}
\item {\it postrm} remove
\item {\it postrm} purge
\item {\it old-postrm} upgrade {\it new-version}
\item {\it disappearer's-postrm} disappear {\it overwriter} {\it overwriter-version}
  \begin{itemize}
  \item パッケージのファイルが削除、置き換えられた後に呼び出される
  \item 依存関係は考慮されていない状態
  \item essential パッケージのみに依存した処理とすること
  \item 依存関係が必要な処理で依存関係が満たされていない場合はすべて丁寧に処理を飛ばすようにしなければいけない
  \end{itemize}
\end{itemize}


\begin{itemize}
\item {\it new-postrm} failed-upgrade {\it old-version}
  \begin{itemize}
  \item 古いパッケージの {\it postrm} upgrade が失敗した場合に呼ばれる
  \item 新しいパッケージのファイルは展開されているが、essential パッケージと Pre-Depends パッケージのみへ依存できる
  \end{itemize}
\end{itemize}

\begin{itemize}
\item {\it new-postrm} abort-install
\item {\it new-postrm} abort-install {\it old-version}
\item {\it new-postrm} abort-upgrade {\it old-version}
  \begin{itemize}
  \item preinst が失敗したエラー処理の一環で新しいパッケージを展開する前に呼ばれる
  \item preinst と同じ制約下
  \end{itemize}
\end{itemize}



\subsection{各段階の詳細}
ここでは流れを掴みやすくするためエラー処理を省いたパッケージのインストール、設定、削除の詳細をみていきます。
エラー処理について元のポリシーに記述されていますので参照してください。


\subsubsection{インストール時とアップグレート時のパッケージの展開段階の詳細}
\begin{enumerate}

\item インストールされたパッケージがある場合
  \begin{itemize}
  \item {\it old-prerm} upgrade {\it new-version}
  \end{itemize}

\item 衝突するパッケージが削除されようとしているか、壊れたパッケージ(Breaks のため)の場合
  \begin{enumerate}
  \item --auto-deconfigure が指定されていた場合
    \begin{enumerate}
    \item Breaks で設定破棄されるパッケージに対して
      \begin{itemize}
      \item {\it deconfigured's-prerm} deconfigure in-favour {\it package-being-installed} {\it version}
      \end{itemize}
    \item 削除されようとしている衝突するパッケージが依存するパッケージに対して
      \begin{itemize}
      \item {\it deconfigured's-prerm} deconfigure in-favour {\it package-being-installed} {\it version} removing {\it conflicting-package} {\it version}
      \end{itemize}
    \end{enumerate}
  \item 衝突して削除されるパッケージに対して
    \begin{itemize}
    \item {\it conflictor's-prerm} remove in-favour {\it package} {\it new-version}
    \end{itemize}
  \end{enumerate}

\item 
  \begin{enumerate}
  \item アップグレードの場合
    \begin{itemize}
    \item {\it new-preinst} upgrade {\it old-version}
    \end{itemize}
  \item 設定ファイルが残っていた場合
    \begin{itemize}
    \item {\it new-preinst} install {\it old-version}
    \end{itemize}
  \item それ以外(purge された状態)の場合
    \begin{itemize}
    \item {\it new-preinst} install
    \end{itemize}
  \end{enumerate}

\item 新しいパッケージのファイルを展開し上書き(古いファイルはバックアップされる)
  \begin{itemize}
  \item Replace 指定なしに既にシステムにある他のパッケージのファイルを含んでいるとエラー
  \item 同じく Replace 指定なしに他のパッケージのディレクトリと同名のファイルやディレクトリ以外のものを含んでいるとエラー
    \begin{itemize}
    \item --force-overwrite-dir でエラーを無効にできるが、勧められない
    \item ディレクトリがシンボリックリンクで置き換えられることはないし、逆もまたない
    \end{itemize}
  \end{itemize}
 
\item アップグレードされた場合
  \begin{itemize}
  \item {\it old-postrm} upgrade {\it new-version}
  \end{itemize}

{\underline {\Large ここが戻れなくなるポイント}}


\item 新しいパッケージで使われなくなった古いパッケージのファイルを削除

\item 新しいファイルリストに更新

\item 新しいパッケージ管理スクリプトに更新

\item 全てのファイルが上書きされ、要求も依存もされなくなったパッケージがあった場合(削除されたとみなされ次の処理が行われる)
  \begin{enumerate}
  \item {\it disappearer's-postrm} disappear {\it overwriter} {\it overwriter-version}
  \item パッケージ管理スクリプトの削除
  \item パッケージがインストールされていない状態となる。(conffile は無視され、prerm も呼び出されない)
  \end{enumerate}

\item 新しいパッケージのファイルが他のパッケージのファイルリストに記されていれば、それらをリストから削除

\item バックアップファイルを削除

\item 新しいパッケージを unpacked 状態にする\\
{\underline {\Large もう一つの戻れなくなるポイント}}

\item 衝突するパッケージがあればそれらの削除処理へ

\end{enumerate}

\subsubsection{設定の詳細}
\begin{enumerate}
\item conffile を更新して
  \begin{itemize}
  \item {\it postinst} configure {\it most-recently-configured-version}
  \end{itemize}
  エラーが起こっても回復処理は行なわれず Failed Config 状態になる
\end{enumerate}


\subsubsection{削除と設定の完全削除の詳細}
\begin{enumerate}
\item {\it prerm} remove

\item パッケージのファイルを削除(conffile を除く)

\item {\it postrm} remove

\item postrm を除く全パッケージ管理スクリプトの削除\\
  purge でなければここで終了。purge でなくても postrm と conffile がなければ purge と同じ状態になる。

\item conffile とバックアップファイルを削除

\item {\it postrm} purge

\item パッケージのファイルリストを削除(postrm もここで削除)

\end{enumerate}


\subsection{最後に}
次回の月刊 Debian Policy は。。。


\clearpage

\dancersection{2012年の振り返りと2013年の企画}{Debian JP}

\clearpage

\dancersection{今後の予定}{Debian JP}

\subsection{関西 Debian 勉強会}

次回、第 67 回関西 Debian 勉強会は 1 月 27 日(日)に国際奈良学セミナーハウスで行ないます。


\subsection{東京エリア Debian 勉強会}
1 月 19 日(土)に 96 回目の東京エリア Debian 勉強会が開催されます。


% 冊子にするために、4の倍数にする必要がある。
% そのための調整
%% \dancersection{メモ}{}
%% \mbox{}\newpage
%% \mbox{}\newpage

\printindex
 \cleartooddpage

 \begin{minipage}[b]{0.2\hsize}
  \rotatebox{90}{\fontsize{80}{80} {\gt 関西 Debian 勉強会} }
 \end{minipage}
 \begin{minipage}[b]{0.8\hsize}

 \vspace*{15cm}
 \rule{\hsize}{1mm}
 \vspace{2mm}
 \includegraphics[width=2cm]{image200502/openlogo-nd.eps}
 \noindent \Large \bf Debian 勉強会資料\\ \\
 \noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
 \noindent \normalfont 関西 Debian 勉強会 （編集・印刷・発行）\\
 \rule{\hsize}{1mm}
 \end{minipage}

\end{document}
