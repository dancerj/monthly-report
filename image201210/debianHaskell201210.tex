
%% -Haskell のパッケージおよび依存関係の仕組みである Cabal, Hackage,

\subsection{Hackage\protect\footnote{http://hackage.haskell.org/}}

Haskellで書かれたライブラリやツールのパッケージ配布サイト。PerlでのCPANのようなもの。
このHaskellのパッケージはしばしばHackageと呼ばれます。

\begin{commandline}
http://hackage.haskell.org/package/<hackageの名前>
\end{commandline}

各Hackageにはバージョン情報やライブラリ依存関係情報が含まれています。

language-objcパッケージの例:

\begin{commandline}
Name:          language-objc
Version:       0.4.2.5
...
Library
...
    Build-Depends: base       >= 3 && < 5,
                   filepath   >= 1.1 && < 1.4,
                   process    == 1.1.*,
                   directory  >= 1.1 && < 1.3,
                   array      == 0.4.*,
                   containers >= 0.4     && < 0.6,
                   newtype    == 0.2.*,
                   pretty     == 1.1.*
...
    Build-Tools:    happy, alex
\end{commandline}

\subsection{Cabal\protect\footnote{http://hackage.haskell.org/package/Cabal} ライブラリと
cabal-install\protect\footnote{http://hackage.haskell.org/package/cabal-install}}

Cabalは依存関係にしたがってパッケージをHackageのサイトから取ってきたり、
パッケージのソースツリーと手元の環境からパッケージをbuildしたりするライブラリです。

cabal-installはCabalライブラリをコマンドラインから呼び出すためのツールです。
hackageの名前はcabal-installですが、コマンドの名前は cabalです。簡単な利用方法は以下のような感じになります。

\begin{commandline}
% cabal unpack language-objc
% cd language-objc-0.4.2.5
% cabal configure
% cabal build
% cabal copy
% cabal register
\end{commandline}

あるいは

\begin{commandline}
% cabal install language-objc
\end{commandline}

Cabalライブラリ, cabal-install のどちらも Haskell で書かれていて Hackage に置かれています。
現在の事実上標準のHaskell処理系はGlasgow Haskell Compiler(GHC)であるが、
CabalライブラリはGHCのソースツリーに含まれる形で配布されています。
通常の開発環境で利用されるのはこの含まれているCabalライブラリです。

%% -その情報を利用して Debian パッケージを作る cabal-debian コマンドおよび debian ライブラリ,

\subsection{debian\protect\footnote{http://hackage.haskell.org/package/debian} ライブラリと
cabal-debian\protect\footnote{http://hackage.haskell.org/package/cabal-debian} }

debianはDebianソースパッケージの情報をハンドリングするためのライブラリです。
このライブラリを使って作られているcabal-debianというツールで、
次のようにHackageのソースをDebianのソースパッケージに変換することができます。

\begin{commandline}
% cabal unpack language-objc
% cd language-objc-0.4.2.5
% cabal-debian --debianize
\end{commandline}

次のような感じでうまく依存関係の情報が変換されます。

\begin{commandline}
% cat debian/control
Source: haskell-language-objc
Priority: extra
Section: haskell
...
Build-Depends: debhelper (>= 7.0),
               haskell-devscripts (>= 0.8),
               cdbs,
               ghc,
               ghc-prof,
               libghc-newtype-dev (>= 0.2) | libghc-newtype-dev (<< 0.3),
               libghc-newtype-prof (>= 0.2) | libghc-newtype-prof (<< 0.3),
               libghc-syb-dev (>= 0.3) | libghc-syb-dev (<< 0.4),
               libghc-syb-prof (>= 0.3) | libghc-syb-prof (<< 0.4),
               happy,
               alex
Build-Depends-Indep: ghc-doc,
                     libghc-newtype-doc (>= 0.2) | libghc-newtype-doc (<< 0.3),
                     libghc-syb-doc (>= 0.3) | libghc-syb-doc (<< 0.4)
...
\end{commandline}

ライブラリのパッケージだと、そのまま利用できる程度のものが自動的に生成されます。
実行ファイルがあるものについてはrulesにインストール先を書く必要があります。

現在のDebianでは libghc-<hackageの名前>-{dev,prof,doc} という名前で Debianパッケージが作られます。
libghc-*-devは開発用ライブラリ、libghc-*-profはプロファイル情報取得用のライブラリ、libghc-*-docはライブラリドキュメントです。

Haskellの場合は haddock というツールでソースコード内の特定の形式のコメントがドキュメントに変換されます。
libghc-*-docはここから作られます。

%% -Debhelper との連携のためのスクリプトである haskell-devscripts

\subsection{haskell-devscripts}

cabal-debian で作られたDebianのソースパッケージは
haskell-devscripts に含まれているcdbs用のMakefile (hlibrary.mk)を
利用するように構成されています。

\begin{commandline}
% cat debian/rules
#!/usr/bin/make -f
include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/hlibrary.mk

# How to install an extra file into the documentation package
#binary-fixup/libghc-language-objc-doc::
#	echo "Some informative text" > debian/libghc-language-objc-doc/usr/share/doc/libghc-language-objc-doc/AnExtraDocFile
\end{commandline}

dh\_haskell\_* のコマンド群はhlibrary.mk から利用されている。
各コマンドは基本的にはGHCのインストール情報管理用のファイルを利用しつつ、*.substvarsを出力します。

\begin{description}
\item[dh\_haskell\_depends] Haskellのライブラリの依存関係をDebianの依存関係に変換します。
\item[dh\_haskell\_extra\_depends] データのパッケージや実行プログラムのパッケージといった、
ライブラリの依存関係では解決できない依存関係をDebianの依存関係に変換します。
\item[dh\_haskell\_provides] HaskellのライブラリのDebian仮想パッケージも含めた提供情報を計算します。
\item[dh\_haskell\_shlibdeps] Haskellのライブラリが依存している
バイナリのライブラリアーカイブ(.a)を提供しているパッケージを計算しDebianの依存関係として出力します。
\end{description}
