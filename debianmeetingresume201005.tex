%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Tokyo Debian Meeting resources
%     Copyright (C) 2010 Junichi Uekawa
%     Copyright (C) 2010 Nobuhiro Iwamatsu

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image201005; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}
\usepackage{wrapfig}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2010}
\newcommand{\debmtgmonth}{5}
\newcommand{\debmtgdate}{17}
\newcommand{\debmtgnumber}{64}

\begin{document}

\begin{titlepage}
\thispagestyle{empty}

% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料\\
\hspace*{-2cm}
\includegraphics[width=210mm]{image201003/debsen.eps}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

% ここはアップデートすること
\rotatebox{10}{\fontsize{32}{32} {\gt 特集１: ＸＸＸＸ}}

\rotatebox{10}{\fontsize{32}{32} {\gt 特集２: ＸＸＸＸ} }

\vspace*{-2cm}
\hfill{}\includegraphics[height=6cm]{image200502/openlogo-nd.eps}
\end{titlepage}

\dancersection{Introduction}{上川 純一}

\begin{multicols}{2}
 
 
 今月のDebian勉強会へようこそ。これからDebianの世界にあしを踏み入れると
 いう方も、すでにどっぷりとつかっているという方も、月に一回Debianについ
 て語りませんか？

 Debian勉強会の目的は下記です。

 \begin{itemize}
 \item \underline{Debian Developer} (開発者)の育成。
 \item 日本語での「\underline{開発に関する情報}」を整理してまとめ、アップデートする。
 \item \underline{場}の提供。
 \begin{itemize}
  \item 普段ばらばらな場所にいる人々が face-to-face で出会える場を提供
	する。
  \item Debian のためになることを語る場を提供する。
  \item Debianについて語る場を提供する。
 \end{itemize}
 \end{itemize}		

 Debianの勉強会ということで究極的には参加者全員がDebian Packageをがりがり
 と作るスーパーハッカーになった姿を妄想しています。情報の共有・活用を通し
 て Debianの今後の能動的な展開への土台として、「場」としての空間を提供す
 るのが目的です。

\end{multicols}

\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\tableofcontents
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{事前課題}{上川 純一}

今回の事前課題は以下です:

\begin{enumerate}
 \item 普段使っているLinuxディストリビューションと使ってみたいLinuxディ
       ストリビューションは何ですか？使っている理由、魅力、不満点、使っ
       てみたい理由を教えてください。
\end{enumerate}

この課題に対して提出いただいた内容は以下です。

% \input{image201005/prework.tex}

\dancersection{最近のDebian関連のミーティング報告}{岩松信洋}
\subsection{東京エリアDebian勉強会63回目報告}
% (query-replace-regexp "<.*?>" "")
% (query-replace-regexp "^[	 ]\+" "")


\dancersection{Debian Trivia Quiz}{岩松 信洋}

ところで、みなさん Debian 関連の話題においついていますか？Debian関連の話
題はメーリングリストをよんでいると追跡できます。ただよんでいるだけではは
りあいがないので、理解度のテストをします。特に一人だけでは意味がわからな
いところもあるかも知れません。みんなで一緒に読んでみましょう。

今回の出題範囲は\url{debian-devel-announce@lists.deban.org} に投稿された
内容とDebian Project Newsからです。

\begin{multicols}{2}
\input{image201005/quiz.tex}
\end{multicols}

\clearpage

\dancersection{DebianでのLinuxカーネルとの付き合い方}{岩松}

\subsection{はじめに}

ここ数年でDebianのLinuxカーネル開発体制やLinuxカーネルに関するツールの使
い方が変わってきました。Debian JP のMLでもたまにLinuxカーネルに関してハ
マっている方おられるようです。
昔と違って最近のユーザはDebianから提供されているカーネルを使う人が多いよ
うで、ネット上でも情報がまとまっていなかったりします。
今回は、Debian Linux カーネル開発の背景と、今時のカーネルコンパイル方法に
ついてまとめました。

\subsection{Debian Linux カーネルの開発状況}
Debian の Linux カーネルは Debian Kernel Team によって開発およびメンテナ
ンスされています。
もちろんDebianでは LinuxカーネルもDebianパッケージとして提供されており、
容易に利用可能な状態になっています。
チームコアメンバは Bastian Blank, Frederik Schul, Maximilian Attems,
Ben Hutchings で、彼らがが中心になってメンテナンスしています。各々はもち
ろんカーネル開発者です。
彼らだけでは全アーキテクチャの面倒を見きれないので、各アーキテクチャメン
テナとともにカーネルパッケージのメンテナンスを行っています。
アーキテクチャメンテナはBuilddメンテナや、Debian-instller チーム、eglibc
メンテナなど、カーネルに関係するパッケージをメンテナンスしている約20名の開発者に
よって構成されています。

\begin{figure}[H]
\caption{Debian Linuxカーネルチーム構成図}
\begin{center}
\includegraphics[width=1.0\hsize]{image201005/debian-kernel-team.eps}
\label{fig:debian-kernel-team}
\end{center}
\end{figure}
\subsection{DebianでのLinuxカーネル開発プロセス}

去年の7月頃まではDebianでベースとするLinuxカーネルバージョンは決まっていましたが、
パッケージのリリースサイクルはあまり決まっていませんでした。
去年のDebconfではLinuxカーネルのstableリリースに合わせて開発を行うこと
が決まり、パッケージのバージョニングと開発/メンテナンススタイルももこれ
に合わせて変更されています。

\subsubsection{カーネルパッケージのバージョン関係}

2010年5月現在、LinuxのLTSサポートカーネルバージョンは 2.6.32 で、
現在は 2.6.32.13です。このカーネルをベースにDebianパッケージにした場合、パッケージバージョンは
linux-2.6\_2.6.32-13 となります。stable リリースバージョンをDebian
バージョンに置き換えており、Debian バージョン ＝ Linux カーネルのstable
リリースバージョンとなります。
これにより新しいstableリリースが出ない限り、Debianパッケージもアップロー
ドされません。

\subsubsection{パッチのバックポート}
Linus カーネルからのバックポート（linux-2.6.34-rc7 で取り込まれたパッチ
をlinux-2.6.32に取り入れてもらうなど）は、Debianパッケージに直接取り込まれることはなく、
stableカーネルからのみ受け付けます。stableカーネルで採用されない限りは
Debianでも使えないということです。これを行うには、stable@kernel.orgにメー
ルして、stableカーネルに取り込んでもらうように交渉する必要があります。
場合によっては、Debian Kernel TeamやパッチAuthorに協力してもらう必要があ
るかもしれません。

\subsubsection{バグレポートとパッチ}
バグがあった場合には、Debian の BTSを利用する事ができます。
パッチが用意できる場合には、パッチも添付しましょう。メンテナが
Upstream(stabelカーネル、場合によってはLinus/HEAD)に転送してくれます。

Debian Kernel Teamで作成されたパッチは積極的にLinusカーネルに取り込まれ
るように働きかけています。これらが、Liuns/HEADまたはstableカーネルに取り
込まれない場合、Debian specific パッチとして管理されます。
例えば、ドライバのnon-freeファームウェアのパッチなどはまだ全て取り込まれ
ておらず、一部はDebian specifcパッチとして残っています。

\begin{figure}[H]
\caption{Debian Linuxカーネル開発プロセス}
\begin{center}
\includegraphics[width=1.0\hsize]{image201005/debian-kernel-devel.eps}
\label{fig:debian-kernel-devel}
\end{center}
\end{figure}


\subsection{Debian Kernel Teamによってメンテナンスされている主要なパッケージ}

Debian Kernel TeamではLinuxカーネルに関するいくつかのパッケージをメンテ
ナンスしています。ここでは、主要なパッケージについて説明します。

\subsection{linux-2.6 パッケージ}
Debian Kernel Teamがメンテナンスしているパッケージの一つにlinux-2.6があ
ります。
これはLinuxカーネルの主要なパッケージであり、このパッケージから各アーキ
テクチャ向けのカーネル、ヘッダファイル、libc向けヘッダファイル等のパッケージが生成さ
れます。

\begin{figure}[H]
\caption{linux-2.6 パッケージから生成されるパッケージ}
\begin{center}
\includegraphics[width=0.8\hsize]{image201005/debian-kernel-package.eps}
\label{fig:debian-kernel-package}
\end{center}
\end{figure}


\subsection{linux-latest-2.6 パッケージ} 
\texttt{linux-latest-2.6}パッケージは仮想パッケージを提供します。
例えば、amd64アーキテクチャ向けのLinuxカーネルイメージパッケージは
\texttt{linux-image-2.6.32-5-amd64}になりますが、\texttt{linux-latest-2.6}パッケージでは
\texttt{linux-image-2.6-amd64} を提供し、 \texttt{linux-image-2.6.32-5-amd64} に依存します。
これは、ABI の変更を追従するためです。
ABIのバージョン（上の例だと5）をパッケージ名に含めてるので、ABIが変更された場合のカーネ
ルアップデートが困難になります。ようするに、\texttt{linux-image-2.6.32-4-amd64}
と\texttt{linux-image-2.6.32-5-amd64}ではABIが異なるので別パッケージ扱い
になるというわけです。別パッケージ扱いになると、
texttt{linux-image-2.6.32-4-amd64}と\texttt{linux-image-2.6.32-5-amd64}
が同時にインストールされることになるので、これをコントロールするために、
\texttt{linux-image-2.6-amd64}パッケージが存在します。
なぜ、カーネルパッケージ名にABIのバージョンを含めているのかというと、パッケージのバージョンに入れてしまうと新し
いバージョン扱いになってしまうので、Debianにインストールされるのが遅くなってしまうためです。


\subsection{linux-kbuild-2.6}
これは、linux-headers パッケージに依存しています。
このパッケージのソースコードはアップストリームのソースコードからkbuildを
行うために必要な部分を抽出して作られます。

%  なぜ、これらはわかれているのか。

\subsection{今時のDebianカーネルのビルド方法}

大抵のユーザはDebianで提供されているバイナリパッケージを使います。
しかし、たまにビルドしたい人がいるわけです。

理由としては以下のものが考えられます。

\begin{itemize}
\item 何か修正するためのパッチを適用したい。
\item オレオレパッチを適用したカーネルを使いたい。
\item プリエンプションモデルが気に入らない。\\
\texttt{CONFIG\_PREEMPT\_XXX}の変更
\item Timer frequencyを変更したい。
\texttt{CONFIG\_HZ\_XXX}の変更
\item 毎日カーネルをビルドしないと気が済まない。
\end{itemize}

このような事から日頃からカーネルのビルドを行って置くことが重要です。
しかし、Debianではいくつかのカーネル構築方法があります。これらを一つずつ
みてみましょう。
%http://kernel-handbook.alioth.debian.org/ch-common-tasks.html
%http://wiki.debian.org/HowToRebuildAnOfficialDebianKernelPackage#Thestoryoflinux-kbuild-2.6
% http://kernel-handbook.alioth.debian.org/ch-common-tasks.html

\subsubsection{Debianのカーネルを再ビルドする。}

Debianのカーネルを再ビルドするのは簡単です。以下のように実行します。
\begin{enumerate}
\item Debianが提供しているカーネルのビルドに必要なパッケージをインストー
      ルする
\begin{commandline}
$ sudo apt-get build-dep linux-source-2.6.26
\end{commandline}

\item Debianのカーネルソースをインストールする。
\begin{commandline}
$ sudo apt-get install linux-source-2.6.26
\end{commandline}
\item make-kpkg コマンドを使ってカーネルパッケージをビルドする。
\begin{commandline}
$ fakeroot make-kpkg --revision=test00debian kernel_image kernel_headers
\end{commandline}

\end{enumerate}


しかし、これではDebianパッケージにはパッチが適用されていない状態です。パッ
チを適用する必要あがります。

\begin{commandline}
$ /usr/src/kernel-patches/all/2.6.26/apply/debian -a x86_64 -f xen
\end{commandline}
-a でアーキテクチャ、-f で flavourを指定します。

\subsubsection{オフィシャルDebianカーネルをリビルドする}


\subsubsection{Debianのカーネルにパッチを適用して利用する。}

\subsubsection{リリースされたカーネルをdebianパッケージにする}
LinusやstableチームによってリリースされたLinuxカーネルをDebianパッケージ
を作成するには\texttt{kernel-package}パッケージを使います。
lennyでは\texttt{kernel-package}の機能が足りていないので、testingや
unstableのパッケージを持ってきましょう。特に特別なパッケージに依存してい
ないので、そのまま\texttt{dpkg}コマンドでインストールすることができます。

\begin{enumerate}
\item \texttt{kernel-package}パッケージと\texttt{fakeroot}パッケージをイ
 ンストールする。
\begin{commandline}
$ sudo apt-get install kernel-package fakeroot
\end{commandline}

\item ソースTAR-ballをダウンロードし、展開する。
\item カーネルコンフィグをカスタマイズする。
\begin{commandline}
$ make menuconfig
\end{commandline}

\item \texttt{make-kpkg}コマンドを使ってカーネルパッケージを構築する。
\begin{commandline}
$ make-kpkg --revision=test00 kernel_image kernel_headers
\end{commandline}

\item ビルドが終わるとパッケージができているので、インストールします。
\begin{commandline}
$ sudo dpkg -i linux-headers-2.6.33.3_test00_amd64.deb  linux-image-2.6.33.3_test00_amd64.deb
\end{commandline}

\end{enumerate}


\subsection{git/HEADをDebianパッケージにする。}
今時はカーネルがリリースされる度にカーネルのソースコードをダウンロードす
るのではなく、gitリポジトリからビルドするのが通でしょう。たぶん。

\begin{commandline}
$ git remote update
$ git checkout origin/master
\end{commandline}

\subsection{よくある QA}

\subsubsection{最新カーネル向けパッケージををlenny上で作れません}


\subsubsection{initrd が作られません。}
grubのメニューを変更して、initrdを使わないようにしましょう。
というのは半分冗談で、kenrel-pakcage 12.012 以降から initrdを作らない仕様に変
更されました。\texttt{make-kpkg}コマンドを使ってinitrdを含めたカーネルイ
メージを作成するには、以下を実行する必要があります。
\begin{commandline}
$ sudo mkdir -p /etc/kernel/postinst.d/
$ sudo cp
 /usr/share/doc/kernel-package/examples/etc/kernel/postinst.d/initramfs \
 /etc/kernel/postinst.d/
\end{commandline}

実行した後に再度カーネルパッケージを作ると、インストール時にinitrdイメー
ジを構築してくれます。

\subsubsection{-j オプションを使ってカーネルパッケージをビルドしたいのですが}

make-kpkg コマンドの \texttt{DEBIAN\_KERNEL\_JOBS} 変数を使いましょう。
例えば、-j8 相当は以下のように実行します。
\begin{commandline}
$ make-kpkg --revision=test00 kernel_image kernel_headers DEBIAN_KERNEL_JOBS=8
\end{commandline}


\subsubsection{2.6.33 向けのlinux-kbuild-2.6を作りたいのですが}
\url{http://wiki.debian.org/HowToRebuildAnOfficialDebianKernelPackage#Thestoryoflinux-kbuild-2.6}
を参照。
2.6.33 は experimental にありますが、バグ(\#573176)があります。パッチを
当てて、ビルドしましょう。

\subsubsection{最新のカーネルを使いたいのだけど、パッケージにするのがめんどいです。}
\url{http://kernel-archive.buildserver.net}で提供されていますが、現在サーバダウン中です。

\printindex

\cleartooddpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\ \\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule

\end{document}
