%; whizzy chapter -dvi
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Tokyo Debian Meeting resources
%     Copyright (C) 2012 Junichi Uekawa
%     Copyright (C) 2011, 2015, 2020 Nobuhiro Iwamatsu

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}
% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2021}
\newcommand{\debmtgmonth}{1}
\newcommand{\debmtgdate}{xx}
% started from zero:
% (let ((year 2021) (month 1)) (+ (* (- year 2005) 12) month -1))
% and add 1
\newcommand{\debmtgnumber}{193}

% Needed to import pandoc-generated LaTeX documents.
% See https://stackoverflow.com/questions/40438037/tightlist-error-using-pandoc-with-markdown
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

\begin{document}

\begin{titlepage}
\thispagestyle{empty}
% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料\\
\hspace*{-2cm}
\includegraphics{image2012-natsu/dotdeb.pdf}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

% ここはアップデートすること
% 全角文字にしないとフォントのサイズが合わないので注意
\rotatebox{10}{\fontsize{30}{30} {\gt nodejs を使う}}\\

\vspace*{-2cm}
\hfill{}\includegraphics[height=6cm]{image200502/openlogo-nd.eps}
\end{titlepage}

\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\begin{multicols}{2}
\tableofcontents
\end{multicols}
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{最近のDebian関連のミーティング報告}{杉本　典充}

\dancersection{事前課題}{杉本　典充}

今回の事前課題は以下です。

\begin{enumerate}
 \item nodeでプログラムを書いたことありますか、何を書きましたか
 \item node で書かれたプログラムでDebianにあったらいいなというのはなにかありますか？
\end{enumerate}

%この課題に対して提出いただいた内容は以下です。

\begin{multicols}{2}
{\small
% \input{image202008/prework.tex}
}
\end{multicols}

%\dancersection{Debian Trivia Quiz}{username}
%
%Debianの昨今の話題についてのQuizです。
%
%今回の出題範囲は\url{debian-devel-announce@lists.debian.org} や \url{debian-news@lists.debian.org}などに投稿された内容からです。
%
%\begin{multicols}{2}
%\input{image202007/quiz.tex}
%\end{multicols}


% % (query-replace-regexp "<.*?>" "")
% % (query-replace-regexp "^[    ]\+" "")

%-------------------------------------------------------------------------------
\dancersection{DebianでのNode}{上川純一}
%-------------------------------------------------------------------------------

\subsection{node.jsの最近}

node.jsとはv8 というJavascriptエンジンで動作するJavascript環境です
\cite{nodejsorg}。v8はChromeのjavascriptエンジンとして広く使われていおり、
同じ環境をブラウザ以外でも使えるというのが便利なポイントです。

Javascriptは基本的にはシングルスレッドで動くのでイベントベースでプログラ
ミングすることになり、はじめにそこをうまく扱った標準ライブラリを整備した
あたりが普及の決め手だったのでしょう。たとえばほぼすべてのファイルAPIが
コールバック形式になっています。

ただJavascriptはES6で大きく進化しました。ES6（ES2015）以降は仕様の呼称も
変わったようで毎年仕様がリリースされています\cite{nodejs-es6}。大きな変
化はPromiseとasync/awaitという言語の進化により大きく書き方が変わり、それ
にともなって順次コアのAPIも書き換わっていっている過程のように見えます。

ES6以前のJavascriptだとcallbackを使うのでなにかするたびにfunctionが一段
かまされインデントが深くなっていきます。

\begin{commandline}
var fs = require('fs');

fs.readFile('./cat.js', {encoding: 'utf-8'}, function(err, data) {
    if (err) throw err;
    console.log(data);
})
\end{commandline}

ES6以降のJavascriptだとasync awaitが使えるようになっていて

\begin{commandline}
const fs  = require('fs');

const main = async () => {
    const buffer = await fs.promises.readFile('./cates2015.js',
					      {encoding: 'utf-8'});
    console.log(buffer);
}

main().catch((e)=>{
    console.error(e);
    process.exit(1);
});

\end{commandline}

あとjavascriptで必ずはまる変数スコープとかthisの扱いとかを比較的意識しな
くて良くなるのが良いと思います。

ここ数年はNodeのバージョンは偶数バージョンがLTSの安定版となっていて、一
年に一回リリースされています\cite{nodejsreleases}。ES2015からES2020の各
機能のサポート状況については Node.js ES2015 Support \cite{node-green}の
ページがよくまとまっているようです。

\begin{tabular}{|l|c|c|l|}
\hline
nodejs リリース & リリース日 & end of life & 上川にとって特筆する言語機能\\
\hline
v10 & 2018-04-24 & 2021-04-30 & v8 6.6, fs/promisesの試験導入 \\
v12 & 2019-04-23 & 2022-04-30 & v8 7.4\\
v14 & 2020-04-21 & 2023-04-30 & v8 8.1, ES Modulesの標準サポート、 \\
v15 & 2020-10-20 & 2021-06-01 &  \\
v16 & 2021-04-?? &            &  \\
\hline
\end{tabular}

二年に一回安定版リリースをしているDebianとしては一年に一回大きなアップデー
トをしているNode.jsの最新版をおいかけるのは結構大変でしょう。

\subsection{DebianユーザとしてのNodeでプログラムを書いてみる}

\subsubsection{Debian公式パッケージのインストール}


Debian 公式のパッケージとしてnodejs パッケージが提供されています。それだ
けでは実行できる環境が揃うだけです。Nodejsの強みはnpmというパッケージリ
ポジトリです。Debian公式パッケージではnpm パッケージにパッケージ管理シス
テムのnpmコマンドが入っています。

\begin{commandline}
$ apt-get install -y npm nodejs
\end{commandline}

しかし、いくらDebianのパッケージが多いといってもすべてのパッケージを提供
するのは現実的ではないのと他のnodejsを利用している一般開発者はnpm管理の
パッケージを利用しているためそことの相互運用のことも考えると悩ましいです
がDebianパッケージよりnode.js公式パッケージを使うことになりそうです。

npm install して依存関係をインストールするとDebianパッケージを使うわけで
はなく、\url{http://npmjs.com} からインストールすることになります。

Debian パッケージとして依存関係をインストールなら該当するパッケージを探
することになります。インストールされたライブラリは /usr/lib/nodejs以下に
インストールされています。

手元のSocket.ioテストアプリの例を見てみましょう。

\begin{commandline}
{
  "name": "wssrtc",
  "description": "Node.js socket.io app running on Cloud Run for webrtc",
  "version": "v0.0.1",
  "private": true,
  "dependencies": {
    "cli": "",
    "ejs": "",
    "express": "",
    "socket.io": ""
  },
}
\end{commandline}

Debianパッケージは node-expressなどだと思われるんですが、cli, socket.io
にそれぞれ該当するパッケージが見つかりませんでした。昔はあったような気が
するのに。

npm installを使うと\url{npmjs.com}からダウンロードしてきて
\texttt{./node\_modules}以下にインストールします。しかしなんかNode.jsの
バージョン10がサポートされませんと警告が出たり微妙な雰囲気です。

\begin{commandline}
$ npm install 
npm WARN npm npm does not support Node.js v10.21.0
npm WARN npm You should probably upgrade to a newer version of node as we
npm WARN npm can't make any promises that npm will work with this version.
npm WARN npm Supported releases of Node.js are the latest release of 4, 6, 7, 8, 9.
npm WARN npm You can find the latest version at https://nodejs.org/
npm WARN deprecated debug@4.1.1: Debug versions >=3.2.0 <3.2.7 || >=4 <4.3.1 have a low-severity ReDos regression when used in a Node.js environment. It is recommended you upgrade to 3.2.7 or 4.3.1. (https://github.com/visionmedia/debug/issues/797)
npm WARN ws@7.4.2 requires a peer of bufferutil@^4.0.1 but none is installed. You must install peer dependencies yourself.
npm WARN ws@7.4.2 requires a peer of utf-8-validate@^5.0.2 but none is installed. You must install peer dependencies yourself.

added 96 packages from 107 contributors in 3.568s 
\end{commandline}

\subsubsection{Node.js 公式パッケージのインストール}

Node.jsから提供されているパッケージのインストール手段としては公式に配布
されているバイナリの最新のLTS版を利用するのがよいでしょう
\cite{nodejs-install}。ダウンロード方法について書いてあるページに従うと
バイナリインストールから始まるのですがそこからパッケージ版へのリンクがあ
り、Debian等は別のページにあり、Debianパッケージのインストールに到達する
には３ページ遷移する必要があります。Debianパッケージのインストール手順に
従うと、サイトからダウンロードしたシェルスクリプトをroot権限で実行するこ
とになります。

\begin{commandline}
# curl -sL https://deb.nodesource.com/setup_14.x | bash -
# apt-get install -y nodejs
\end{commandline}

スクリプトでやっていることは基本的には次のような一連のコマンドでした。

\begin{commandline}
$ curl -sSL https://deb.nodesource.com/gpgkey/nodesource.gpg.key | sudo apt-key add -  # 鍵の追加
$ VERSION=node_14.x
$ DISTRO="$(lsb_release -s -c)"
$ echo "deb https://deb.nodesource.com/$VERSION $DISTRO main" | sudo tee /etc/apt/sources.list.d/nodesource.list  # パッケージ情報の追加
$ echo "deb-src https://deb.nodesource.com/$VERSION $DISTRO main" | sudo tee -a /etc/apt/sources.list.d/nodesource.list  # ソースパッケージ情報は必須ではない
$ sudo apt update && sudo apt install nodejs  # インストール
\end{commandline}

ここまでの作業を行うとnpmコマンドやnodejsコマンドが利用できるようになっ
ています。Debian公式パッケージではnpmコマンドがわかれていますが、nodejs
提供のパッケージではnpmコマンドもnodejsパッケージに含まれています。

Debianでは以前nodeコマンドがすでに存在していたのでポリシーに基づいてnode
という名前がつかえず、nodejsという名前を利用しています、stretchまでは
node-legacyパッケージをインストールしてシンボリックリンクを用意していま
した
\footnote{\url{https://lists.debian.org/debian-devel-announce/2012/07/msg00002.html}
に名前衝突についてのCTTE Resolutionがあります}。現在はnodeコマンドが利用
できるようになっており、nodejsもシンボリックリンクとして提供されているよ
うです。

node.jsのAPIのドキュメント\cite{nodejs-api}を参照しながらプログラムを書
くことになるでしょう。

\subsection{DockerでのDebianユーザとしてのNodeの利用}

Dockerを利用する場合は、Node.jsがインストールされたインスタンスが
Dockerhubにあるのでそれをベースに使うのがよいのではないでしょうか。
\url{https://hub.docker.com/_/node/}にあり、\texttt{FROM node} と何も指
定しないと\texttt{node:current}が使われて、それはdebian stretchベースの
イメージのようです。busterが使いたい場合は\texttt{FROM node:buster}を指
定するのがよいでしょう。

手元のDockerfileでは次のように書いていました。

\begin{commandline}
FROM node:14

COPY . .
RUN npm install
\end{commandline}

\subsection{Debian Developer としてのNode.jsパッケージ}

Debian パッケージをNodejsの\texttt{package.json}から生成すること自体は簡単です。
npm2debをつかえばよいでしょう。おそらく困難はDebianポリシーに従うと
Debianパッケージとして追加するにはDebianパッケージだけで依存関係を解決す
る必要があります。そのため依存関係を全部追加し、ライセンスなどのチェック
を行うことにあると思われます。あとはnpm管理じゃない環境にスナップショッ
トを維持することになるので面倒が増えます。

\subsubsection{Node.jsバージョン}

Debian公式のパッケージ「nodejs」のバージョンを２０２０年１２月２５日時点
で確認したところ、最新のLTS版をexperimentalに入れるという運用のようです。
保守的ですが２年間安定版として利用されることを見越すとこれが現実的でしょ
う。最新のNode.jsの機能に依存しているソフトウェアは扱いが難しそうです。

\begin{tabular}{|l|l|}
Debian release    & nodejs バージョン \\
\hline
stretch           & 4.8.2 \\
stretch-backports & 8.11.1 \\
buster            & 10.21.0 \\
bullseye          & 12.19.0 \\
sid               & 12.19.0 \\
experimental      & 14.13.0 \\
\end{tabular}

\subsubsection{Node.js パッケージポリシー}

Node.jsパッケージのポリシーが書いてあるWikiページがありました\cite{debian-nodejs-manual}。そこにはこんなことが書いてあります：

\begin{itemize}
 \item バイナリーとソースパッケージはnode-fooという名前にする

 \item MUST: nodejsにBuild-Dependsを指定すること

 \item /usr/lib/nodejs/ か /usr/lib/nodejs/foo/にインストールすること。
	場所は複数のファイルがあるのか単一ファイルなのかに依存する。
 \item package.json を /usr/lib/nodejs/foo/package.json にいれておくこと

 \item ウェブブラウザから利用可能であれば libjs-foo バイナリパッケージを作成する。 Javascript/Policy を参照。

 \item require('foo') が動くように確認する自動テストを含めること。

 \item c++ アドオンは nodejs-abi-{\it process.versions.modules} に依存すること。

\end{itemize}


\texttt{node-}ではじまるバイナリパッケージは1400くらいあるようです。ただ
npmにあがっているパッケージの数は1.4millionくらいのようで毎日平均１００
０パッケージが追加されているようです。

\subsubsection{Debian Javascript policy}

歴史的にはDebianにある既存のJavascriptのコードの多くはブラウザで利用でき
るようになっているもので、それについてはDebian Javascript Policyで統一し
ようとしているようです\cite{debian-javascript-policy}。

javascript-commonパッケージをRecommendしてパッケージ名は\texttt{libjs-}
で始めるようにするというものですがBusterでは223パッケージあるようです。

\subsubsection{npm2debを使ってみる}

ためしにnpm2debを使ってみました。公開されているnpmパッケージをとってきて
テンプレートを作成してくれるというものでした。しかし実際に使おうとすると
ものによりますが依存関係を全部確認してDebianに入れるのが大変そうです。

\begin{commandline}
$ npm2deb create simple-peer

This is not a crystal ball, so please take a look at auto-generated files.

You may want fix first these issues:

simple-peer/node-simple-peer/debian/changelog: -- FIX_ME debian author  Sat, 16 Jan 2021 10:39:59 +0900
simple-peer/node-simple-peer/debian/control:Uploaders: FIX_ME debian author
simple-peer/node-simple-peer/debian/control:Description: FIX_ME write the Debian package description
simple-peer/node-simple-peer/debian/copyright:Copyright: 2021, FIX_ME debian author
simple-peer/node-simple-peer_itp.mail:Subject: ITP: node-simple-peer -- FIX_ME write the Debian package description
simple-peer/node-simple-peer_itp.mail:Owner: FIX_ME debian author
simple-peer/node-simple-peer_itp.mail:  Description     : FIX_ME write the Debian package description
simple-peer/node-simple-peer_itp.mail: FIX_ME: This ITP report is not ready for submission, until you are
simple-peer/node-simple-peer_itp.mail:FIX_ME: Explain why this package is suitable for adding to Debian. Is
simple-peer/node-simple-peer_itp.mail:FIX_ME: Explain how you intend to consistently maintain this package

Use uscan to get orig source files. Fix debian/watch and then run                    
$ uscan --download-current-version


*** Warning ***
Using fakeupstream to download npm dist tarballs, because upstream
git repo is missing tags. Its better to ask upstream to tag their releases
instead of using npm dist tarballs as dist tarballs may contain pre built files
and may not include tests.

Warnings occurred:
 [error]   get-browser-rtc: dependency node-get-browser-rtc not in debian
 [error]   queue-microtask: dependency node-queue-microtask not in debian

\end{commandline}

\begin{thebibliography}{1}
 \bibitem{nodejsorg} ``Node.js'' \url{https://nodejs.org/}
 \bibitem{nodejsreleases} ``Releases|Node.js'', \url{https://nodejs.org/ja/about/releases/}
 \bibitem{nodejs-install} NodeSource Node.js Binary Distributions
	 \url{https://github.com/nodesource/distributions/blob/master/README.md#debinstall}
 \bibitem{nodejs-api} ``Node.js v15.4.0 Documentation''  \url{https://nodejs.org/api/}
 \bibitem{nodejs-es6} ``ECMAScript 2015 (ES6) とそれ以降のバージョン''
	 \url{https://nodejs.org/ja/docs/es6/}
 \bibitem{node-green} ``Node.js ES2015 Support'' \url{https://node.green/}
 \bibitem{debian-nodejs-manual} 
	 ``Node.js modules policy'' 
	 \url{https://wiki.debian.org/Javascript/Nodejs/Manual}
 \bibitem{debian-javascript-policy} 
	 ``Javascript Policy''
	 \url{https://wiki.debian.org/Javascript/Policy}

\end{thebibliography}

%-------------------------------------------------------------------------------
%\dancersection{title}{username}
%-------------------------------------------------------------------------------


% 冊子にするために、4の倍数にする必要がある。
% そのための調整
\dancersection{メモ}{}
\mbox{}\newpage
\mbox{}\newpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule
\end{document}
