%; whizzy chapter -dvi
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Tokyo Debian Meeting resources
%     Copyright (C) 2012 Junichi Uekawa
%     Copyright (C) 2011, 2015, 2020 Nobuhiro Iwamatsu

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}
% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2021}
\newcommand{\debmtgmonth}{1}
\newcommand{\debmtgdate}{xx}
% started from zero:
% (let ((year 2021) (month 1)) (+ (* (- year 2005) 12) month -1))
% and add 1
\newcommand{\debmtgnumber}{193}

% Needed to import pandoc-generated LaTeX documents.
% See https://stackoverflow.com/questions/40438037/tightlist-error-using-pandoc-with-markdown
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

\begin{document}

\begin{titlepage}
\thispagestyle{empty}
% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料\\
\hspace*{-2cm}
\includegraphics{image2012-natsu/dotdeb.pdf}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

% ここはアップデートすること
% 全角文字にしないとフォントのサイズが合わないので注意
\rotatebox{10}{\fontsize{30}{30} {\gt nodejs を使う}}\\

\vspace*{-2cm}
\hfill{}\includegraphics[height=6cm]{image200502/openlogo-nd.eps}
\end{titlepage}

\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\begin{multicols}{2}
\tableofcontents
\end{multicols}
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{最近のDebian関連のミーティング報告}{杉本　典充}

\dancersection{事前課題}{杉本　典充}

今回の事前課題は以下です。

\begin{enumerate}
 \item nodeでプログラムを書いたことありますか、何を書きましたか
 \item node で書かれたプログラムでDebianにあったらいいなというのはなにかありますか？
\end{enumerate}

%この課題に対して提出いただいた内容は以下です。

\begin{multicols}{2}
{\small
% \input{image202008/prework.tex}
}
\end{multicols}

%\dancersection{Debian Trivia Quiz}{username}
%
%Debianの昨今の話題についてのQuizです。
%
%今回の出題範囲は\url{debian-devel-announce@lists.debian.org} や \url{debian-news@lists.debian.org}などに投稿された内容からです。
%
%\begin{multicols}{2}
%\input{image202007/quiz.tex}
%\end{multicols}


% % (query-replace-regexp "<.*?>" "")
% % (query-replace-regexp "^[    ]\+" "")

%-------------------------------------------------------------------------------
\dancersection{DebianでのNode}{上川純一}
%-------------------------------------------------------------------------------

\subsection{node.jsの最近}

node.jsとはv8 というJavascriptエンジンで動作するJavascript環境です
\cite{nodejsorg}。v8はChromeのjavascriptエンジンとして広く使われていおり、
同じ環境をブラウザ以外でも使えるというのが便利なポイントです。

Javascriptは基本的にはシングルスレッドで動くのでイベントベースでプログラ
ミングすることになり、はじめにそこをうまく扱った標準ライブラリを整備した
あたりが普及の決め手だったのでしょう。たとえばほぼすべてのファイルAPIが
コールバック形式になっています。

ただJavascriptES6で大きく進化しました。ES6（ES2015）以降は呼称も変わった
ようで毎年仕様がリリースされています\cite{nodejs-es6}。大きな変化は
Promiseとasync/awaitという言語の進化により大きく書き方が変わり、それにと
もなって順次コアのAPIも書き換わっていっている過程のように見えます。

ES6以前のJavascriptだとcallbackを使うのでなにかするたびにfunctionが一段
かまされインデントが深くなっていきます。

\begin{commandline}
var fs = require('fs');

fs.readFile('./cat.js', {encoding: 'utf-8'}, function(err, data) {
    if (err) throw err;
    console.log(data);
})
\end{commandline}

ES6以降のJavascriptだとasync awaitが使えるようになっていて

\begin{commandline}
const fs  = require('fs');

const main = async () => {
    const buffer = await fs.promises.readFile('./cates2015.js',
					      {encoding: 'utf-8'});
    console.log(buffer);
}

main().catch((e)=>{
    console.error(e);
    process.exit(1);
});

\end{commandline}

あとjavascriptで必ずはまる変数スコープとかthisの扱いとかを比較的意識しな
くて良くなるのが良いと思います。

ここ数年はNodeのバージョンは偶数バージョンがLTSの安定版となっていて、一
年に一回リリースされています\cite{nodejsreleases}。ES2015からES2020の各
機能のサポート状況については Node.js ES2015 Support \cite{node-green}の
ページがよくまとまっているようです。

\begin{tabular}{|l|c|c|l|}
\hline
リリース & リリース日 & end of life & 上川にとって特筆する言語機能\\
\hline
v10 & 2018-04-24 & 2021-04-30 & v8 6.6, fs/promisesの試験導入 \\
v12 & 2019-04-23 & 2022-04-30 & v8 7.4\\
v14 & 2020-04-21 & 2023-04-30 & v8 8.1, ES Modulesの標準サポート、 \\
v15 & 2020-10-20 & 2021-06-01 &  \\
v16 & 2021-04-?? &            &  \\
\hline
\end{tabular}

二年に一回安定版リリースをしているDebianとしては一年に一回大きなアップデー
トをしているNode.jsの最新版をおいかけるのは結構大変でしょう。

\subsection{DebianユーザとしてのNodeでプログラムを書いてみる}

\subsubsection{パッケージのインストール}

Nodejsのインストール手段としては公式に配布されているバイナリの最新のLTS
版を利用するのがよいでしょう\cite{nodejs-install}。ダウンロード方法につ
いて書いてあるページに従うとバイナリインストールから始まるのですがそこか
らパッケージ版へのリンクがあり、Debian等は別のページにあり、Debianパッケー
ジのインストールに到達するにはさんページ遷移する必要があります。そこに従
うと、サイトからダウンロードしたシェルスクリプトを実行することになります。

\begin{commandline}
# Using Debian, as root
$ curl -sL https://deb.nodesource.com/setup_14.x | bash -
$ apt-get install -y nodejs
\end{commandline}

スクリプトでやっていることは基本的には以下のことなので以下のコマンドを使うのもよいでしょう。

\begin{commandline}
$ curl -sSL https://deb.nodesource.com/gpgkey/nodesource.gpg.key | sudo apt-key add -
$ VERSION=node_14.x
$ DISTRO="$(lsb_release -s -c)"
$ echo "deb https://deb.nodesource.com/$VERSION $DISTRO main" | sudo tee /etc/apt/sources.list.d/nodesource.list
$ echo "deb-src https://deb.nodesource.com/$VERSION $DISTRO main" | sudo tee -a /etc/apt/sources.list.d/nodesource.list
$ sudo apt update && sudo apt install nodejs
\end{commandline}

ここまでの作業を行うとnpmコマンドやnodejsコマンドが利用できるようになっ
ています。Debianでは以前nodeコマンドがすでに存在していたのでポリシーに基
づいてnodejsコマンドを利用、stretchまではnode-legacyパッケージをインストー
ルしてシンボリックリンクを用意していました
\footnote{\url{https://lists.debian.org/debian-devel-announce/2012/07/msg00002.html}
に名前衝突についてのCTTE Resolutionがあります}。現在はnodeコマンドが利用できるようになって
おり、nodejsもシンボリックリンクとして提供されているようです。

node.jsのAPIのドキュメント\cite{nodejs-api}を参照しながらプログラムを書
くことになるでしょう。

\subsection{DockerでのDebianユーザとしてのNodeの利用}

Dockerを利用する場合は、Node.jsがインストールされたインスタンスが
Dockerhubにあるのでそれをベースに使うのがよいのではないでしょうか。
\url{https://hub.docker.com/_/node/}にあり、\texttt{FROM node} と何も指
定しないと\texttt{node:current}が使われて、それはdebian stretchベースの
イメージのようです。busterが使いたい場合は\texttt{FROM node:buster}を指
定するのがよいでしょう。

手元のDockerfileでは次のように書いていました。

\begin{commandline}
FROM node:10

COPY . .
RUN npm install
\end{commandline}

\subsection{Debian Developer としてのNode.jsパッケージ}

Debian パッケージをNodejsのpackages.jsonから生成すること自体は簡単です。
npm2debをつかえばよいでしょう。おそらく困難はDebianポリシーに従うと
Debianパッケージとして追加するにはDebianパッケージだけで依存関係を解決す
る必要があります。そのため依存関係を全部追加し、ライセンスなどのチェック
を行うことにあると思われます。あとはnpm管理じゃない環境にスナップショッ
トを維持することになるので面倒が増えます。

\subsubsection{Node.jsバージョン}

Debian公式のパッケージ「nodejs」のバージョンを２０２０年１２月２５日時点
で確認したところ、最新のLTS版をexperimentalに入れるという運用のようです。
保守的ですが２年間安定版として利用されることを見越すとこれが現実的でしょ
う。最新のNode.jsの機能に依存しているソフトウェアは扱いが難しそうです。

\begin{tabular}{|l|l|}
Debian release    & nodejs バージョン \\
\hline
stretch           & 4.8.2 \\
stretch-backports & 8.11.1 \\
buster            & 10.21.0 \\
bullseye          & 12.19.0 \\
sid               & 12.19.0 \\
experimental      & 14.13.0 \\
\end{tabular}

\subsubsection{Node.js パッケージポリシー}

Node.jsパッケージのポリシーが書いてあるWikiページがありました\cite{debian-nodejs-manual}。そこにはこんなことが書いてあります：

\begin{itemize}
 \item バイナリーとソースパッケージはnode-fooという名前にする

 \item MUST: nodejsにBuild-Dependsを指定すること

 \item /usr/lib/nodejs/ か /usr/lib/nodejs/foo/にインストールすること。
	場所は複数のファイルがあるのか単一ファイルなのかに依存する。
 \item package.json を /usr/lib/nodejs/foo/package.json にいれておくこと

 \item ウェブブラウザから利用可能であれば libjs-foo バイナリパッケージを作成する。 Javascript/Policy を参照。

 \item require('foo') が動くように確認する自動テストを含めること。

 \item c++ アドオンは nodejs-abi-{\it process.versions.modules} に依存すること。

\end{itemize}

\subsubsection{Debian Javascript policy}

歴史的にはDebianにある既存のJavascriptのコードの多くはブラウザで利用でき
るようになっているもので、それについてはDebian Javascript Policyで統一し
ようとしているようです\cite{debian-javascript-policy}。




\begin{thebibliography}{1}
 \bibitem{nodejsorg} ``Node.js'' \url{https://nodejs.org/}
 \bibitem{nodejsreleases} ``Releases|Node.js'', \url{https://nodejs.org/ja/about/releases/}
 \bibitem{nodejs-install} NodeSource Node.js Binary Distributions
	 \url{https://github.com/nodesource/distributions/blob/master/README.md#debinstall}
 \bibitem{nodejs-api} ``Node.js v15.4.0 Documentation''  \url{https://nodejs.org/api/}
 \bibitem{nodejs-es6} ``ECMAScript 2015 (ES6) とそれ以降のバージョン''
	 \url{https://nodejs.org/ja/docs/es6/}
 \bibitem{node-green} ``Node.js ES2015 Support'' \url{https://node.green/}
 \bibitem{debian-nodejs-manual} 
	 ``Node.js modules policy'' 
	 \url{https://wiki.debian.org/Javascript/Nodejs/Manual}
 \bibitem{debian-javascript-policy} 
	 ``Javascript Policy''
	 \url{https://wiki.debian.org/Javascript/Policy}

\end{thebibliography}

%-------------------------------------------------------------------------------
%\dancersection{title}{username}
%-------------------------------------------------------------------------------


% 冊子にするために、4の倍数にする必要がある。
% そのための調整
\dancersection{メモ}{}
\mbox{}\newpage
\mbox{}\newpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule
\end{document}
