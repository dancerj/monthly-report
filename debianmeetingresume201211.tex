%; whizzy chapter　-dvi
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Tokyo Debian Meeting resources
%     Copyright (C) 2012 Junichi Uekawa
%     Copyright (C) 2012 Nobuhiro Iwamatsu

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image201205; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2012}
\newcommand{\debmtgmonth}{11}
\newcommand{\debmtgdate}{17}
% (+ (* (- 2012 2005) 12) 10 -1) started from zero
\newcommand{\debmtgnumber}{94}

\begin{document}

\begin{titlepage}
\thispagestyle{empty}
% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料\\
\hspace*{-2cm}
\includegraphics{image2012-natsu/dotdeb.pdf}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

% ここはアップデートすること
% 全角文字にしないとフォントのサイズが合わないので注意
% TODO(uekawa): なんでそうなるのか確認
\rotatebox{10}{\fontsize{32}{32} {\gt 特集: Ｄｅｂｃｏｎｆ　Ｒｅｐｏｒｔ}}\\
\rotatebox{10}{\fontsize{32}{32} {\gt 特集: 月刊Ｄｅｂｈｅｌｐｅｒ}}\\

\vspace*{-2cm}
\hfill{}\includegraphics[height=6cm]{image200502/openlogo-nd.eps}
\end{titlepage}

% Title should be in Japanese text so that we can use it as lint for PDF shiori.
\dancersection{はじめに}{上川 純一}

\begin{multicols}{2}
 

 今月のDebian勉強会へようこそ。これからDebianの世界にあしを踏み入れると
 いう方も、すでにどっぷりとつかっているという方も、月に一回Debianについ
 て語りませんか？

 Debian勉強会の目的は下記です。

 \begin{itemize}
 \item \underline{Debian Developer} (開発者)の育成。
 \item 日本語での「\underline{開発に関する情報}」を整理してまとめ、アップデートする。
 \item \underline{場}の提供。
 \begin{itemize}
  \item 普段ばらばらな場所にいる人々が face-to-face で出会える場を提供
	する。
  \item Debian のためになることを語る場を提供する。
  \item Debianについて語る場を提供する。
 \end{itemize}
 \end{itemize}		

 Debianの勉強会ということで究極的には参加者全員がDebian Packageをがりがり
 と作るスーパーハッカーになった姿を妄想しています。情報の共有・活用を通し
 て Debianの今後の能動的な展開への土台として、「場」としての空間を提供す
 るのが目的です。

\end{multicols}

\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\begin{multicols}{2}
\tableofcontents
\end{multicols}
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{事前課題}{上川 純一}

今回の事前課題は以下です:
\begin{enumerate}
 \item xxx
\end{enumerate}
この課題に対して提出いただいた内容は以下です。
\begin{multicols}{2}
{\small
%\input{image201208/prework.tex}
}
\end{multicols}

\dancersection{最近のDebian関連のミーティング報告}{上川 純一}
\subsection{東京エリアDebian勉強会93回目報告}

% (query-replace-regexp "<.*?>" "")
% (query-replace-regexp "^[	 ]\+" "")

%-------------------------------------------------------------------------------
\dancersection{}{}
%-------------------------------------------------------------------------------

%-------------------------------------------------------------------------------
\dancersection{Android 携帯でBluetooth Tethering}{}
%-------------------------------------------------------------------------------

Android設定画面：
TODO

GNOMEの設定画面
\includegraphics{image201211/bt1.png}

\includegraphics{image201211/bt2.png}

%-------------------------------------------------------------------------------
\dancersection{perf でパフォーマンスチューニング}{}
%-------------------------------------------------------------------------------

\subsection{はじめに}

perf コマンドは linux-base パッケージにはいっていてたいていの環境では標準
でインストールされているのですが、カーネルにあったバージョンのバイナリを
追加でインストールする必要があります。

\begin{commandline}
 $ uname -r
3.2.0-3-amd64
 $ sudo apt-get install linux-tools-3.2
\end{commandline}

デバッグシンボルがあると関数名とかがきれいに出る気がするのでデバッグシン
ボルもいれておくとよいでしょう。

\begin{commandline}
 $ sudo apt-get install libc6-dbg libstdc++6-4.7-dbg
\end{commandline}
%$

\subsection{perf stat}

とりあえず time コマンドの代わりにつかえそうなツールとして、 perf statが
あります。CPU周波数が可変なシステムにおいてパフォーマンスの測定のために実
行時間の計測というのは難しい問題なのですが、これでみるとだいたい重要な指
数が見えてきます。

\begin{commandline}
$ perf stat ./apt-index-cmd debian_dists_sid_main_binary-amd64_Packages  debian > /dev/null
 Performance counter stats for './apt-index-cmd debian_dists_sid_main_binary-amd64_Packages debian':

       1741.828818 task-clock                #    0.997 CPUs utilized          
               165 context-switches          #    0.000 M/sec                  
                 6 CPU-migrations            #    0.000 M/sec                  
            27,392 page-faults               #    0.016 M/sec                  
     4,990,934,326 cycles                    #    2.865 GHz                     [83.29%]
     1,681,297,382 stalled-cycles-frontend   #   33.69% frontend cycles idle    [83.27%]
     1,096,373,883 stalled-cycles-backend    #   21.97% backend  cycles idle    [66.62%]
     7,738,965,303 instructions              #    1.55  insns per cycle        
                                             #    0.22  stalled cycles per insn [83.51%]
     1,784,494,907 branches                  # 1024.495 M/sec                   [83.49%]
        32,701,183 branch-misses             #    1.83% of all branches         [83.32%]

       1.746581711 seconds time elapsed
\end{commandline}
  
\subsection{perf record}

\begin{commandline}
$ perf record ./apt-index-cmd debian_dists_sid_main_binary-amd64_Packages  debian > /dev/null
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.087 MB perf.data (~3800 samples) ]
$ ls -l perf.data
-rw------- 1 dancer dancer 93560 10月 10 07:03 perf.data

\end{commandline}

perf record -g オプションをつけるとコールグラフ情報も記録するようです。

デフォルトは一秒1000サンプルとるようなので、プログラムの実行時間に応じて
サンプル数を適当に調整しましょう。 例えば実行全体で一秒くらいで終わるプロ
グラムの場合は-F 10000 をつけてみるとかするとよりサンプルがとれていいか
もしれません。

\subsubsection{gcc のコンパイルオプションの検討}

gcc でソースコードコンパイルするときに、-g オプションをつけるとデバッグ情
報がつきます。関数シンボルの情報とか行数とかソースコードとかが得られるの
でこれは多分重要。

コールグラフがあまりないなぁと思ったら最適化のしすぎとスタックトレースの
とりにくさを疑ってみましょう。

gcc では通常最適化オプション -O2 をつけてコンパイルすると思います。

gcc で -O2 をつけてコンパイルするとフレームポインタがなくなってスタックト
レースを取得しにくくなっています（多分アーキテクチャによる、AMD64の場合）。
libunwind使えば取得できるはずですが、多分perfはカーネル空間でスタックトレー
スをとっているのでそうなってないっぽい。-fno-omit-frame-pointer を指定す
ると、フレームポインタを操作するコードを生成してくれるっぽいです。ただ、若干オー
バーヘッドがあります。

C++でファンクションオブジェクトとかテンプレートプログラミングしまくってい
ると、関数がほとんどインライン展開されてしまい、コールグラフに現れる部分
が少なくなることがあります。たまに -O あたりでコンパイルしてスタックト
レースを見てみましょう。


\subsection{perf report}

メニュー形式になっていて、気になるシンボルを選択してソースコードのアノテー
ションを見ることができます。

\begin{commandline}
$ perf report
Events: 1K cycles                                                              
 18.65%  apt-index-cmd  apt-index-cmd        [.] available_parser::AptIndexSpiri
  7.38%  apt-index-cmd  libc-2.13.so         [.] _int_malloc
  6.64%  apt-index-cmd  libc-2.13.so         [.] malloc
  5.17%  apt-index-cmd  libstdc++.so.6.0.17  [.] std::string::_M_replace_aux(uns
  4.03%  apt-index-cmd  libc-2.13.so         [.] _int_free
  4.02%  apt-index-cmd  libstdc++.so.6.0.17  [.] __cxxabiv1::__vmi_class_type_in
  3.81%  apt-index-cmd  libstdc++.so.6.0.17  [.] std::string::_M_mutate(unsigned
  3.59%  apt-index-cmd  libstdc++.so.6.0.17  [.] std::ctype<char> const& std::us
  3.00%  apt-index-cmd  libc-2.13.so         [.] __strcmp_sse42
  2.74%  apt-index-cmd  apt-index-cmd        [.] boost::detail::function::functi
  2.72%  apt-index-cmd  libstdc++.so.6.0.17  [.] __dynamic_cast
  2.67%  apt-index-cmd  libc-2.13.so         [.] free
  2.46%  apt-index-cmd  libc-2.13.so         [.] __memcmp_sse4_1

[エンターを押す]

available_parser::AptIndexSpirited::MakeIndex()::{lambda(std::vector<char, std::
    0.00 :          40368a:       je     4036ac <available_parser::AptIndexSpir
         :                                                                     
         :          const std::string& get() const { return my_string_; }      
         :                                                                     
         :          // for 'map' comparison.                                   
         :          bool operator<(const OrderedHashedString& b) const {       
         :            if (ordered_hash_ == b.ordered_hash_) {                  
    2.87 :          40368c:       mov    0x28(%rbx),%rdx                       
         :              return my_string_ < b.my_string_;                      
         :            } else {                                                 
         :              return ordered_hash_ < b.ordered_hash_;                
   34.96 :          403690:       cmp    %rbp,%rdx                             
    1.43 :          403693:       setb   %cl                                   
         :                                                                     
         :          const std::string& get() const { return my_string_; }      
         :                                                                     
         :          // for 'map' comparison.                                   
         :          bool operator<(const OrderedHashedString& b) const {       
         :            if (ordered_hash_ == b.ordered_hash_) {                  
  
 \end{commandline}

\subsubsection{C++ のコードの場合}

C++でテンプレートを活用しているコードを眺める場合、perf report のTUIイン
タフェースだと関数名が十分表示されないなと悩むことになります。とりあえず
TUIじゃないインタフェースにするともっと表示されますが、いまいち全体は表示
できません。

たとえば関数名がこのように途中で切れてしまいます。まだ僕は回避方法を発見して
いません。


\begin{commandline}
 void
 MeasureRaw<std::unordered_map<boost::iterator_range<__gnu_cxx::__normal_iterator<char
 const*, std::string> >, int,
 RangeHash<boost::iterator_range<__gnu_cxx::__normal_iterator<char
 const*, std::string> > >,
 RangeEqualTo<boost::iterator_range<__gnu_cxx::__normal_iterator<char
 const*, std::string> > >,
 std::allocator<std::pair<boost::iterator_range<__gnu_cxx::__normal_iterator<char
 const*, std::string> > const, int> > >, __gnu_cxx::__normal_iterator
\end{commandline}

\printindex

\cleartooddpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule

\end{document}
