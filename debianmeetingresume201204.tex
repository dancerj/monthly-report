%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Tokyo Debian Meeting resources
%     Copyright (C) 2011 Junichi Uekawa
%     Copyright (C) 2011 Nobuhiro Iwamatsu

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image201201; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2012}
\newcommand{\debmtgmonth}{4}
\newcommand{\debmtgdate}{21}
% (+ (* (- 2012 2005) 12) 4 -1) started from zero
\newcommand{\debmtgnumber}{87}

\begin{document}

\begin{titlepage}
\thispagestyle{empty}
% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料\\
\hspace*{-2cm}
\includegraphics[width=210mm]{image201003/debsen.eps}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

% ここはアップデートすること
% 全角文字にしないとフォントのサイズが合わないので注意
\rotatebox{10}{\fontsize{32}{32} {\gt 特集1: XXXX}}

\rotatebox{10}{\fontsize{32}{32} {\gt 特集2: YYYY}}

\vspace*{-2cm}
\hfill{}\includegraphics[height=6cm]{image200502/openlogo-nd.eps}
\end{titlepage}

\dancersection{Introduction}{上川 純一}

\begin{multicols}{2}
 

 今月のDebian勉強会へようこそ。これからDebianの世界にあしを踏み入れると
 いう方も、すでにどっぷりとつかっているという方も、月に一回Debianについ
 て語りませんか？

 Debian勉強会の目的は下記です。

 \begin{itemize}
 \item \underline{Debian Developer} (開発者)の育成。
 \item 日本語での「\underline{開発に関する情報}」を整理してまとめ、アップデートする。
 \item \underline{場}の提供。
 \begin{itemize}
  \item 普段ばらばらな場所にいる人々が face-to-face で出会える場を提供
	する。
  \item Debian のためになることを語る場を提供する。
  \item Debianについて語る場を提供する。
 \end{itemize}
 \end{itemize}		

 Debianの勉強会ということで究極的には参加者全員がDebian Packageをがりがり
 と作るスーパーハッカーになった姿を妄想しています。情報の共有・活用を通し
 て Debianの今後の能動的な展開への土台として、「場」としての空間を提供す
 るのが目的です。

\end{multicols}

\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\begin{multicols}{2}
\tableofcontents
\end{multicols}
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{事前課題}{岩松 信洋}

今回の事前課題は以下です:
\begin{enumerate}
 \item 2012年の勉強会のテーマとして各月なにをするべきか提案してくさい。 
 \item 自分がどのテーマを担当したいか提案してください。
\end{enumerate}
この課題に対して提出いただいた内容は以下です。
\begin{multicols}{2}
{\small
% \input{image201201/prework.tex}
}
\end{multicols}

\dancersection{最近のDebian関連のミーティング報告}{岩松 信洋}
\subsection{東京エリアDebian勉強会86回目報告}

% (query-replace-regexp "<.*?>" "")
% (query-replace-regexp "^[	 ]\+" "")


\dancersection{Debian Trivia Quiz}{岩松 信洋}

ところで、みなさん Debian 関連の話題においついていますか？Debian関連の話
題はメーリングリストをよんでいると追跡できます。ただよんでいるだけではは
りあいがないので、理解度のテストをします。特に一人だけでは意味がわからな
いところもあるかも知れません。みんなで一緒に読んでみましょう。

今回の出題範囲は\url{debian-devel-announce@lists.deban.org} や \url{debian-devel@lists.deban.org}に投稿された
内容とDebian Project Newsからです。

\begin{multicols}{2}
% \input{image201107/quiz.tex}
\end{multicols}

%-------------------------------------------------------------------------------
\dancersection{Debian での node.js 入門}{上川純一}
%-------------------------------------------------------------------------------
\index{nodejs}

Javascriptでプログラムをガリガリ書きたいとおもったことはありませんか?
昨年一時期話題になっていたnode.jsをDebianで試してみましょう。
node.js\footnote{マニュアルなどにはnodeと記述されていますが、通称はnode.js}は
イベントベースのサーバサイドJavascriptエンジンです。シェルスク
リプトの代わりに使うことも出来ますが、javascriptでウェブサーバが書きやす
くなっています。
特徴としてシングルスレッドなんだけどほとんどすべての処理を非同期イベント
処理によって実現することによって、たくさんのリクエストを効率よく処理すると
いうようなことになっているようです。

node.jsのパッケージはsqueezeにはないですが、wheezy にはすでに入っていま
す。
インストールは簡単:
\begin{commandline}
# apt-get install nodejs
\end{commandline}

Node Js 本体はnodejsというパッケージ名で入っていますが、
関連するモジュールパッケージの名前はnode-ではじまるようになっています。

nodejs を実行するとJSインタープリタのREPLインタフェースが起動します。
ここでコマンドラインからjavascriptを適当に実行できるようです。この時点で
は単なるV8のコマンドラインインタフェースですね。

\begin{commandline}
$ node -v 
v0.6.12
$ node
> console.log('hello world')
hello world
\end{commandline}


\subsection{Debian 流儀でのNodeモジュールパッケージインストール}

Debianパッケージで提供されている node.js のモジュールパッケージを使ってみましょう。

\subsubsection{NodeでCLIツールを作ってみる}

とりあえず、Node でコマンドラインツールをつくってみたい、のでnode cli をインストールして
適当にコードを書いてみるという場面を想定してみます。
cli モジュールはDebianパッケージになっているので以下でインストールできま
す。

\begin{commandline}
# apt-get install node-cli
\end{commandline}

とりあえず無駄に平均を計算してみるコードを書いてみました。

\begin{commandline}
// Command-line tool to sum the stdin items.
var cli = require('cli');

cli.withStdinLines(function(lines, newline) {
    var sum = 0;
    var count = 0;

    for (var i = 0; i < lines.length; ++i) {
	console.log(lines[i]);
	if (lines[i] != '') {
	    sum += parseInt(lines[i]);
	    count ++;
	}
    }
    console.log('sum: ' + sum + ' avg: ' + sum / count);
});
\end{commandline}

コマンドラインで適当に実行してみたところ、結果が表示されました。

\begin{commandline}
$ node sum.js < testdata.txt
10
15
200
8

sum: 233 avg: 58.25
\end{commandline}


\subsection{npm -- Node.js のパッケージ管理システム}

Node.js のモジュールは npm で管理されています。Debian パッケージになって
いないパッケージなどは、npm で直接インストールすることも可能です。
Perl でいうCPAN、TeXでいうCTAN のようなもののようです。
Debian パッケージを使うべきかnpmを使って導入するべきか悩ましいところです
が、Debianパッケージになるまでにはタイムラグがあるので、最新のコードをつ
かって開発する場合にはnpmを利用することになると思われます。

Debianの提供するモジュールパッケージは/usr/lib/nodejs 以下にインストール
されますが、
Debian パッケージの npmを利用する場合は /usr/local/lib/nodejs 以下に入り
ます。

で、喜び勇んで手元で実行したところExceptionをはいて終了しました。どうやら node 0.6.2
に対応していないバージョンの npm が現在パッケージされており、動かなくなっ
ている模様です。\debianbug{622628}

\subsection{npmのアップストリーム版をインストールしてみる}

npmが使えないのは不便なので、Debianパッケージになっていないパッケージを
インストールする方法としてDebianパッケージではないnpmを利用する方法を紹
介します。

node 0.6 系列に対応しているnpmは1.1です。
サイトからインストーラをダウンロードして実行します。

npm がインストールできたらモジュールはnpm install でインストールできるよ
うになります。
npm はsudo前提で設計されているようです。

npmパッケージはシステムグローバルにもパッケージローカルにもインストールでき
ますが、
一般ユーザ権限でプロジェクトローカル利用するためにパッケージをインストールすることを基本として設計されているようです。

\texttt{sudo npm install パッケージ名}
だとカレントディレクトリ以下にsudoを発行したユーザ権限でインストールする
ようです。\footnote{ビルド自体はnobody権限で行うようです}
\texttt{sudo npm install -g パッケージ名} だと \verb!/usr/lib/node_modules! 以下にインストール
するようですが、権限はnobodyのままです\footnote{挙動としてはおかし
いので操作を間違っているかバグのように思われる}。

npmは開発者視点で便利なように設計されているようで、個人的におもしろいなと思った
のは\texttt{sudo npm install} だけすると現在のディレクトリにあるプロジェ
クトの依存しているパッケージをカレントディレクトリにインストールするとい
う挙動になることです。依存しているパッケージがどんどん変更されている
熱いプロジェクトであるnode.jsっぽい感じがします。
npmの作者のウェブサイトを読んでいると、システムワイドでインストールする
のはCLIツールなどに必要な時に限って、ウェブサイトにデプロイする用のコー
ドではモジュールはプロジェクトのディレクトリにインストールすることを推奨
すると説明しています。

\begin{commandline}
# apt-get install nodejs nodejs-dev
# curl http://npmjs.org/install.sh | sh
$ sudo npm install -g express ejs socket.io
npm http GET https://registry.npmjs.org/express
npm http GET https://registry.npmjs.org/ejs
npm http GET https://registry.npmjs.org/socket.io
npm http 304 https://registry.npmjs.org/socket.io
npm http 200 https://registry.npmjs.org/ejs
npm http GET https://registry.npmjs.org/ejs/-/ejs-0.6.1.tgz
npm http 200 https://registry.npmjs.org/express
  .
  .
/usr/bin/express -> /usr/lib/node_modules/express/bin/express
ejs@0.6.1 /usr/lib/node_modules/ejs 
express@2.5.8 /usr/lib/node_modules/express 
├── qs@0.4.2
├── mkdirp@0.3.0
├── mime@1.2.4
└── connect@1.8.6
socket.io@0.9.2 /usr/lib/node_modules/socket.io 
├── policyfile@0.0.4
├── redis@0.6.7
└── socket.io-client@0.9.2
\end{commandline}

ディレクトリ構成をまとめました。

\begin{table}[h]
\caption{Debianパッケージおよびnpm でインストールされる場所}
\begin{center}
 \begin{tabular}{|l|l|}
 \hline
 & ディレクトリ\\
 \hline
 Debian パッケージ & \texttt{/usr/lib/nodejs} \\
 Debian の npm  & \texttt{/usr/local/lib/nodejs}\\
 npm install -g & \texttt{/usr/lib/node\_{}modules} \\
 npm install & \texttt{./node\_{}modules} \\
 \hline
 \end{tabular} 
\end{center}
\end{table}

マニュアルなどはnpm コマンドを実行すると表示されるヘルプが充実しています。
\begin{commandline}
$ npm help
$ npm help npm
$ npm help install
\end{commandline}

\subsubsection{npm を使っている場合のプログラム実行}

カレントディレクトリにインストールしたときはよいのですが、そうではない場
合は、\texttt{/usr/lib/node\_{}modules}以下にインストールされてもDebianの
nodejs の標準のモジュールパスに含まれていないためモジュールがロードされません。

そのため、\texttt{NODE\_{}PATH}環境変数を指定して追加でロードされるようにしておきます。
\begin{commandline}
$ NODE_PATH=/usr/lib/node_modules node ./program.js 
\end{commandline}
%$

\subsubsection{パッケージのメタデータ: package.json}

package.json の設定をしてnpm link を使えばパスの追加は必要なくなります。
\begin{commandline}
$ npm link 
\end{commandline}
とすると必要なモジュールをプロジェクトのディレクトリの
\texttt{./node\_{}modules}にリンクしてくれるということでした。
\footnote{マニュアルにはシンボリックリンクをすると書いているけど、モジュー
ルはハードリンクしてました。}
\footnote{逆方向に現在作業中のパッケージを/usr/lib/node\_{}modules/以下
にシンボリックリンクしてくれます。作業した内容がすぐに反映するので便利と
いえば便利。}

npmのメタデータは ./package.json です。
npm help json (man npm-json.1)に詳しく説明されています。
す。とりあえずはname/versionフィールドさえあればよくて、dependenciesを追
加するとnpm install やnpm link コマンドで利用してくれるようです。

インストールに必要なファイルの一覧や、node-waf の実行方法などが記載され
ているのでこれさえあればDebianパッケージを自動で生成することも可能な気が
します。

手元で作成してみた npm linkのためだけの最低限な内容のpackage.jsonを紹介
します
\begin{commandline}
{
    "name": "aptserver",
    "version": "v0.0.1",
    "dependencies": {
	"cli": "",
	"express": "",
	"ejs": ""
    }
} 
\end{commandline}


\subsection{とりあえず簡単なサーバを書いてみた}

apt-cache search をして出力を返すだけの簡単なサーバを書いてみました。
イベントドリブンな部分としては、HTTP requestのハンドラーをapp.get() で登
録している部分と、apt cache の出力を aptCache.stdout.on で登録したハンド
ラーで取得して aptCache.on exit ハンドラーで終了したらHTTPレスポンスを返
すようになっている部分でしょうか。

書いてみて気づきましたが、いまいちnodejsを使うメリットが出てないきもしま
す。


\begin{commandline}
/*
 * A simple server which serves apt cache search results.
 */
var child_process = require('child_process');
var cli = require('cli');
var url = require('url');
var ejs = require('ejs');

cli.parse({
    port: ['p', 'HTTP server will listen on this port.', 'number', 8088]
});

cli.main(function cliMain(args, options) {
    var express = require('express');
    var app = express.createServer();
    // set view options.
    app.set('view engine', 'ejs');
    app.set('view options', { layout: false });
    app.set('views', __dirname + '/views');

    // Set up routes.
    app.get('/', getSlash);
    app.get('/search', getSearch);

    console.log('Start listening on http://localhost:' + options.port + '/');
    app.listen(options.port);
});

/** handler for '/' request */
function getSlash(request, response) {
    response.render('index.ejs');
}

/** handler for '/search?' request */
function getSearch(request, response) {
    var query = request.query.q;
    var aptCache = child_process.spawn('apt-cache', 
				       [ 'search', query ]);
    /** Output of apt-cache search, to be used for response. */
    var responseString = '';
    aptCache.stdout.on('data', function handleAptCacheStdout(data) {
	responseString += data;
    });
    aptCache.stderr.on('data', function handleAptCacheStderr(data) {
	responseString += data;
    });
    aptCache.on('exit', function handleAptCacheExit(exitCode) {
	// apt-cache finished executing, send repsponse back to the server.
	response.render('search.ejs',
			{locals:{query: query,
				 response: responseString}});
    });
}
\end{commandline}

ejs HTMLテンプレートファイル\texttt{views/search.ejs}はこんな内容になり
ました。

\begin{commandline}
<!-- -*- html; -*- -->
<html>
  <body>
    <form
      method=GET 
      action='/search'>
      <input type=text name=q></input>
      <button>search</button>
    </form>
    <h3>Search for: <%= query %></h3>
    <pre>
<%= response %>
    </pre>
  </body>
</html> 
\end{commandline}

追加モジュールはexpress, ejs, cli を使いました。それぞれ

\begin{itemize}
 \item express: ウェブアプリケーションフレームワークとしてnodejsで最もポ
       ピュラーなモジュール、リクエストベースのルーティングなどを担当。
 \item ejs: HTMLテンプレートエンジンとしておそらく最もポピュラーなモジュール。
 \item cli: コマンドラインオプションをパースしてくれるモジュール。
\end{itemize}


\subsection{最後に}

今回は nodejs をDebianで使う方法を紹介してみました。
モジュールのパッケージングが更新においついていない感じなのでもうしばらく
したらまた良くなっているかもしれません。
nodejs の頻繁な更新と複数バージョンの必要性から
は nave / nvm などの環境管理ツールで複数バージョンをインストール
して利用するということもよくやられているようです。
Debianでnodejsを活用するきっかけになれば幸いです。

\begin{thebibliography}{0}
\bibitem{nodejslocalhtml}  Node.js v0.6.12 Manual \& Documentation
	\url{/usr/share/doc/nodejs/api/index.html}
\bibitem{pkg-javascript-devel} Alioth の 　pkg-javascript-devel メーリン
	グリスト
	\url{http://lists.alioth.debian.org/pipermail/pkg-javascript-devel/}
\bibitem{npmjs} NPMホームページ \url{http://npmjs.org/}
\end{thebibliography}

%-------------------------------------------------------------------------------
\dancersection{debiandroid計画}{YYY}
%-------------------------------------------------------------------------------
\index{debiandroid}

Debian GNU/Linux (arm) inside Android chrootの計画について。



\begin{thebibliography}{0}
\bibitem{lildebi} Lil' Debi \url{https://github.com/guardianproject/lildebi/wiki}
\end{thebibliography}


\printindex

\cleartooddpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule

\end{document}
