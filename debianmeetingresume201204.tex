%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Tokyo Debian Meeting resources
%     Copyright (C) 2011 Junichi Uekawa
%     Copyright (C) 2011 Nobuhiro Iwamatsu

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image201201; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2012}
\newcommand{\debmtgmonth}{4}
\newcommand{\debmtgdate}{21}
% (+ (* (- 2012 2005) 12) 4 -1) started from zero
\newcommand{\debmtgnumber}{87}

\begin{document}

\begin{titlepage}
\thispagestyle{empty}
% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料\\
\hspace*{-2cm}
\includegraphics[width=210mm]{image201003/debsen.eps}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

% ここはアップデートすること
% 全角文字にしないとフォントのサイズが合わないので注意
\rotatebox{10}{\fontsize{32}{32} {\gt 特集１: Ｄｅｂｉａｎでのｎｏｄｅ入門}}
\vspace*{-2cm}
\rotatebox{10}{\fontsize{32}{32} {\gt 特集２: Ａｎｄｒｏｉｄ機でＤｅｂｉａｎ}}
\vspace*{-2cm}
\rotatebox{10}{\fontsize{32}{32} {\gt 特集３: 月刊Ｄｅｂｈｅｌｐｅｒ}}

\vspace*{-2cm}
\hfill{}\includegraphics[height=6cm]{image200502/openlogo-nd.eps}
\end{titlepage}

% Title should be in Japanese text so that we can use it as lint for PDF shiori.
\dancersection{はじめに}{上川 純一}

\begin{multicols}{2}
 

 今月のDebian勉強会へようこそ。これからDebianの世界にあしを踏み入れると
 いう方も、すでにどっぷりとつかっているという方も、月に一回Debianについ
 て語りませんか？

 Debian勉強会の目的は下記です。

 \begin{itemize}
 \item \underline{Debian Developer} (開発者)の育成。
 \item 日本語での「\underline{開発に関する情報}」を整理してまとめ、アップデートする。
 \item \underline{場}の提供。
 \begin{itemize}
  \item 普段ばらばらな場所にいる人々が face-to-face で出会える場を提供
	する。
  \item Debian のためになることを語る場を提供する。
  \item Debianについて語る場を提供する。
 \end{itemize}
 \end{itemize}		

 Debianの勉強会ということで究極的には参加者全員がDebian Packageをがりがり
 と作るスーパーハッカーになった姿を妄想しています。情報の共有・活用を通し
 て Debianの今後の能動的な展開への土台として、「場」としての空間を提供す
 るのが目的です。

\end{multicols}

\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\begin{multicols}{2}
\tableofcontents
\end{multicols}
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{事前課題}{野島 貴英}

今回の事前課題は以下です:
\begin{enumerate}
 \item Debianで触ったことのあるウェブアプリケーションフレームワーク一つを簡潔に教えてください。
 \item 近々作成してみたいと思っているウェブアプリケーションを教えてください。
\end{enumerate}
この課題に対して提出いただいた内容は以下です。
\begin{multicols}{2}
{\small
 \input{image201204/prework.tex}
}
\end{multicols}

% (query-replace-regexp "<.*?>" "")
% (query-replace-regexp "^[	 ]\+" "")

\dancersection{最近の Debian 関連のミーティング報告}{野島 貴英}
\subsection{東京エリア Debian 勉強会 85 回目報告}

 2月の東京エリアDebian勉強会は、三栄町生涯学習館 視聴覚室で行われました。

当日、福岡Debian勉強会が開かれ、そちらに出席者された方が多かった為か、
出席者5人での開催となりました。発表内容としては、debianでKDE4.7.4用の開
発環境を作り簡単なパッケージを作るまでの話、月刊Debhelperでは
dh\_dpatch\_patchコマンド、dh\_autotools-dev\_updateconfigコマンド、最
後にKDE開発に使われるcmakeについてあれこれの話が行われました。参加者に
ソフトウェア開発関係者の方が多かった為か、autotoolsの使い方をはじめ、ソ
フトウェア開発について話がいろいろ盛り上がったのが印象的でした。

\subsection{東京エリア Debian 勉強会 86 回目報告}

　3月の東京エリアDebian勉強会はOSC 2012 Tokyo/Springの会場で岩松さんにて
行われました。本来東京エリアDebian勉強会は開発者寄りの話題を扱うのですが、今回は
ユーザ向け企画としてDebianのApacheサーバーの構成とDebianならではの
使い方に関する発表が行われました。最近のW3Techsの発表によると、世界で利用されている
LinuxベースのWebサーバーでは1位,2位（2012/1時点では1位）を僅差で争う状況との
事\footnote{\url{http://w3techs.com/blog/entry/debian_is_now_the_most_popular_linux_distribution_on_web_servers}}です。今後も益々数が増えているとの事ですので、
Debianユーザの期待に答えるべく開発の方も頑張りましょう。

\dancersection{Debian Trivia Quiz}{野島 貴英}

ところで、みなさん Debian 関連の話題においついていますか？Debian関連の話
題はメーリングリストをよんでいると追跡できます。ただよんでいるだけではは
りあいがないので、理解度のテストをします。特に一人だけでは意味がわからな
いところもあるかも知れません。みんなで一緒に読んでみましょう。

今回の出題範囲は\url{debian-devel-announce@lists.deban.org} や \url{debian-devel@lists.deban.org}に投稿された
内容とDebian Project Newsからです。

\begin{multicols}{2}
 \input{image201204/quiz.tex}
\end{multicols}

%-------------------------------------------------------------------------------
\dancersection{Debian での node 入門}{上川純一}
%-------------------------------------------------------------------------------
\index{node.js}
\index{node}
\index{javascript}

JavaScriptでプログラムをガリガリ書きたいとおもったことはありませんか?
昨年（2011年）一時期話題になっていたnodeをDebianで試してみましょう。
node\footnote{マニュアルなどにはnodeと記述されていますが、通称は
node.jsのようです}は
イベントベースのサーバサイドJavaScriptエンジンとフレームワークです。
何に使えるかというと、JavaScriptでウェブサーバが書きやすくなっています。
シェルスクリプトでコードを書く代わりにnodeを使ってJavaScriptを使うことも
まぁ出来ますがウェブサーバが便利になるのが一番大きいと思われます。
特徴はシングルスレッドなんだけどほとんどすべてのI/O処理を非同期イベント
処理によって実現することによって、たくさんのリクエストを効率よく処理する
あたりでしょうか。

node のパッケージはsqueezeにはないですが、wheezy にはすでに入っていま
す。
インストールは簡単:
\begin{commandline}
# apt-get install nodejs
\end{commandline}

Node 本体は nodejs というパッケージ名で入っています\footnote{すでにnodeと
いうパッケージが存在するからnodeという名前がつけられなかったのだと思われ
ます。}が、関連するモジュールパッケージの名前はnode-ではじまるようになっ
ています。

node コマンドを実行するとJavaScriptインタープリタのREPLインタフェースが起
動します。ここでコマンドラインからJavaScriptを適当に実行できるようです。
この時点では単なるV8のコマンドラインインタフェースですね。

\begin{commandline}
$ node -v 
v0.6.12
$ node
> console.log('hello world')
hello world
\end{commandline}

nodeのバージョン番号ですが、node の2012年4月1日時点の安定版の最新版は0.6
系列で、0.7系列は開発版という位置づけのようです。0.8系列がリリースされた
らまたDebianのnodeも更新されるでしょう。

まとめると次のようになっています。
\begin{itemize}
 \item 0.4: 2012年1月までDebian sid に入っていた安定版
 \item 0.6.12: 2012年4月時点での最新安定版(stable)
 \item 0.7.x: 開発版(unstable)
 \item 0.8.x: 多分近い将来リリースされるだろう安定版
\end{itemize}

\subsection{Debian 流儀でのNodeモジュールパッケージインストール}

Debianパッケージで提供されている node のモジュールパッケージを使ってみましょう。

\subsubsection{NodeでCLIツールを作ってみる}

とりあえず、node でコマンドラインインタフェース（CLI)のツールをつくってみたい、のでnode cli を
インストールして適当にコードを書いてみるという場面を想定してみます。cli
モジュールはDebianパッケージになっているので以下でインストールできます。
\index{node-cli}

\begin{commandline}
# apt-get install node-cli
\end{commandline}

とりあえず無駄に平均を計算してみるコードを書いてみました。

\begin{commandline}
// Command-line tool to sum the stdin items.
var cli = require('cli');

cli.withStdinLines(function(lines, newline) {
    var sum = 0;
    var count = 0;

    for (var i = 0; i < lines.length; ++i) {
	console.log(lines[i]);
	if (lines[i] != '') {
	    sum += parseInt(lines[i]);
	    count ++;
	}
    }
    console.log('sum: ' + sum + ' avg: ' + sum / count);
});
\end{commandline}

コマンドラインで適当に実行してみたところ、結果が表示されました。

\begin{commandline}
$ node sum.js < testdata.txt
10
15
200
8

sum: 233 avg: 58.25
\end{commandline}
%$
\subsection{npm -- Node のパッケージ管理システム}
\index{npm}

Node のモジュールは npm で管理されています。Debian パッケージになって
いないパッケージなどは、npm コマンドを利用して直接インストールすることも可能です。
Perl でいうCPAN、TeXでいうCTAN のようなもののようです。
Debian パッケージを使うべきかnpmを使って導入するべきか悩ましいところです
が、Debianパッケージになるまでにはどうしてもタイムラグがあるので、最新のコードをつ
かって開発する場合にはnpmを利用することになると思われます。ある程度こな
れてきたらないパッケージはITPするのがよいでしょう。

Debianの提供するモジュールパッケージは/usr/lib/nodejs 以下にインストール
されますが、
Debian パッケージの npmを利用する場合は /usr/local/lib/nodejs 以下に入り
ます。

で、喜び勇んで手元で実行したところExceptionをはいて終了しました。どうやら
node 0.6.2に対応していない古いバージョンの npm (Node 0.4系列ではうごいた
はず)が現在パッケージされており、動かなくなっている模様です。
\debianbug{622628}

\subsection{npmのアップストリーム版をインストールしてみる}

npmが使えないのは不便なので、Debianパッケージになっていないnodeモジュール
をインストールする方法としてDebianパッケージではないnpmを利用する方法を紹
介します。

node 0.6 系列に対応しているnpmは1.1です。
npmjs\cite{npmjs} サイトからインストーラをダウンロードして実行します。
npm がインストールできたらモジュールは npm installコマンドでインストールできるよ
うになります。
\index{npm install}

npm は sudo 前提で設計されているようです。sudoでroot権限に昇格するのはビ
ルド時にnobody権限に切り替えるのに使うようです。

npmパッケージはシステムグローバルにもパッケージローカルにもインストールで
きますが、一般ユーザ権限でプロジェクトローカルに利用するためにパッケージ
をインストールすることを基本として設計されているようです。

\texttt{sudo npm install パッケージ名}
だとカレントディレクトリ以下にsudoを発行したユーザ権限でインストールする
ようです。\footnote{ビルド自体はnobody権限で行うようです}
\texttt{sudo npm install -g パッケージ名} だと \verb!/usr/lib/node_modules! 以下にインストール
するようですが、権限はnobodyのままです\footnote{挙動としてはおかし
いので操作を間違っているかバグのように思われる}。

npmは開発者視点で便利なように設計されているようで、個人的におもしろいなと思った
のは -g をつけずに \texttt{sudo npm install} だけすると現在のディレクトリにあるプロジェ
クトの依存しているパッケージをカレントディレクトリにインストールするとい
う挙動になることです。依存しているパッケージがどんどん変更されている
熱いプロジェクトであるnodeっぽい感じがします。
npmの作者のウェブサイトを読んでいると、システムワイドでインストールする
のはCLIツールなどに必要な時に限って、ウェブサイトにデプロイする用のコー
ドではモジュールはプロジェクトのディレクトリにインストールすることを推奨
すると説明しています。

\begin{commandline}
# apt-get install nodejs nodejs-dev
# curl http://npmjs.org/install.sh | sh
$ sudo npm install -g express ejs socket.io
npm http GET https://registry.npmjs.org/express
npm http GET https://registry.npmjs.org/ejs
npm http GET https://registry.npmjs.org/socket.io
npm http 304 https://registry.npmjs.org/socket.io
npm http 200 https://registry.npmjs.org/ejs
npm http GET https://registry.npmjs.org/ejs/-/ejs-0.6.1.tgz
npm http 200 https://registry.npmjs.org/express
  .
  .
/usr/bin/express -> /usr/lib/node_modules/express/bin/express
ejs@0.6.1 /usr/lib/node_modules/ejs 
express@2.5.8 /usr/lib/node_modules/express 
├── qs@0.4.2
├── mkdirp@0.3.0
├── mime@1.2.4
└── connect@1.8.6
socket.io@0.9.2 /usr/lib/node_modules/socket.io 
├── policyfile@0.0.4
├── redis@0.6.7
└── socket.io-client@0.9.2
\end{commandline}

ディレクトリ構成をまとめました。

\begin{table}[h]
\caption{Debianパッケージおよびnpm でインストールされる場所}
\begin{center}
 \begin{tabular}{|l|l|}
 \hline
 & ディレクトリ\\
 \hline
 Debian パッケージ & \texttt{/usr/lib/nodejs} \\
 Debian の npm  & \texttt{/usr/local/lib/nodejs}\\
 npm install -g & \texttt{/usr/lib/node\_{}modules} \\
 npm install & \texttt{./node\_{}modules} \\
 \hline
 \end{tabular} 
\end{center}
\end{table}

マニュアルなどはnpm コマンドを実行すると表示されるヘルプが充実しています。
\begin{commandline}
$ npm help
$ npm help npm
$ npm help install
\end{commandline}
%$ -- for emacs

\subsubsection{npm を使っている場合のプログラム実行}

カレントディレクトリにインストールしたときはよいのですが、そうではない場
合は、\texttt{/usr/lib/node\_{}modules}以下にインストールされてもDebianの
nodejs の標準のモジュールパスに含まれていないためモジュールがロードされません。

ひとつの回避策としてはモジュールを探しに行くPATHを追加するという方法があります。
\texttt{NODE\_{}PATH}環境変数を指定すれば追加でロードされるようになりま
す。
\index{NODE\_{}PATH}
\begin{commandline}
$ NODE_PATH=/usr/lib/node_modules node ./program.js 
\end{commandline}
%$ -- for emacs

\subsubsection{パッケージのメタデータ: package.json}

推奨されているのはパッケージに必要なモジュールをpackage.json に記述して、
\index{npm link}
npm link コマンドを実行すればパスの追加は必要なくなります。
\begin{commandline}
$ npm link 
\end{commandline}
%$
とすると必要なモジュールをプロジェクトのディレクトリの
\texttt{./node\_{}modules}にリンクしてくれるということでした。
\footnote{マニュアルにはシンボリックリンクをすると書いているけど、モジュー
ルはハードリンクしてました。}
\footnote{逆方向に現在作業中のパッケージを/usr/lib/node\_{}modules/以下
にシンボリックリンクしてくれます。作業した内容がすぐに反映するので便利と
いえば便利。}

\index{package.json}
npmのメタデータは ./package.json です。
npm help json (man npm-json.1)に詳しく説明されています。
す。とりあえずはname/versionフィールドさえあればよくて、dependenciesを追
加するとnpm install やnpm link コマンドで利用してくれるようです。

インストールに必要なファイルの一覧や、node-waf の実行方法などが記載され
ているのでこれさえあればDebianパッケージを自動で生成することも可能な気が
します。

手元で作成してみた npm linkのためだけの最低限な内容のpackage.jsonを紹介
します

\begin{commandline}
{
    "name": "aptserver",
    "version": "v0.0.1",
    "dependencies": {
	"cli": "",
	"express": "",
	"ejs": ""
    }
} 
\end{commandline}


\subsection{とりあえず簡単なサーバを書いてみた}

apt-cache search をして出力を返すだけの簡単なサーバを書いてみました。
イベントドリブンな部分としては、HTTP requestのハンドラーをapp.get() で登
録している部分と、apt cache の出力を aptCache.stdout.on で登録したハンド
ラーで取得して aptCache.on exit ハンドラーで終了したらHTTPレスポンスを返
すようになっている部分でしょうか。

書いてみて気づきましたが、いまいちnodeを使うメリットが出てないきもしま
す。


\begin{commandline}
/*
 * A simple server which serves apt cache search results.
 */
var child_process = require('child_process');
var cli = require('cli');
var url = require('url');
var ejs = require('ejs');

cli.parse({
    port: ['p', 'HTTP server will listen on this port.', 'number', 8088]
});

cli.main(function cliMain(args, options) {
    var express = require('express');
    var app = express.createServer();
    // set view options.
    app.set('view engine', 'ejs');
    app.set('view options', { layout: false });
    app.set('views', __dirname + '/views');

    // Set up routes.
    app.get('/', getSlash);
    app.get('/search', getSearch);

    console.log('Start listening on http://localhost:' + options.port + '/');
    app.listen(options.port);
});

/** handler for '/' request */
function getSlash(request, response) {
    response.render('index.ejs');
}

/** handler for '/search?' request */
function getSearch(request, response) {
    var query = request.query.q;
    var aptCache = child_process.spawn('apt-cache', 
				       [ 'search', query ]);
    /** Output of apt-cache search, to be used for response. */
    var responseString = '';
    aptCache.stdout.on('data', function handleAptCacheStdout(data) {
	responseString += data;
    });
    aptCache.stderr.on('data', function handleAptCacheStderr(data) {
	responseString += data;
    });
    aptCache.on('exit', function handleAptCacheExit(exitCode) {
	// apt-cache finished executing, send repsponse back to the server.
	response.render('search.ejs',
			{locals:{query: query,
				 response: responseString}});
    });
}
\end{commandline}

ejs HTMLテンプレートファイル\texttt{views/search.ejs}はこんな内容になり
ました。

\begin{commandline}
<!-- -*- html; -*- -->
<html>
  <body>
    <form
      method=GET 
      action='/search'>
      <input type=text name=q></input>
      <button>search</button>
    </form>
    <h3>Search for: <%= query %></h3>
    <pre>
<%= response %>
    </pre>
  </body>
</html> 
\end{commandline}

追加モジュールはexpress, ejs, cli を使いました。それぞれを簡単に紹介する
と以下です

\begin{itemize}
 \item express: ウェブアプリケーションフレームワークとしてnodeで最もポ
       ピュラーなモジュール、リクエストベースのルーティングなどを担当。
 \item ejs: HTMLテンプレートエンジンとしておそらく最もポピュラーなモジュール。
 \item cli: コマンドラインオプションをパースしてくれるモジュール。
\end{itemize}


\subsection{最後に}

今回は node をDebianで使う方法を紹介してみました。モジュールのパッケージ
ングが更新においついていない感じなのでもうしばらくしたらまた良くなってい
るかもしれませんが、そうこうしているうちにnode 0.8がリリースされてしまい
そうです。
node の頻繁な更新とそれによってモジュールが複数バージョン必要になってく
る現状から、nave / nvm などの環境管理ツールで複数バージョンをインストール
して利用するということもよくやられているようです。
この資料がDebianでnodeを活用するきっかけ、およびパッケージ化活動の一助になれば幸いです。

\begin{thebibliography}{0}
\bibitem{nodejslocalhtml}  Node.js v0.6.12 Manual \& Documentation
	\url{/usr/share/doc/nodejs/api/index.html}
\bibitem{pkg-javascript-devel} Alioth の 　pkg-javascript-devel メーリン
	グリスト
	\url{http://lists.alioth.debian.org/pipermail/pkg-javascript-devel/}
\bibitem{npmjs} NPMホームページ \url{http://npmjs.org/}
\bibitem{debiannode} nodejs for Debian \url{/usr/share/doc/nodejs-dev/README.Debian}
\end{thebibliography}

%-------------------------------------------------------------------------------
\dancersection{Android機でDebian}{野島 貴英}
%-------------------------------------------------------------------------------
\index{debiandroid}
\index{Android}
\subsection{はじめに} 
携帯電話、タブレット型PCなど、高性能の情報端末を持ち歩くのが一般的になってきました。
ここでは、これら情報端末のうち、Android OSを搭載した情報端末にDebianを入れ、
Debian開発者の環境を築いてみようとした事について述べます。

\subsection{材料：Android端末 Barnes \& Noble Nook Colorについて}
\index{nook color}

　手頃なAndroid端末として、たまたま手元にBarnes \& Noble社(以下B\&N)の
Nook Colorという製品\footnote{\url{http://www.barnesandnoble.com/p/nook-color-barnes-noble/1100437663}}があります\footnote{製品の写真は権利関係がよく判らないので割愛させてください。詳しくは先のURL参照。}。値段も日本で輸入した場合、
2万円前半〜後半ぐらいで安く、電子書籍ビューアということもあり
デザインも小型でそれなりに薄く軽量です。これは元々、PDFにした
カラーの本（漫画も）を持ち歩きながら読めればと思って買っていたものでした。

これがDebianの開発環境としても動いたら素敵と思い、こちらを
早速利用する事にします。

※実は、自分はフィーチャーフォン（ガラケーともいう）しか持っておらず、Android端末はこれしか持ってなかったことは秘密です。

\subsection{Android端末のDebian動作の方針}

　Android端末を利用してDebian関係のディストリビューションのOSを動作させる場合、
後に述べる２つの方針が取れます。

\subsubsection{方針1: Android端末の機能を最大限活用する}

　本方針は、Android端末はベースのOSが基本的にLinuxであることを最大限利用します。

ここで、
\begin{enumerate}
\item Android端末のCPUにあわせたDebian関係のLinuxのファイルシステムを/（ルート）ファイルシステムからSDカードや、内臓メモリへ用意します。
\item Android端末にAndroidアプリのVNC Viewer\footnote{\url{http://code.google.com/p/android-vnc-viewer/}}を搭載しておきます。
\item 何らかの方法でAndroid端末上の管理権限を奪取した状態で、先ほど用意した/ファイルシステムをマウントし、chrootします。これでDebianのバイナリが動作できるようになります。
\item 最後にDebianのバイナリを利用してvncserverを立ち上げ、AndroidアプリのVNC Viewerで127.0.0.1:5901に接続し、Debianを利用します。
\end{enumerate}
という方法がよく利用されます。

　この方法は、Android端末で、管理権限さえ奪取できていればDebian関係のLinuxディストリ意ビューションを動作させる事ができます。さらに良いことに、本体のAndroid端末が最初から搭載しているWi-Fiネットワークもそのまま利用できるるため、非常に都合が良いです。実際、自分は未評価ですが、これらの諸々の手続きを全部アプリに詰め込んでしまったものに、
\begin{itemize}
\item ubuntuを動作させるAndroid アプリ：ubuntu instller free \url{https://play.google.com/store/apps/details?id=com.zpwebsites.ubuntuinstall&hl=ja}
\item Debianを動作させるAndroid アプリ: Lil' Debi \url{https://github.com/guardianproject/lildebi/wiki}
\end{itemize}
などがある模様です。

% ubuntu on nook スレ
% http://forum.xda-developers.com/showthread.php?p=10306407
\subsubsection{方針2: Android OSを使わずそのままDebianをブートする}

 Android端末は大抵ARMベースのCPUで動いてます。DebianもARMベースのバイナリを
用意しています。これはつまり、うまくカーネル/アプリケーションをAndroid端末の
ハードの仕様に合わせることができ、ブートさせる事ができれば、Android OSの
代わりにDebianをそのままブートさせて使えるはずです。

　ただ、Android端末はARMベースのCPUは使っているものの、グラフィックス
（液晶画面出力）、タッチパネル、サウンド、Wi-Fi等は各端末のハード独自のものでかつ、
仕様/設計は未公開であったり、Linuxカーネル本体の機能だけでは対応できなかったりする為、
これらの周辺デバイスを利用できるようにする為のハードルは高い状況です。特に、
Wi-Fiはおろか、通常のデスクトップPCを使っているときにはあまりに基本的な機能で
気にもとめなかったような機能（キー入力、マウス入力、画面に文字を描画）すらも
最初から未対応がほとんどですので、本方針を取るにはそれ相応のスキルが必要です。
（VGA BIOSとか、IBM PC ATのBIOSの規格が大変ありがたく見えてきます）

　但し、本方針でもしDebianをそのまま利用できれば、より自由なソフトウェア開発環境を
搭載した携帯端末を手にできる事になる為、非常に魅力的ではあります（よね？）

\subsection{数々の障害と方針変更}

 先に述べた方針1が手軽なはずなので、こちらの方針をとって作業を進めていました。
が、実は以下に列挙する問題にあたってしまい、解決出来なかった為、不完全ながらも
方針2を取らざるを得ない状況となってしまいました。

\begin{enumerate}
\item B\&NのNook Colorは、Android 2.1〜2.2 OSを改造して電子書籍端末にした製品のため、通常のAndroid OSとは異なります。そのため、Android端末でそのまま動作させることができるようなアプリをどうやってもインストールできませんでした。つまり頼みのVNC Viewerを動作させる事が出来ませんでした。また、こちらの原因を調べようにも、ソース公開義務の発生しない肝心のライブラリ、アプリケーションフレームワーク、アプリケーション\footnote{Android OSの用語となります。基本的なAndroid OSの構造：\url{http://developer.android.com/images/system-architecture.jpg}}が全くの非公開であるため原因追求が困難です。
\item 管理権限を奪取してadbが使えるようにしたのですが、USB経由で利用するNook Color側のadbdの動作が非常に不安定で、一度でもUSBを外す/PCの電源を落とす/何もせず時間を空けると次からどうやっても端末側adbdに接続できなくなる現象に悩まされました（管理権限奪取の方法を最初からやり直すと復活できる事がたまにあったが、なぜか失敗する事が多かった。）さらに悪い事に、端末側ファームを1.2.2にアップデートすると、もはやどうやってもadbdに接続できなくなってしまいました\footnote{後の調査でわかったことですが、Wi-Fi経由で端末側adbdに接続すると安定するかも？との情報もあります。が、Wi-Fi環境を自分は持っていない為、こちらも未評価です}。
\end{enumerate}

　そこで、方針1をあきらめ、方針2を取る事にしました。

\subsection{再考：Nook Color}

 DebianをAndroid端末の機能を最大限活用して動作させるのにいろいろてこずる
Nook Colorですが、このやり方を諦めれば、唯一Debianを動作させるのに救いのある機能があります。
Nook ColorはminiSDを挿入して利用できるのですが、ここにOMAP用ブート形式\footnote{\url{http://processors.wiki.ti.com/index.php/SD/MMC_format_for_OMAP3_boot}。但しこのページのコマンド通りにそのままfdisk実行しても、Debianではブートイメージは作れないので注意。}のブートイメージを書きこんでおくと、こちらからそのままブートしてしまう機能（脆弱性？）があります。

　そこで、ここにブートイメージを書き込んで、ブートすればDebianを利用できるのでは？
という事を試しました。

\subsection{DebianのNook Color用ブートイメージを作る}

\subsubsection{方針}

 ここでは、以下の方針にそってブートイメージを作成します。

\begin{enumerate}
\item qemuを使ってDebianのARM用ディスクイメージを構築します。
\item Nook Colorのroot奪取に使うnooter0.2.zipのカーネル/initrdイメージはNook ColorのUSBをRNDIS用のネットワークI/Fにセットアップする能力を持ちます。これを利用すると、コミュニケーションポートとしてUSBが非常に便利になるのでこれらを拝借します。
\item 以上1,2を合体したOMAP用ブート形式のminiSDカードを作成します。
\end{enumerate}

具体的なやり方を次に述べます。

\subsubsection{やり方}

用意するもの：Debian sidの動くPC,グローバル回線, miniSDカード1枚、必要ならminiSDカー
ドライター（USBメモリに変換するタイプのコネクタでも可）

\begin{enumerate}
\item  諸々PC側に取り揃えます。
\begin{commandline}
$ sudo aptitude install debian-installer-6.0-netboot-armel qemu-system util-linux kpartx dump unzip gvncviewer
$ wget http://cgit.openembedded.org/openembedded/plain/contrib/angstrom/omap3-mkcard.sh; chmod 755 omap3-mkcard.sh
\end{commandline}

\item イメージディスクの準備をします。
\begin{commandline}
$ qemu-img create -f raw arm-versatile.img 5G
\end{commandline}
%$

\item インストール作業を行う為、以下のコマンドを実行します\footnote{LXDEデスクトップにする理由は、GNOMEだとメモリの必要量が多すぎてswapが発生してしまい、快適に動作しない為です}。

\begin{commandline}
$ qemu-system-arm -M versatilepb -kernel /usr/lib/debian-installer/images/armel/versatile/vmlinuz-2.6.32-5-versatile \
 -initrd /usr/lib/debian-installer/images/armel/versatile/initrd.gz -m 256 -drive file=./arm-versatile.img,if=scsi,\
 bus=0,unit=0,cache=writeback -append "root=/dev/ram desktop=lxde priority=medium"
\end{commandline}
%$

\item  Debianインストーラがウインドウに立ち上がり、通常のインストーラメニュー形式のDebianのインストールを進める事ができるようになります。ネットワークも自動的に認識(IPアドレスなども)され、qemuの持つネットワークの仕組みでPCに接続されたネットワークがそのままネットワーク経由のインストールに利用されます。表\ref{tab:armsid-ver}を選択しつつインストールを行います。

\begin{table}[ht]
\begin{center}
\begin{tabular}{|l|p{5cm}|p{5cm}|l|}
\hline 
項番&設定項目&指定内容&備考\\
\hline \hline
1&Choose language & Japanese 日本語 &\\
2&ネットワークの設定 & DHCPでネットワークを自動で設定 & \\
3&インストールするDebianバージョン&sid&\\
4&ロードするインストーラコンポーネント&何も選ばない&何も選ばないが、「続ける」だけは選択\\
5&ディスクのパーティショニング&ディスク全体を使う,すべてのファイルを1つのパーティションに&\\
6&ソフトウェアの選択&デスクトップ環境、ラップトップ、標準システムの3つ& お好みで\\
7&インストールするLinuxカーネルのバージョン&3.2.0-2& \\
\hline
\end{tabular}
\caption{\label{tab:armsid-ver}インストーラで選択する項目}
\end{center}
\end{table}

\item インストールが完了し、最後にシャットダウン画面になります。最後Reboot systemの指示が出たのを確認してそのままqemuをCtrl+Cで停止させます。

\item インストール完了後のディスクイメージに内臓されているカーネルイメージ、initrdイメージを取り出します。

\begin{commandline}
$ mkdir debian
$ sudo kpartx -a ./arm-versatile.img 
$ sudo mount -t ext3 /dev/mappoer/loop0p1 ./debian
$ cp debian/boot/initrd.img-3.2.0-2-versatile .
$ cp debian/boot/vmlinuz-3.2.0-2-versatile .
$ sudo umount ./debian
$ sudo kpartx -d ./arm-versatile.img
loop deleted : /dev/loop0
$
\end{commandline}
%$

\item 以下のコマンドで取り出したカーネルイメージ、initrdイメージで再度qemuを立ち上げます。xdmの画面が出るので、ログイン。するとLXDEのデスクトップ画面になっておきます。

\begin{commandline}
$ qemu-system-arm -M versatilepb -kernel ./vmlinuz-3.2.0-2-versatile \
 -initrd ./initrd.img-3.2.0-2-versatile -m 256 -drive file=./arm-versatile.img,if=scsi,\
 bus=0,unit=0,cache=writeback -append "root=/dev/sda1 "
\end{commandline}
%$

\item LXDEの画面から、lxterminalを開き、パッケージをアップデートする。さらに、vncサーバーの導入を行っておきます。

\begin{commandline}
$ su root
Passwd: インストール時のrootパスワード
# aptitude update;aptitude safe-upgrade;aptitude install tightvncserver
\end{commandline}
%$

\item vncサーバーのインストールが完了したら、LXDE端末画面でシャットダウンします。
\begin{commandline}
$ sudo shutdown -h now
\end{commandline}
%$

\item Power offのメッセージが出力されたら、qemuをCtrl+Cで停止します。

\item miniSDをPCに差し込みます。mountされてしまっているようであれば、必ずumountしておきます。（注：ここでは/dev/sdb1としてマウントされてしまった事を過程します）
\begin{commandline}
$ sudo umount /dev/sdb1
\end{commandline}
%$
Tips:\\
なお、PCのminiSDのリーダ/ライターを搭載している場合、miniSDアクセス用のチップがRicho R5C822を搭載している場合で（よくある）、miniSDを挿入すると''mmc0: error -110 whilst initialising SD card''や、''mmc0: Reset 0x1 never completed''などが大量にdmesgに記録されて全くアクセスできない場合があります。この場合は以下の定義を/etc/modulesに記載してリブートすると、安定してminiSDへアクセスできるようになります。
\begin{commandline}
$ cat /etc/modules
...中略...
# for R5C822
mmc_block
tifm_sd
$ 
\end{commandline}

\item miniSDにOMAP用ブート形式のパーティショニングを行います。\\
注：必ずminiSDの認識されているデバイスファイルを指定してください！ここでは/dev/sdbと仮定しています。間違ったデバイスファイルを指定すると該当ディスクの中身が消えてしまいます。
\begin{commandline}
$ sudo ./omap3-mkcard.sh /dev/sdb
\end{commandline}
%$

\item nooter0.2配布先(\url{http://www.mediafire.com/?cfddu9wt9d8dunl})をepiphanyなどのWEBブラウザでアクセスして、nooter0.2.zipを入手します。

\item 解凍して、nooter/にマウントします。
\begin{commandline}
$ unzip nooter0.2.zip
$ mkdir nooter
$ sudo kpartx -a ./nooter_sdcard_40mb.img
$ sudo mount /dev/mapper/loop0p1 ./nooter
\end{commandline}
%$

\item miniSDカードの1つ目のパーティション(/dev/sdb1)をマウントします。
\begin{commandline}
$ mkdir miniSD
$ sudo mount -t vfat -o rw,uid=your-uid,gid=your-gid /dev/sdb1 ./miniSD
\end{commandline}
%$

\item nooterのu-bootイメージ、カーネルイメージ、initrdイメージをコピーして、miniSD,nooterをアンマウントします。
\begin{commandline}
$ cp nooter/* ./miniSD/
$ sudo umount ./nooter
$ sudo kpartx -d ./nooter_sdcard_40mb.img
loop deleted : /dev/loop0
$ sudo umount ./miniSD
\end{commandline}
%$ 

\item miniSDの２つ目のパーティション(/dev/sdb2)をマウントして、Debianイメージをまるごとコピーします。終わったらアンマウントします。
\begin{commandline}
$ su root
Passwd: 
# kpartx -a ./arm-versatile.img
# mount /dev/mapper/loop0p1 ./debian
# mount /dev/sdb2 ./miniSD
# cd debian
# dump -0 -f- ./ | (cd ../miniSD && restore -rvf- )
# cd ..
# umount ./debian
# umount ./miniSD
\end{commandline}
%$ 
\end{enumerate}

以上となります。

\subsection{動作させる}

早速動作させてみましょう。

\begin{enumerate}
\item Nook Colorの電源ボタンを長押しして電源をOFFにします。
\item Nook ColorのminiSDスロットに作ったminiSDを挿入します。
\item Nook Colorに製品付属のusbケーブルを差し込み、PCのUSBに差し込みます。
\item usbケーブルが橙→緑に変わる。同時にPC側のdmesgを観察すると、cdc\_etherモジュールがロードされ、usbポートがNICに変化するのが観察できます。
\item 以下のコマンドを打ち込んで、Nook Colorへrootでログインします。なお、PC側を192.168.2.10と仮決めします。（Nook Color側はnooter由来のinitrdですと192.168.2.2に決め打ちでセットアップされます。）
\begin{commandline}
$ sudo /sbin/ifconfig usb0 inet 192.168.2.10 netmask 255.255.255.0 up
$ ssh root@192.168.2.2
# 
\end{commandline}
\item miniSDのDebianを動かし、vncserverを立ち上げます。
\begin{commandline}
# mount -t ext3 /dev/mmcblk0p2 /mnt
# mount -t devpts devpts /mnt/dev/pts
# mount -t proc proc /mnt/proc
# mount -t sysfs sysfs /mnt/sys
# chroot /mnt /bin/bash
root@bildroot:/# cd
root@buildroot:~# vncserver -geometry 800x600
Passwd: <適当にパスワード入れる>
Retry : <上と同じパスワード入れる>
...多少エラーメッセージが出てvncserverが立ち上がる気にしない...
root@buildroot:~#
\end{commandline}
\item PC側にてgvncviewerを起動すると、Nook Color上でDebianにログインした状態になる。
\begin{commandline}
$ vncviewer 192.168.2.2:1
\end{commandline}
%$
\item lxterminalをvncviewer上で開き、適当に/etc/resolv.confし、route add default gw 192.168.2.10等して、PC側をNAT設定にすると、Nook ColorはUSB越しでPC側の持つグローバル側ネットワークを利用できるようになります。aptitudeなどもも全く問題なく出来ます。
\end{enumerate}

\subsection{電源の切り方}

　いろいろ試したら、電源をOFFにしたくなるかと思います。この場合の手続きは以下の
通りです。

\begin{enumerate}
\item Nook Colorにsshログインします。
\item sync;sync;haltと打ち込みます。
\item Nook Colorとのsshが切れます。
\item Nook ColorからminiSDを抜きます。
\item Nook Colorの電源ボタンを15秒以上押します。
\end{enumerate}

以上で電源が切れます。この状態でminiSDを抜いた状態で電源ボタンを長押し(15秒)
すれば、元の電子書籍端末としてのNook Colorが立ち上がります。

\subsection{終わりに}

 今回手動でchrootすることにより、Nook ColorでDebianを動かしてみました。
これで電池動作で小型軽量ということもあり、Debianを入れたノートパソコンと
組み合わせると、ARM CPUのタブレット開発環境を持ち歩く事ができます。実際、
本記事を書くにあたり、平日は通勤電車の中を主に活用して試行錯誤していました。

 今回Nook Colorが持っているLCD/タッチパネル/Audio/Wi-Fiについて一切
Debian側から制御までは到達できませんでした。100％ Debianで動く安価で軽量な
タブレット端末の開発の道は険しそうです。

　次はOMAP3用のCPU向けにkernelのクロスコンパイルに挑戦してみようかと思う
この頃でした。

%-------------------------------------------------------------------------------
\dancersection{月刊Debhelper}{杉本 典充}
%-------------------------------------------------------------------------------
\index{debhelper}

\subsection{今月のコマンド：dh\_md5sums}
\index{dh\_md5sums}
dh\_md5sumsコマンドは「DEBIAN/md5sumsファイルを生成する」コマンドです。

\subsubsection{DEBIAN/md5sumsファイルについて}
「\$ ar x debian-package.deb」を実行し現れるcontrol.tar.xxファイルを展開
するとmd5sumsファイルが出てきます。このmd5sumsファイルはdata.tar.xxファイルに含むファイルそれぞれから取得したmd5sumを記述しています。

\begin{commandline}
$ apt-get download hello-debhelper
$ ar x hello-debhelper_2.7-3_i386.deb
$ ls
control.tar.gz  data.tar.gz  debian-binary  hello-debhelper_2.7-3_i386.deb
$ tar xf control.tar.gz
$ ls
control         data.tar.gz    hello-debhelper_2.7-3_i386.deb
control.tar.gz  debian-binary  md5sums
$ head -n 1 md5sums
098518cc321f0467dc0e7c67f65e2cc1  usr/bin/hello
\end{commandline}

\subsubsection{パッケージのビルド処理におけるdh\_md5sumsの実行}
dh\_md5sumsコマンドはインストールするファイルのmd5sumを取得する処理のため、ビルド処理の終盤で実行されます。

\begin{commandline}
$ apt-get source hello-debhelper
$ cd hello-debhelper-2.7
$ debuild -uc -us
  (省略)
  dh\_gencontrol -a
  dh\_md5sums -a
  dh\_builddeb -a
  (省略)
$ ls debian/hello-debhelper
DEBIAN   usr
$ head -n 1 debian/hello-debhelper/DEBIAN/md5sums
098518cc321f0467dc0e7c67f65e2cc1  usr/bin/hello
\end{commandline}
%$
\subsubsection{コマンドのオプション}
\begin{table}[ht]
\caption{dh\_md5sumsのコマンドラインオプション一覧}
\begin{center}
\small
\begin{tabular}{|p{12em}|p{33em}|}
\hline
オプション&説明 \\
\hline
-x,  --include-conffiles & DEBIAN/conffilesファイルに記述した設定ファイルのmd5も生成します。\\
\hline
-Xitem, --exclude=item & md5sumの生成を除外するファイル名を指定します。ただしディレクトリが別でもファイル名が一致すればどちらも除外されます。 \\
\end{tabular}
\end{center}
\end{table}

\newpage

\subsection{今月のコマンド：dh\_strip}
\index{dh\_strip}
dh\_stripコマンドは「実行ファイル、共有ライブラリ、スタティックライブラリをstripする」コマンドです。

\subsubsection{デバッグシンボルの扱い方を制御する}
オプションなしや環境変数を指定せずにdh\_stripコマンドを実行するとコンパイルしたオブジェクトファイルのデバッグシンボルをstripするのが通常の処理です。しかし、デバッグを目的とする場合はデバッグシンボルをstripしてしまうとデバッガが十分に機能しないため困ります。

dh\_stripコマンドではデバッグシンボルを以下のように扱うことができます。\cite{debugpackage}

\begin{itemize}
 \item オプションなしで実行すると、stripする。
 \item 環境変数DEB\_BUILD\_OPTIONS=nostripを指定して実行すると、stripしない。（処理的にはdh\_stripが即座に終了する）
 \item --dbg-packageオプションを指定すると、/usr/lib/debug配下にデバッグシンボルを分離して残すパッケージ（＝デバッグパッケージ）を作成する。
\end{itemize}

\subsubsection{デバッグパッケージを作成するための条件}
debhelperの機能を利用するとstrip済みのバイナリパッケージに加えて簡単にデバッグパッケージを作成できます。デバッグパッケージを追加で作成したい場合は以下の処理を記述してパッケージをビルドすればよいです。

\begin{itemize}
 \item CFLAGSなどのコンパイルオプションに''-g'を付与しビルド時にデバッグシンボルを生成するようにする。
 \item debian/rulesでoverride\_dh\_stripを定義し、dh\_strip --dbg-package=package-dbgを処理させる。
 \item debian/controlにパッケージ「package-dbg」の定義を記述する。このとき、パッケージ「package-dbg」はパッケージ「package」にバージョン指定をしてdependすること。
\end{itemize}

\subsubsection{コマンドのオプション}

\begin{table}[ht]
\caption{dh\_stripのコマンドラインオプション一覧}
\begin{center}
\small
\begin{tabular}{|p{12em}|p{33em}|}
\hline
オプション&説明 \\
\hline
-Xitem, --exclude=item & 指定した文字列を含むファイルをstrip処理の対象から除外する。複数のファイルを指定したい場合はオプションを複数回指定することも可能。\\
\hline
--dbg-package=package & デバッグシンボルを含むパッケージ「package-dbg」を作成する。 \\
\hline
-k, --keep-debug & パッケージをビルドした作業ディレクトリ内のusr/lib/debugにstrip後のデバッグシンボルファイルを残す。--dbg-packageオプションの指定で事足りる場合は多いが、より細かくデバッグシンボルを扱いたい場合を想定して用意されている。 \\
\end{tabular}
\end{center}
\end{table}

\begin{thebibliography}{0}
\bibitem{debugpackage} Debian Wiki - DebugPackage \url{http://wiki.debian.org/DebugPackage}\
\bibitem{bestpkgpractice} Debian.org 第6章パッケージ化のベストプラクティス \url{http://www.debian.org/doc/manuals/developers-reference/best-pkging-practices.html}
\end{thebibliography}


\printindex

\cleartooddpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule

\end{document}
