%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。


%     Tokyo Debian Meeting resources
%     Copyright (C) 2008 Junichi Uekawa
%     Copyright (C) 2008 Nobuhiro Iwamatsu

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image200804; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{monthlyreport}
\usepackage[dvips]{xy}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2008}
\newcommand{\debmtgmonth}{7}
\newcommand{\debmtgdate}{19}
\newcommand{\debmtgnumber}{42}

\begin{document}

\begin{titlepage}
\thispagestyle{empty}

% タイトルページ:編集必要な部分は最初のマクロに飛ばすこと

\vspace*{-2cm}
第\debmtgnumber{}回 東京エリア Debian 勉強会資料

\hspace*{-2.4cm}
\includegraphics[width=210mm]{image200801/2008title.eps}\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日

\end{titlepage}

\dancersection{Introduction}{上川 純一}
 
 今月のDebian勉強会へようこそ。これからDebianの世界にあしを踏み入れると
 いう方も、すでにどっぷりとつかっているという方も、月に一回Debianについ
 て語りませんか？

 Debian勉強会の目的は下記です。

\begin{itemize}
 \item \underline{Debian Developer} (開発者)の育成。
 \item 日本語での「\underline{開発に関する情報}」を整理してまとめ、アップデートする。
 \item \underline{場}の提供。
 \begin{itemize}
  \item 普段ばらばらな場所にいる人々が face-to-face で出会える場を提供
	する。
  \item Debian のためになることを語る場を提供する。
  \item Debianについて語る場を提供する。
 \end{itemize}
\end{itemize}		

 Debianの勉強会ということで究極的には参加者全員がDebian Packageをがりがり
 と作るスーパーハッカーになった姿を妄想しています。情報の共有・活用を通し
 て Debianの今後の能動的な展開への土台として、「場」としての空間を提供す
 るのが目的です。

以上を目的とした、2008 年アジェンダです：
\begin{enumerate}
 \item 新年会「気合を入れる」
 \item Open Source Conference Tokyo (3/1)
 \item データだけのパッケージを作成してみる、
       ライセンスの考え方 (David Smith)
 \item バイナリ一つのパッケージを作成してみる (吉田@板橋)\\
       バージョン管理ツールを使いDebianパッケージを管理する(git)\\
       アップストリームの扱い(svn/git/cvs)(岩松 信洋さん)
 \item バイナリの分けたパッケージの作成。(前田さん)\\
       バイナリの分け方の考え方、アップグレードなどの運用とか。
 \item パッケージ作成(dpatch/debhelperで作成するパッケージ)(小林儀匡さん)\\
       man の書き方(roff or docbook)(でんさん)
       OSC 2008 Hokkaido
 \item パッケージ作成(kernel patch、kernel module)(岩松 信洋)
       Debconf発表練習（上川さん）

 \item Debconf アルゼンチン、共有ライブラリパッケージ作成
       コミックマーケット74

 \item Open Source Conference Tokyo/Fall、
       デーモン系のパッケージの作成、latex、 emacs-lisp、フォントパッケージ
 \item パッケージの cross-compile の方法、amd64 上で i386 のパッケージと
       か、OSC-Fall報告会、Debconf報告会
 \item 国際化 po-debconf / po化 / DDTP
 \item 忘年会
\end{enumerate}


\newpage

\begin{minipage}[b]{0.2\hsize}
 \definecolor{titleback}{gray}{0.9}
 \colorbox{titleback}{\rotatebox{90}{\fontsize{80}{80} {\gt デビアン勉強会} }}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\tableofcontents
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{事前課題}{岩松 信洋}

今回の事前課題は以下です。

\begin{enumerate}
 \item ...

\end{enumerate}

この課題に対して提出いただいた内容は以下です。


%%% trivia quiz
\dancersection{Debian Trivia Quiz}{岩松 信洋}

ところで、みなさん Debian 関連の話題においついていますか？Debian関連の話
題はメーリングリストをよんでいると追跡できます。ただよんでいるだけではは
りあいがないので、理解度のテストをします。特に一人だけでは意味がわからな
いところもあるかも知れません。みんなで一緒に読んでみましょう。

今回の出題範囲は\url{debian-devel-announce@lists.deban.org} に投稿された
内容からです。
\begin{multicols}{2}
 
 \santaku
 {}
 {}
 {}
 {}
 {}

\end{multicols}

\dancersection{最近のDebian関連のミーティング報告}{上川 純一}
\subsection{東京エリアDebian勉強会41回目報告}

% (query-replace-regexp "<.*?>" "")
% (query-replace-regexp "^[	 ]\+" "")


\subsection{eeePC Developers Conference day 1}

経済部工業局。
登録したら無料で参加できるカンファレンス。
講演者が全員スーツをきていますが、来場している方々は普段着です。
カメラのフラッシュの量からは注目度が伺えます。
携帯電話の着信音がなりほうだいです。

開始のオープニングは多少おくれましたがほぼ満員で開始しました。
後半になると半分くらいの埋まり方になりました。

みなさまeeePCでプレゼンしていますが、
プロジェクターが同期とれていない感じで、全体がうつっていません。

外は暑く、会場が寒いのだけど、みんななれているものでジャンパー着てます。

5月8日に1日目が開催されました。

\begin{tabular}{|c|p{18em}|c|}
09：00 ~ 09：30 & 	 Register & \\
09：30 ~ 09：45 &	Opening Remarks & \\
09：45 ~ 10：20 &	Keynote Speech Keynote Speech -- EeePC Software Platform Business Model &	ASUS | Ellis Wang\\
10：20 ~ 10：50 &	EeePC Application Demo Show &	ASUS  Patrick Chou\\
10：50 ~ 11：00 &	Tea Break &\\
11：00 ~ 12：20 &	EeePC SDK Announcement and Demo &	ASUS\\
12：20 ~ 13：40 &	Lunch &\\
13：40 ~ 14：30 &	The rule of game to stand on the shoulders of giant 	&Florence T.M. Ko, OSSF\\
14：30 ~ 15：10 &	Developing with pyGTK in EeePC 	&TsungWei Hu, OSSF\\
15：10 ~ 15：30 &	Tea Break &\\
15：30 ~ 16：10 &	Developing with pyQT in EeePC 	&Gary Lee\\
16：10 ~ 16：50 &	Firefox Platform Application Programming 	&Thinker\\
16：50 ~ 17：30 &	Google Gears Programming 	&Tzeng Chien-Ming\\
17：30 ~ 17：40 &	Software Vendor Panel Discussion 	&ASUS\\
\end{tabular}


\subsubsection{開会のご挨拶}

eeePC SDK の発表

Open Source Development

\subsubsection{開会のご挨拶2}

何かの話、まったくわからず。

\subsubsection{Announcement of eeePC SDK, Dev tools and Community}

ASUSのEllis Wang氏が発表しました。
eeePCでプレゼンしています。
オープンソースのデベロッパーの人たちにできるだけ参加してほしいという気持
ちが伝わってきます。
英語のプレゼンで、中国語で発表しています。

最初に開会の挨拶をしたえらいひとになぜかeeePCを贈呈しています。

Linux で、コミュニティーについてなんたら。

ISVとコミュニティー

SDKの話。

ASUSとeeePCのソースコードが
ツールダウンロードできるよね。

オープンソースコミュニティーがeeePCを支援している。

Linux にかぎらず、Debian, KDE などがある。

MicrosoftのUIに比べて、UIの変更が簡単と言っているような気がする。

Linux の素晴らしさについて。
EeePC:

\begin{itemize}
 \item easy -- to learn, work and play
 \item excellent -- on the go
 \item excellent -- internet experience
\end{itemize}

インテグレーションすることの大切さ。
contribution を行う。

汎用のツールのソースを組み合わせて作り上げる。

オープンソースは共有することが大切であり。
IPの話。
[share]

warranty の話?

reuseの話。


EeePC SDKとは?

マニュアルの目次を画面にうつす。
EeePCのパッケージはDebianパッケージだよ。

パッケージのテストは?VMwareをつかおう。

eeePCは開発者・ASUS・ユーザ・CCデジタルコンテントをつなぐためのブリッジだ。

無線とかCPUとかカーネルとかはASUSがやるだろ?

GPLだろ、とか。

Debianのパッケージとかを提供する。

バーチカルでNo1を目指す。
テレコムと教育目的に。

partner のレベルがある。

システムとOSのパートナーは一番少ないがインテグレーションの度合いが高い。

SDK作ったのでオープンソースデベロッパーたちにデベロップメントコミュニティー
をつくることができるだろ?
コマーシャルベンダーもツールが充実していて満足するにちがいない。
オープンソースの技術者もよく知っている技術でうれしいに違いない。

Eclipse と Qt4 の開発ツールキットがはいっているぜ。

開発プロセスの
Phaseは二種類ある。
実機とVMwareだ。
フェーズイーとフェーズアル。


テストの小技。
画面サイズとか全部試しておくのがよいです。

デスクトップと比べると一部違います。
ASUS desktopで、ユーザアカウントが一つしかないよ。
また、initはミニマルです。

howto 

画面小さい。
Flashは10万回書き込むと wear out するのでできるだけ書き込みしない。

eeePCアプリケーションの移植は簡単よ。
Javaも動く。PicasaはWineで動いている。
(Linuxの説明をしている気がする。)

Adobe flash はサポートするけどAIRはダメだね(?)。


と、終わったら人が騒然としはじめた。
休憩時間開始。スナックとコーヒーが提供されました。

\subsubsection{教育用のアプリケーション?}

株式取引ツール

発音の出る辞書

カラオケみたいな、音楽が流れながら歌詞と訳語の出るツール。

ASUS MeBook

MeReader MeSong


本を買うことができる。

ラップ風の中国語会話。IQChinese。
PinYinの勉強させてくれる。


音声制御のツール。Skypeを声で起動できる?

一ページめくると音声で指示を出してプレゼンを制御している。

\subsection{Introduction to eeePC SDK}

Chih Wei Huang

赤ちゃんでもつかえるくらいシンプルだよ、
と赤ちゃんの写真を見せてice-break。

eeePC900 は2008年4月、8.9'' シリーズとして登場。

eeePCはDebianベースです。
オープンソースですよ。

Xandros open circulation edition というのをつかってます。
開発環境はEclipse です。

Qt4は今はNokiaのTrolltechが開発。


標準の.debパッケージを使っている。
SDKとして、debian policy manual, new maintainer guideとかが紹介。
エキスパートがたくさんいるよ、と。

デスクトップにアイコンを追加する方法は簡単だよ。
XMLファイルを作成すればよい。

\url{http://sourceforge.net/projects/eeecommunity/}
にVMware のイメージはあるから見てね。
ISOをvmware-convert コマンドで変換したら利用できるよ。
eeePC 701 のイメージなどがある。

i18n/l10nは、Qt と gettext があるよ。
Qt は tr().
lupdateとか使う。
gettextは \verb!_()!で。


EclipseのQt用の開発ツールがあるよ。
Qt Designer が Eclipse内部で動作します。


\subsubsection{The rule of game to stand on the shoulders of giant}

GPLの呪縛を回避する方法について。

FOSSの裁判案件の紹介。

Busybox 裁判など。

Creative Commons のすすめとか。

質問は、GPL の継承を避免する方法について。
dynamic linker と static link の話をしていたような気がする。

\subsubsection{Developing with pyGTK in EeePC}

??
Open Source Software Foundry Introduction かも?

自由とは。

OSSFの話

Pythonを使うことについて。
python の文法について。インデント重要とか

Gtk とか。

\subsubsection{Developing with pyQT in EeePC}

PyQtの使用方法についての紹介。

\subsubsection{Firefox Platform Application Programming}

ハッカー然とした「thinker」による firefox プラットフォームアプリケーションプログラミング
の紹介。

「OK」としか表示しない mozilla アプリケーションの例の紹介。XUL。

時間オーバーだということで途中できりあげられてしまいました。

\subsubsection{Google Gears Programming}

Google Gears を利用して開発する方法について紹介しています。

\subsection{eeePC Developers Conference day 2}

5月9日に2日目が開催されました。

当初の発表されていた予定から大幅に変更されて実施されました。

\begin{tabular}{|c|p{18em}|c|}
09：00 ~ 09：30 &	Register & \\
09：30 ~ 10：00 &	Eclipse,Gambas,Lazarus Development Environment Introduction& 	ASUS \& III Free Software Team\\
10：00 ~ 10：50 &	Adobe Air Platform Programming 	&Anistar Sung\\
10：50 ~ 11：00 &	Tea Break& \\
11：00 ~ 12：00 &	Eee PC Hacker Show 	&ASUS SAM\\
12：00 ~ 13：30 &	Lunch & \\
13：30 ~ 14：00 &	EeePC HotKey、WebCAM、Audio Control 	&ASUS \& III Free Software Team\\
14：00 ~ 14：15 &	Introduction of Open Source Development Resource and Discussion Forum &	III Free Software Team\\
14：15 ~ 14：30 &	Open Source Software Foundry Introduction 	&Tim Wu, OSSF\\
14：30 ~ 15：30 &	Debian Project and the Development Process, and how to co-work with it 	&Junichi Uekawa\\
15：30 ~ 15：40 &	Q \& A 	& \\
15：40 ~ 16：00 &	Tea Break & \\
16：00 ~ 17：00 &	Linux Driver Project 	&Brandon D. Philips\\
17：00 ~ 17：10 &	Q \& A 	& \\
\end{tabular}


\subsubsection{GTK?}

10時ころについたら何か違う人が話をしていた。




\subsubsection{Eclipse,Gambas,Lazarus Development Environment
   Introduction}

「IDEAS III」

MonoDevelop

Lazarus は PASCALのツール

なんか途中かなと思っていたら話が終わっていた。

\subsubsection{LXDEの紹介}

pcman による LXDEの紹介?


起動がすごく高速、リソースも全然
使わないというデモ。
ファイルマネージャをクリックしまくって起動してもスムーズだぜ!

計算機とかも便利!

タスクバーとか、パネルとか。

\subsubsection{Deb?}

\subsubsection{Array 30入力メソッド}

新しい input method を作った。
アレーベースの方法。

GCIN OXIMという古いもの、SCIMに。
現在SCIMは日本語とコリアンの入力に必須。

で、頑張っていろいろと入力してみる。

\subsubsection{EeePC HotKey}

ホットキーのプログラムの書き方について紹介。
GDKでhkのコールバックがあります、という紹介。

\subsubsection{eeePC audio, webcam}

オーディオはALSAです、Wikiを見てください。

webcam の制御は、unicapGTKでやります。
ucilはビデオに文字とかを載せるためのAPIです。

unicapGTKの開発の話。

\subsubsection{Open Source Software Foundry Introduction}

フリーソフトウェアを支援する環境の紹介。

フリーソフトウェアを工業的統合を経たら製品になる素材と位置づけて推進して
いく。

\subsubsection{Adobe Air Platform Programming}

AIRプラットフォームの紹介。RIAのためのAIR。


\dancersection{Linux kernel patch の Debian パッケージ作成}{岩松 信洋}
\label{sec:kpatch}
\index{XX@YY}

\subsection{はじめに}
最近は akpm や Greg K-H のおかげで Linux カーネルへの新しい機能やパッチが　Linusツリーに取り込まれやすくなりましたが、
主要な Linux 開発者などから期待されていない機能や好ましくないや、開発者自身がまだ取り込むべきではないといった機能がパッチとして、
公開されている場合があります。
これらの Linux カーネルへのパッチを Debian で利用する場合には、Linux カーネルパッチも Debian パッケージとして提供することができ、
既にいくつかのパッケージが利用可能になっています。また、この Linux カーネルパッチパッケージを作成するためのサポートパッケージ dh-kpatches
があり、このパッケージを利用することより、容易にパッケージの作成、カーネルへのパッケージ適用が可能になっています。
今回は Evgeniy Polyakov（えぶじぇにー ぽるやこふ）が作成している
新しい Network Filesystem POHMELFS\footnote{\url{http://tservice.net.ru/~s0mbre/old/?section=projects&item=pohmelfs}}
を題材にして、Linux カーネル向けパッチのパッケージ作成方法とテスト方法について説明します。

\subsection{パッケージ作成前の準備}

\subsubsection{dh-kpatches パッケージのインストール}
Linux カーネルパッチパッケージを作成するには、dh-kpatches パッケージが必要です。また、パッケージの雛形を作成するために
dh-make をインストールしておくと良いでしょう。これらのパッケージは apt や aptitude などを使ってインストールします。
\begin{commandline}
$ sudo apt-get update
$ sudo apt-get install dh-kpatches dh-make build-essential
\end{commandline}

\subsubsection{パッチの用意}
まず、カーネル向けのパッチを作成する必要があります。開発者によっては、既にパッチがカーネルバージョン毎に用意されている事もありますが、
最近では、Linus のツリーに容易に追従できるように、Gitを使ってソースコードが管理されている場合が多いです。
POHMELFS でも ソースコードは Git で管理されており、安定版のカーネル（この原稿を書いている時点では、Linux 2.6.25）に常に追従されています。
この差分を取得するには、Git リポジトリを取得し、git diff コマンド等で取り出せばよいでしょう。

\begin{commandline}
$ git clone http://tservice.net.ru/~s0mbre/archive/pohmelfs/pohmelfs.git
Initialized empty Git repository in /tmp/pohmelfs/.git/
got 37e1b82c0535386cf09b3821dff5e8cb5f9e26b4
walk 37e1b82c0535386cf09b3821dff5e8cb5f9e26b4
<snip>
$ cd pohmelfs
$ git tag
<snip>
v2.6.24-rc8
v2.6.25
v2.6.25-rc1
v2.6.25-rc2
<snip>
$ git diff v2.6.25 > ~/pohmelfs.diff
\end{commandline}

\subsubsection{ディレクトリの作成}

パッチが作成できたら、パッケージ作成用のディレクトリを作成し、その中にパッチファイルをコピーします。
ディレクトリ名は Debianのルールに合わせたもの(ソフトウェアまたは機能名-バージョン)にしておき、パッチファイル名は
パッチ機能名-カーネルバージョン にしておきます。これは、dh-kpatches が要求するパッチファイル名のためです。

\begin{commandline}
$ mkdir linux-patch-pohmelfs-20080707
$ cd linux-patch-pohmelfs-20080707
$ cp ../pohmelfs.diff pohmelfs-2.6.x
\end{commandline}

\subsection{dh\_make を使った雛形の作成}
パッケージ作成の準備ができたら、 dh\_make コマンドを使って雛形を作成します。
dh-make コマンドにはカーネルパッチ用のサポートはないので、singleバイナリの雛形を作成する
オプションを指定して、作成します。
\begin{commandline}
$ dh_make -r -s
Maintainer name : Nobuhiro Iwamatsu
Email-Address   : iwamatsu@nigauri.org 
Date            : Mon, 07 Jul 2008 01:00:33 +0900
Package Name    : linux-patch-pohmelfs
Version         : 20080707
License         : blank
Using dpatch    : no
Type of Package : Single
Hit <enter> to confirm: 
Currently there is no top level Makefile. This may require additional tuning.
Done. Please edit the files in the debian/ subdirectory now. You should also
check that the linux-patch-pohmelfs Makefiles install into $DESTDIR and not in / . 
\end{commandline}

\subsection{debianディレクトリ内の変更}
Debian パッケージにするための雛形が作成できたので、これを元に内容を変更していきます。

\subsubsection{サンプルスクリプト等の削除}
dh\_make で作成されるサンプルスクリプトは必要ないので全て削除します。
また、 dirs ファイルや doc ファイルも必要ないため削除します。
\begin{commandline}
$ rm -rf ./debian/*.ex ./debian/*.EX ./debian/doc ./debian/dirs
\end{commandline}

\subsubsection{debian/copyright の修正}
パッチの情報に合わせて、debiab/copyright の修正を行います。
pohmelfs の場合は以下のように修正します。

\begin{commandline}
This package was debianized by Nobuhiro Iwamatsu <iwamatsu@nigauri.org> on
Mon, 07 Jul 2008 01:00:33 +0900.

It was downloaded from
        http://tservice.net.ru/~s0mbre/archive/pohmelfs/pohmelfs.git
This is Git repository. I made the difference of the latest committing a
patch from v2.6.25 tag.

Upstream Author(s):

    Evgeniy Polyakov <johnpol@2ka.mipt.ru>

Copyright:

    Copyright (C) 2008 Evgeniy Polyakov <johnpol@2ka.mipt.ru>

License:

 This program is free software; you may redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation; either version 2, or (at your option)
 any later version.

 This is distributed in the hope that it will be useful, but without
 any warranty; without even the implied warranty of merchantability or
 fitness for a particular purpose. See the GNU General Public License
 for more details.

 A copy of the GNU General Public License is available as
 /usr/share/common-licenses/GPL in the Debian GNU/Linux distribution or on the
 World Wide Web at http://www.gnu.org/copyleft/gpl.html.  You can also
 obtain it by writing to the Free Software Foundation, Inc., 51 Franklin St,
 Fifth Floor, Boston, MA 02110-1301, USA.

The Debian packaging is (C) 2008, Nobuhiro Iwamatsu <iwamatsu@nigauri.org> and
is licensed under the GPL, see `/usr/share/common-licenses/GPL'.

# Please also look if there are files or directories which have a
# different copyright/license attached and list them here.

\end{commandline}

\subsubsection{debian/README.Debian の修正}
debain/README.Debian ファイルに Debian で使うための HowToなどを書いておきましょう。
サポートしているカーネルバージョンや、カーネルイメージの作成方法などを書いておくのが一般的
なようです。

\begin{commandline}
linux-patch-pohmelfs for Debian
-------------------------------

This patch is pohmelfs support patch for Debian Linux kernel. 
You can try with linux-source-2.6.25 package. 

- How to use
  $ sudo apt-get install linux-source-2.6.25 libncurses-dev kernel-package
  $ cd /usr/src ; tar -xjf linux-source-2.6.25.tar.bz2 ; cd linux-source-2.6.25
  $ make-kpkg clean
  $ cp /boot/config-2.6.25-2-686 .config
  $ make menuconfig
  $ make-kpkg --rootcmd fakeroot --append-to-version -pohmelfs --revision 0.1 -added_patches=pohmelfs kernel-image

 -- Nobuhiro Iwamatsu <iwamatsu@nigauri.org>  Mon, 07 Jul 2008 01:00:33 +0900

\end{commandline}

\subsubsection{debian/control の修正}
次に debian/control ファイルを修正します。
注目すべきところは、作成されるパッケージで指定してある、{\bf Depends: \$\{kpatch:Depends\}}です。
ここで kpatch:Depends を指定することによって、カーネルパッチパッケージを使った
カーネル作成に必要な依存パッケージを置き換えてくれます。
また、ソースパッケージの {\bf　Build-Depends}　に {\bf dh-kpatches　パッケージ} を追加する事を忘れないようにしましょう。

\begin{commandline}
Source: linux-patch-pohmelfs
Section: devel
Priority: extra
Maintainer: Nobuhiro Iwamatsu <iwamatsu@nigauri.org>
Build-Depends: debhelper (>= 6), dh-kpatches
Standards-Version: 3.8.0.1
Homepage: http://tservice.net.ru/~s0mbre/old/?section=projects&item=pohmelfs

Package: linux-patch-pohmelfs
Architecture: all
Depends: ${kpatch:Depends}
Description: POHMELFS kernel patch
 POHMELFS stands for Parallel Optimized Host Message Exchange Layered File System.
 Development status can be tracked in filesystem section.
 This is a high performance network filesystem with local coherent cache of data
 and metadata.
 Its main goal is distributed parallel processing of data. Network filesystem is a
 client transport.
 POHMELFS protocol was proven to be superior to NFS in lots (if not all, then it
 is in a roadmap) operations.
\end{commandline}

\subsubsection{debian/changelog の修正}
dch コマンドを使って debian/changelog ファイルを修正します。
\begin{commandline}
$ dch
linux-patch-pohmelfs (20080707-1) unstable; urgency=low

  * Initial release                                          

 -- Nobuhiro Iwamatsu <iwamatsu@nigauri.org>  Mon, 07 Jul 2008 01:25:37 +090
\end{commandline}

\subsubsection{kpatches ファイル}

どのパッケージ内に収録されていうパッチをどのカーネルバージョンに当てればいいのか、
コントロールするためのファイル kpatches を用意する必要があります。
このファイルは以下のようなフォーマットになっており、
カーネルバージョン毎に Patch-file と Kernel-version の項目を追加する必要があります。
パッチをカーネルに当てる際にこのファイルが参照され、チェックが行われます。

\begin{commandline}
Patch-name: POHMELFS patch
Patch-id: pohmelfs
Architecture: all
Path-strip-level: 1

Patch-file: pohmelfs-2.6.x <-- パッチファイル名
Kernel-version: 2.6.25 <-- パッチがサポートするカーネルバージョン
\end{commandline}


\subsubsection{debian/rules ファイルの修正}
debian/rules ファイルで注意する点として、 install ターゲットで、
dh\_installkpatches を指定する必要があります。dh\_installkpatches で
カーネルパッチが kpatches ファイルと共ににパッケージ作成用の一時ディレクトリにコピーされます。

\begin{commandline}
#!/usr/bin/make -f

build: build-stamp
build-stamp:
        dh_testdir
        touch build-stamp

clean:
        dh_testdir
        dh_testroot
        rm -f build-stamp
        dh_clean

install: build
        dh_testdir
        dh_testroot
        dh_clean -k
        dh_installdirs
        dh_installkpatches

# Build architecture-independent files here.
binary-indep: build install
        dh_testdir
        dh_testroot
        dh_installchangelogs
        dh_link
        dh_strip
        dh_compress
        dh_fixperms
        dh_installdeb
        dh_shlibdeps
        dh_gencontrol
        dh_md5sums
        dh_builddeb

# Build architecture-dependent files here.
binary-arch: binary-indep

# We have nothing to do by default.

binary: binary-indep binary-arch
\end{commandline}

\subsection{パッケージのビルド}
パッケージのビルドを行う際には、通常のパッケージ作成と変わりません。
debuild などを使ってパッケージの作成を行ってください。
\begin{commandline}
% debuild
\end{commandline}

\subsection{パッケージのテスト}
カーネルパッチパッケージのテストは、カーネルソースコードに
パッチを当て、カーネルがコンパイルできるか、確認する必要があります。
また、Debian の場合は、Debian と kernel.org で配布しているカーネルの2種類を考慮する必要がありますが、
前者の方をテストしていれば十分でしょう。
インストールしたカーネルパッチパッケージを使って、カーネルをコンパイルするには、
make-kpkg コマンドの--added\_patches のオプションを使って、パッチを指定します。
パッチが当たっているかソースを確認し、カーネルのコンパイルが正常に行われているか確認しましょう。
また、作成された カーネルパッケージを実際にインストールし、テストを行うことも重要です。

\begin{commandline}
$ sudo apt-get install linux-source-2.6.25 libncurses-dev kernel-package
$ cd /usr/src ; tar -xjf linux-source-2.6.25.tar.bz2 ; cd linux-source-2.6.25
$ make-kpkg clean
$ cp /boot/config-2.6.25-2-686 .config
$ make menuconfig
$ make-kpkg --rootcmd fakeroot --append-to-version -pohmelfs --revision 0.1 -added_patches=pohmelfs kernel-image
\end{commandline}

\subsection{まとめ}
以上の手順を使うと、Linux カーネルパッチの Debianパッケージを作成することができます。
しかし、このままではかなり手間がかかりますので、dh-make で Linux カーネルパッチパッケージの
雛形が作成できるように機能を追加し、パッチを投げました(\#304688)。この機能を使うことにより、
ファイルにサポートする Linux カーネルバージョンを追加するだけでパッケージが作成できるようになっています。

\dancersection{Linux kernel module の Debian パッケージ作成}{岩松 信洋}
\label{sec:kmod}
\index{XX@YY}

\clearpage


%===========================================================%
\begin{getsureiupdate}{月例 Nexenta Operation System}{上川 純一}
\index{Nexenta}
先月につづいてNexentaをいじって見たのでお伝えします。

実用的なアプリケーションをビルドするまでに前回は至りませんでした。
そこで、今回はdlsym を使って自由自在にライブラリをロードできるようにしてみるところから
 まずやってみましょう。

dlsymでロードできる最低限の共有ライブラリを作成するところから始めてみま
しょう。


まず、関数一つだけを定義したCのファイルから最低限の共有ライブラリを作成
 してみ、それを実行するだけのプログラムと、dlopen経由で利用するプログラ
 ムを作成してみました。

\begin{commandline}
// a.c : サンプルの共有ライブラリのコード
#include <stdio.h>

void func1 (int i)
{
  printf(" hello world %i\n", i);
}
\end{commandline}

\begin{commandline}
// use.c: 通常の共有ライブラリ利用
#include <stdio.h>

void func1 (int i);

main()
{
  func1(1);
}
\end{commandline}

\begin{commandline}
// dlopen.c: dlopenでのバイナリ利用
#include <dlfcn.h>
static int (*myfunc1)(int i) = NULL;
int main()
{
  void* h=dlopen("./liba.so", RTLD_NOW);
  
  myfunc1=dlsym(h, "func1");
  
  myfunc1(10);
  
  return 0;
}
\end{commandline}

これらをコンパイル、リンクしてみて、動作を確認してみました。
どうやらLinuxとあまりかわらないようです。

\begin{commandline}
 + gcc -shared a.c -o liba.so
 + gcc use.c ./liba.so -o use
 + ./use
 hello world 1
 + gcc dlopen.c -o dlopen
 + ./dlopen
 hello world 10
\end{commandline}

ただし、これだけだとバージョンシンボルを利用した場合にdlsym ではどのバー
 ジョンを利用するのかが指定できないような雰囲気がただよっています。
というところまで確認したところで今月も力尽きました。
また来月続きをながめてみましょう。
もしかするとバージョンシンボルの作成とその利用をするかもしれません。

\end{getsureiupdate}
%===========================================================%


%\printindex

\cleartooddpage

\vspace*{15cm}
\hrule
\vspace{2mm}
\includegraphics[width=2cm]{image200502/openlogo-nd.eps}
\noindent \Large \bf Debian 勉強会資料\\ \\
\noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
\noindent \normalfont 東京エリア Debian 勉強会 （編集・印刷・発行）\\
\hrule


\end{document}
