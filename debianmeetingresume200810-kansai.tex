%; whizzy chapter
% -initex iniptex -latex platex -format platex -bibtex jbibtex -fmt fmt
% 以上 whizzytex を使用する場合の設定。

%     Kansai Debian Meeting resources
%     Copyright (C) 2007 Takaya Yamashita
%     Thank you for Tokyo Debian Meeting resources

%     This program is free software; you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation; either version 2 of the License, or
%     (at your option) any later version.

%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with this program; if not, write to the Free Software
%     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
%(shell-command "cd image200708; ebb *.png")

%%ここからヘッダ開始。

\documentclass[mingoth,a4paper]{jsarticle}
\usepackage{kansaimonthlyreport}
\usepackage{ascmac}

% 日付を定義する、毎月変わります。
\newcommand{\debmtgyear}{2008}
\newcommand{\debmtgdate}{19}
\newcommand{\debmtgmonth}{10}
\newcommand{\debmtgnumber}{18}

\begin{document}

\begin{titlepage}

% 毎月変更する部分, 本文の末尾も修正することをわすれずに

 第\debmtgnumber{}回 関西 Debian 勉強会資料

\vspace{2cm}

\begin{center}
\includegraphics{image200802/kansaidebianlogo.png}
\end{center}

\begin{flushright}
\hfill{}関西 Debian 勉強会担当者 山下 尊也\\
\hfill{}\debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日
\end{flushright}

\thispagestyle{empty}
\end{titlepage}

\dancersection{Introduction}{山下 尊也}
 
 関西 Debian 勉強会はDebian GNU/Linux のさまざ
 まなトピック(新しいパッケージ、Debian 特有の機能の仕組、Debian 界隈で起
 こった出来事、などなど）について話し合う会です。

 目的として次の三つを考えています。
 \begin{itemize}
  \item MLや掲示板ではなく、直接顔を合わせる事での情報交換の促進
  \item 定期的に集まれる場所
  \item 資料の作成
 \end{itemize}

 それでは、楽しい一時をお楽しみ下さい。

\newpage

\begin{minipage}[b]{0.2\hsize}
 {\rotatebox{90}{\fontsize{80}{80}
{\gt 関西デビアン勉強会}}}
\end{minipage}
\begin{minipage}[b]{0.8\hsize}
\hrule
\vspace{2mm}
\hrule
\setcounter{tocdepth}{1}
\tableofcontents
\vspace{2mm}
\hrule
\end{minipage}

\dancersection{最近のDebian関係のイベント報告}{山下 尊也}

\subsection{第17回 関西 Debian 勉強会}

\subsubsection{発表内容}

\begin{itemize}
 \item pbuilder でパッケージをビルドしてみる
 \item HotPlug の現状
 \item SSL のサーバー証明書が失効する時
\end{itemize}

%% sasaki
\dancersection{はじめての CDBS}{佐々木 洋平}



%% araki
\dancersection{cdn.debian.or.jp, cdn.debian.netにおける取り組み}{荒木 靖宏}

いつでも必要なソフトウェアやコンテンツを安価に入手する手段としてCDNが広
くつかわれている． Debianはdebの安定入手手段の有無がシステム の信頼性を
左右するシステムであり、その特殊性を考慮したCDNシステムが必要となる． 今
回はcdn.debian.or.jp, cdn.debian.netにおける取り組みを紹介する．

\subsection{CDNとは}

Content Delivery Network（CDN）はウェブコンテンツ配置および配送方法とし
てAkamai社によりサービスされ広く知られることになった。当初から一部の人気
の高いサーバへのトラフィック集中によるサーバ停止の回避、海外のリッチコン
テンツ取得の高速化、トラフィック分散によるネットワークおよびサーバの利用
平準化などの理由で広く受け入れられた。

CDNという用語自体はWWWに限ることなく、一般にコンテンツを取得するための配
送手段や方法全体を指す場合がある。たとえば、WinnyやBittorrentなどのコン
テンツを取得するために特別に設計されたプロトコルを用いて、P2Pネットワー
クを構成するような手法も含まれる。

\subsection{DebianにおけるCDNの現状}

\subsubsection{利用法とユーザから見た動作}

cdn.debian.or.jpではDebianでインストール時から広くdebファイルの入手に使
われるaptで使えるCDNとして設計し、運用している。そのため、Debianにおける
CDNの利用法は至極簡単である。/etc/apt/source.listに記述するAPTリポジトリ
として、

\begin{commandline}
deb http://cdn.debian.or.jp/debian/ stable main contrib non-free
deb-src http://cdn.debian.or.jp/debian/ stable main contrib non-free
\end{commandline}

以上のように指定するだけでユーザは今までとなんら変わることなくaptコマンドを使用できる。
現在，cdn.debian.or.jp, ftp.jp.debian.org, cdn.debian.netの名で運用している．

サービス時の手順と構成は以下のようになる．

\begin{itemize}
 \item ユーザがapt-getコマンドを行うとcdn.debian.or.jpをDNSで問い合わせ
       る
 \item cdn.debian.or.jpを管理するDNSはサーバ候補(surrogate)選択する
 \item 選択結果をDNSのリプライとして返す
 \item aptはcdn.debian.or.jpとしてSurrogate Cを使用する。
\end{itemize}

日本国内向けの設定ファイルは以下のような単純なものである．

\begin{commandline}
$ more JPN_deb_cdn_araki_net.rb 

$tracefile = 'hanzubon.jp' # hanzubon 2007apr5
$first_surrogate = '61.115.118.67'

$surrogates = {
  '203.178.137.175' => '9000', # naist
  '61.115.118.67' => '1000', # hanzubon 2007apr5
  '210.157.158.38' => '9900', # plat
  '202.229.186.27' => '50', # topstudio
  '133.5.166.3' => '10', # dennou-q.gfd-dennou.org
  '130.54.59.159' => '10', # dennou-k.gfd-dennou.org
  '133.87.45.30' => '10', # dennou-h.gfd-dennou.org
  '61.206.119.174' => '20', # oyu-net.jp
  '218.219.152.77' => '20', # mirrors.nemui.org
##  '219.111.15.135' => '1000', # tagoh
#  '15.12.218.222' => '9900', # fail data for test
#  '210.157.158.59' => '9900' ## fail data for test
}
\end{commandline}

\subsubsection{IPアドレスの位置情報を使用したサーバ選択}

当初はcdn.debian.or.jpとして運用していたものの，その後にglobalに分散する
Debianミラーに対応させた．

globalにCDNを展開する場合には地理的に近いサーバ群からある程度絞込むのが
有効である。現在、GeoIPなど無料でIPと地理情報のマッピング提供者が現れて
おり、debianパッケージになっていることもあり，本システムでも使用している．

サーバ側に関しては，Debianミラーサーバを大陸毎，あるいは国別に設定してい
る．

\begin{commandline}
yaar@loon3:~/playground/cdn$ ls continent/
AF_deb_cdn_araki_net.rb EU_deb_cdn_araki_net.rb OC_deb_cdn_araki_net.rb
AS_deb_cdn_araki_net.rb NA_deb_cdn_araki_net.rb SA_deb_cdn_araki_net.rb
yaar@loon3:~/playground/cdn$ ls country/
FRA_deb_cdn_araki_net.rb JPN_jp_cdn_araki_net.rb
JPN_deb_cdn_araki_net.rb KOR_deb_cdn_araki_net.rb
\end{commandline}

\subsection{cdn.debian.or.jpのシステムと動作}

CDNシステムが完全に動作しユーザから使用されるためには、システムが完全な
ファイルを提供すること、システムが安定して動作すること、そしてCDNを使っ
た場合に高速に動作していることが求められる。

\subsubsection{提供ファイルの完全性}

このために以下二点を満たさねばならない。

\begin{itemize}
 \item 個々のファイルがコンテンツ提供者たるdebファイル配布元と同一である
       こと
 \item apt-get updateの結果取得するファイル群がどのSurrogateでも入手でき
       ること
\end{itemize}

前者については、debはそのファイルのmd5値、sha1値とともに配布され、ユーザ
が使用するaptで確認後に利用されるためCDNを使用した場合でも問題にならない。

後者についてはユーザがapt-get updateを行ったときに接続するSurrogateと
apt-get dist-upgradeを行ったときに接続するSurrogateは同一であるとは限ら
ないため、DNSがSurrogateとして返すサーバが保持するファイルは同一である必
要がある。cdn.debian.or.jpではDebianプロジェクトで一般に行われている方法
と同様に、rsyncプロトコルを用い、pushミラーを行っている（図２）。そのた
め、cdn.debian.or.jpのサロゲート内で最上流にあるサーバとミラーが同一であ
ることを2分毎にrsyncミラー終了時に作成されるスタンプファイルを確認して、
同一でないサーバはサロゲート候補から一時的に除外している。

ただし，これはミラーの配送ツリーの管理を行う必要があるため，日本国内のミ
ラーに限定している．

\subsubsection{システムの安定動作}

先に述べたように、ユーザはCDNを使用する際にはDNSを最初に使用するため、
DNSの安定運用がカギとなる。そのため、cdn.debian.or.jpを管理するDNSサーバ
はまったく独立に動作するサーバで行っている。

また、サーバの動作を確認は、5秒以内にHTTPのレスポンスを返さないサーバは
サロゲート候補から一時的に除外している。

\subsubsection{高速動作}

cdn.debian.or.jpではDNSで問い合わせされるとサロゲートリストとして複数の
IPアドレスを返す。このIPアドレスはラウンドロビンで選択しているわけではな
く、サーバキャパシティやネットワーク速度を考慮し、設定している。

\subsection{使用実績}

以下3ヶ月分のplat.debian.or.jpで動作しているDNSへのアクセス実績を示す．

\begin{itemize}
 \item 2008年7月16日から10月15日までの三ヶ月間の利用実績を解析した．
 \item 本システムではDNSのAまたはAnyに対して返答を戻すことから，それ以外
       のクエリに関しては無効なアクセスとして処理している．
 \item 地域はアクセス元のIPアドレスをGeoIPライブラリから算出している．
 \item 全動作ホストは，plat.debian.or.jp, osdn2.debian.or.jp,
       debian.topstudio.co.jpである．
 \item ユニークホスト数 20554
\end{itemize}

\begin{table}[htbp]
\caption{DNSクエリ数上位国(横軸)-クエリ数(縦軸)}
\begin{tabular}{|l|r|l|}
\hline
地域 & \multicolumn{1}{l|}{アクセス数} &  \\ \hline
アジア & 570137 &  \\ \hline
アジア(日本と韓国除く) & \multicolumn{1}{l|}{} & \multicolumn{1}{r|}{55539} \\ \hline
日本 & \multicolumn{1}{l|}{} & \multicolumn{1}{r|}{509367} \\ \hline
韓国 & \multicolumn{1}{l|}{} & \multicolumn{1}{r|}{5231} \\ \hline
ヨーロッパ & 16804 &  \\ \hline
ヨーロッパ(フランス除く) & \multicolumn{1}{l|}{} & \multicolumn{1}{r|}{15154} \\ \hline
フランス & \multicolumn{1}{l|}{} & \multicolumn{1}{r|}{1650} \\ \hline
北米 & 142207 &  \\ \hline
オセアニア & 10766 &  \\ \hline
アフリカ & 160 &  \\ \hline
その他 & 404996 &  \\ \hline
総有効アクセス数 & 1145070 &  \\ \hline
\end{tabular}
\label{dnsquery}
\end{table}

\begin{table}[htbp]
\caption{日本での振り分け実績}
\begin{tabular}{|l|l|r|}
\hline
\textbf{ホスト名} & \textbf{IP} & \multicolumn{1}{l|}{\textbf{振り分け数}} \\ \hline
runner.oyu-net.jp. & 61.206.119.174 & 690596 \\ \hline
dwarf.topstudio.co.jp. & 202.229.186.27 & 660091 \\ \hline
hanzubin.st.wakwak.ne.jp & 61.115.118.67 & 649512 \\ \hline
studenno.kugi.kyoto-u.ac.jp. & 130.54.59.159 & 599550 \\ \hline
dennou-q.geo.kyushu-u.ac.jp & 133.5.166.3 & 468730 \\ \hline
frost.nemui.org. & 218.219.152.77 & 445589 \\ \hline
dennou-h.ep.sci.hokudai.ac.jp. & 133.87.45.30 & 379888 \\ \hline
ftp.nara.wide.ad.jp & 203.178.137.175 & 58825 \\ \hline
plat.debian.or.jp & 210.157.158.38 & 6095 \\ \hline
\end{tabular}
\label{dnsjapansymmetry}
\end{table}

\subsection{将来の展望}

ここまで説明してきた、cdn.debian.or.jpの動作には改善すべき点が多数存在す
る。改善の展望としていくつか挙げる。

\subsection{アクセス実績に基いたCDN配置}

アクセス実績によると，日本，米国，カナダ，韓国，中国，フィンランド，台湾，
インド，インドネシア，ホンコン，ロシアと続く．現状では，大陸毎に設定され
たミラーサーバは存在するものの，日本，韓国，アメリカを除けば各国毎に設定
されたミラーサーバは存在しない．

このアクセス実績にもとづいた配置設定を近い将来行いたい．

\subsubsection{apt-getコマンドのHTTP REDIRECT}

apt-getコマンドはHTTP REDIRECTに対応していない。

HTTP REDIRECTは、いったんHTTP GETなどで接続してきたクライアントに対して、
新たにそのリソースが存在するURLを通知するものである。この仕組みをうまく
つかったCDNとして、Coral Content DistributionNetwork (Coral CDN)がある。
Coral CDNはサロゲート間でP2Pによるファイル配置し、そのインターフェースと
して、HTTPを使用し、しかも使用にはインターネットから取得可能なファイルで
あれば制限をかけていない。さらに、Apacheを使った一時配布サーバではHTTP
REDIRECTをつかってCoral　CDNに誘導することも推奨されている。ただし、現状
で、Coral CDNを使うために、

\begin{commandline}
deb http://cdn.debian.or.jp.nyud.net:8090/debian/ stable main contrib non-free
\end{commandline}

を指定することも可能だが、少なくとも日本においてはCoral CDNを担うサロゲー
トが存在しないこともあって非常に低速である。ただし韓国や中国では広くつか
われており、将来の拡張に使用したい。

\subsubsection{aptのP2P対応}

現在、\url{http://wiki.debian.org/DebTorrent}
\url{http://www.cs.sfu.ca/~camerond/personal/GoogleSoCDebian.html}でaptの
Bittorrent対応が進められており、有力な候補である。ただし、Bittorrentプロ
トコルをクライアントで直接使うものであり、ネットワーク利用ポリシーとの競
合やinstall時に利用可能なのかなど今後検証すべき問題も多い。

\subsection{おわりに}

いつでも必要なソフトウェアやコンテンツを安価に入手する手段としてCDNはこ
れからも様々な発展を続けると考える。Debianはdebの安定入手手段の有無がシ
ステムの信頼性を左右するシステムであり、CDNの広範な活用が今後ますます求
められるようになると考える。

\dancersection{今後の予定}{山下 尊也}

\subsection{次回}
次回は、2008年11月7日8日に行われる
関西オープンフォーラム\footnote{\url{http://k-of.jp/}}にて開催する予定です。

\subsection{KDRのおしらせ}
関西Debian勉強会の有志で
関西Debian勉強会とは独立した形で、
週に一度、読書会(KDR)を開いています。
詳しくはKDR公開用ページ\footnote{\url{http://qwik.jp/kdrweb/}}
をご覧下さい。

\dancersection{メモ}{}
\mbox{}\newpage

\printindex
 \cleartooddpage

 \begin{minipage}[b]{0.2\hsize}
  \rotatebox{90}{\fontsize{80}{80} {\gt 関西デビアン勉強会} }
 \end{minipage}
 \begin{minipage}[b]{0.8\hsize}

 \vspace*{15cm}
 \rule{\hsize}{1mm}
 \vspace{2mm}
 \includegraphics[width=2cm]{image200502/openlogo-nd.eps}
 \noindent \Large \bf Debian 勉強会資料\\ \\
 \noindent \normalfont \debmtgyear{}年\debmtgmonth{}月\debmtgdate{}日 \hspace{5mm}  初版第1刷発行\\
 \noindent \normalfont 関西 Debian 勉強会 （編集・印刷・発行）\\
 \rule{\hsize}{1mm}
 \end{minipage}

\end{document}
